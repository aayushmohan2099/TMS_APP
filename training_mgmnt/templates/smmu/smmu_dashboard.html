{% load static %}
{% load custom_tags %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SMMU Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    .card-body { background: #fff; }
    .table-responsive.custom-scroll { overflow-x: auto; max-height: 60vh; }
    #s_beneficiariesTable thead th { position: sticky; top: 0; z-index: 7; background: #212529; color: white; font-weight:700; font-size:14px; padding:.6rem .75rem; }
    .col-header { font-weight: 700; font-size: .95rem; color: #fff; display:block; margin-bottom:.25rem;}
    .filter-btn { padding: .25rem .5rem; font-size: .85rem; }
    .dropdown-checkboxes { max-height: 260px; overflow:auto; padding: .25rem; }
    .dropdown-menu.moved-to-body { box-shadow: 0 6px 18px rgba(0,0,0,0.15); max-height:360px; overflow:auto; z-index:3000!important; }

    /* aspirational block highlight */
    .aspirational { font-weight: 700; color: #0b5394; background: rgba(11,83,148,0.06); padding: 2px 6px; border-radius: 4px; display:inline-block; }

    /* small helpers */
    .select-row { gap: 8px; display:flex; align-items:center; }
    .muted { color:#6c757d; font-size:.9rem; }

  /* Floating action button that spans text */
  .fab {
    position: fixed;
    right: 22px;
    bottom: 22px;
    z-index: 4000;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 20px;
    border-radius: 28px; /* pill-shaped */
    background: linear-gradient(135deg, #007bff, #0056d6);
    color: #fff;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
    cursor: pointer;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
  }

  .fab .fab-label {
    display: inline; /* Make sure label shows */
  }

    /* responsive layout */
    .dashboard-grid { display:grid; grid-template-columns:1fr; gap:16px; align-items:start; }
    .dashboard-grid.analytics-open { grid-template-columns:2fr 1fr; }
    .analytics-panel { background:#fbfdff; border:1px solid #e6f0ff; border-radius:6px; padding:12px; display:none; min-height:60vh; }
    .analytics-panel.visible { display:block; }
    table.s-table-compressed td, table.s-table-compressed th { padding:.35rem .5rem; font-size:.88rem; }
    @media (max-width:768px) { .dashboard-grid.analytics-open { grid-template-columns:1fr; } }
  </style>
  <!-- include Bootstrap CSS and JS in your base; this template assumes Bootstrap 5 -->
</head>
<body>

<div class="container-fluid">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">SMMU Dashboard</h3>
    <div>
      <button id="s_toggleAnalyticsTop" class="btn btn-sm btn-outline-primary" aria-expanded="false" aria-controls="s_analyticsPanel">Show analytics</button>
    </div>
  </div>

  <div id="sDashboardGrid" class="dashboard-grid">

    <!-- Left column -->
    <div>
      <h4 class="mb-3">Beneficiaries</h4>

      <!-- Step selectors (hidden table until district selected) -->
      <div class="mb-3">
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label small">Mandal</label>
            <select id="selMandal" class="form-select form-select-sm">
              <option value="">Select Mandal</option>
              {% for m in mandals %}
                <option value="{{ m.id }}" {% if selected_mandal and selected_mandal|stringformat:"s" == m.id|stringformat:"s" %}selected{% endif %}>{{ m.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small">District Category</label>
            <select id="selCategory" class="form-select form-select-sm">
              <option value="">Select Category</option>
              {% for c in district_categories %}
                <option value="{{ c }}" {% if selected_category == c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small">District</label>
            <select id="selDistrict" class="form-select form-select-sm">
              <option value="">Select District</option>
              {% for d in districts %}
                <option value="{{ d.district_id }}" {% if selected_district and selected_district|stringformat:"s" == d.district_id|stringformat:"s" %}selected{% endif %}>{{ d.district_name_en }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="mt-2 d-flex gap-2 align-items-center">
          <input id="s_globalSearch" class="form-control form-control-sm" placeholder="Search block / SHG / Gram Panchayat / Village" style="max-width:420px;" value="{{ search_query }}">
          <button id="s_searchBtn" class="btn btn-sm btn-outline-secondary">Search</button>
          <div class="ms-auto muted" id="asp_note" style="display:none;">Aspirational blocks are highlighted.</div>
        </div>
      </div>

      <!-- Table (hidden until district selected) -->
      <div id="s_table_wrapper" class="table-responsive custom-scroll mt-3" {% if not show_table %}style="display:none;"{% endif %}>
        <table class="table table-bordered table-hover table-sm" id="s_beneficiariesTable" style="min-width:1200px;">
          <thead class="table-dark">
            <tr>
              <th style="width:60px;"><div class="form-check"><input class="form-check-input" type="checkbox" id="s_selectAllRows"></div></th>
              <th data-field="block" style="min-width:160px;"><span class="col-header">Block</span></th>
              <th data-field="gram_panchayat" style="min-width:160px;"><span class="col-header">Gram Panchayat</span></th>
              <th data-field="village" style="min-width:160px;"><span class="col-header">Village</span></th>
              <th data-field="shg_name" style="min-width:200px;"><span class="col-header">SHG Name</span></th>
              <th data-field="member_name" style="min-width:200px;"><span class="col-header">Member Name</span></th>
              <th data-field="social_category" style="min-width:140px;"><span class="col-header">Social Category</span></th>
              <th data-field="designation_in_shg_vo_clf" style="min-width:140px;"><span class="col-header">Designation</span></th>
              <th data-field="gender" style="min-width:100px;"><span class="col-header">Gender</span></th>
            </tr>

            <!-- Filters row -->
            <tr>
              <th></th>

              <!-- Block filter: use groupable_values.block -->
              <th>
                {% if groupable_values.block %}
                <div class="dropdown w-100">
                  <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" id="dd_block" data-bs-toggle="dropdown" aria-expanded="false" data-field="block">Filter</button>
                  <div class="dropdown-menu p-2" style="min-width:220px;">
                    <div class="dropdown-checkboxes" id="block-checkboxes">
                      {% for b in groupable_values.block %}
                        {% if b %}
                          {% if b in aspirational_blocks %}
                            <div class="form-check">
                              <input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="block" value="{{ b }}" id="blk_{{ forloop.counter }}">
                              <label class="form-check-label aspirational" for="blk_{{ forloop.counter }}">{{ b }}</label>
                            </div>
                          {% else %}
                            <div class="form-check">
                              <input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="block" value="{{ b }}" id="blk_{{ forloop.counter }}">
                              <label class="form-check-label" for="blk_{{ forloop.counter }}">{{ b }}</label>
                            </div>
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                      <button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="block">Clear</button>
                      <button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="block">Apply</button>
                    </div>
                  </div>
                </div>
                {% else %}
                  <div class="text-muted small">â€”</div>
                {% endif %}
              </th>

              <!-- Gram Panchayat -->
              <th>
                {% if groupable_values.gram_panchayat %}
                <div class="dropdown w-100">
                  <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" data-field="gram_panchayat" id="dd_gp" data-bs-toggle="dropdown">Filter</button>
                  <div class="dropdown-menu p-2" style="min-width:220px;">
                    <div class="dropdown-checkboxes">
                      {% for v in groupable_values.gram_panchayat %}
                        {% if v %}
                          <div class="form-check"><input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="gram_panchayat" value="{{ v }}" id="gp_{{ forloop.counter }}"><label class="form-check-label" for="gp_{{ forloop.counter }}">{{ v }}</label></div>
                        {% endif %}
                      {% endfor %}
                    </div>
                    <div class="d-flex justify-content-between mt-2"><button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="gram_panchayat">Clear</button><button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="gram_panchayat">Apply</button></div>
                  </div>
                </div>
                {% else %}<div class="text-muted small">â€”</div>{% endif %}
              </th>

              <!-- Village -->
              <th>
                {% if groupable_values.village %}
                <div class="dropdown w-100">
                  <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" data-field="village" id="dd_village" data-bs-toggle="dropdown">Filter</button>
                  <div class="dropdown-menu p-2" style="min-width:220px;">
                    <div class="dropdown-checkboxes">
                      {% for v in groupable_values.village %}
                        {% if v %}<div class="form-check"><input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="village" value="{{ v }}" id="vil_{{ forloop.counter }}"><label class="form-check-label" for="vil_{{ forloop.counter }}">{{ v }}</label></div>{% endif %}
                      {% endfor %}
                    </div>
                    <div class="d-flex justify-content-between mt-2"><button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="village">Clear</button><button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="village">Apply</button></div>
                  </div>
                </div>
                {% else %}<div class="text-muted small">â€”</div>{% endif %}
              </th>

              <!-- SHG Name -->
              <th>
                {% if groupable_values.shg_name %}
                <div class="dropdown w-100">
                  <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" data-field="shg_name" id="dd_shg" data-bs-toggle="dropdown">Filter</button>
                  <div class="dropdown-menu p-2" style="min-width:220px;">
                    <div class="dropdown-checkboxes">
                      {% for v in groupable_values.shg_name %}
                        {% if v %}<div class="form-check"><input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="shg_name" value="{{ v }}" id="shg_{{ forloop.counter }}"><label class="form-check-label" for="shg_{{ forloop.counter }}">{{ v }}</label></div>{% endif %}
                      {% endfor %}
                    </div>
                    <div class="d-flex justify-content-between mt-2"><button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="shg_name">Clear</button><button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="shg_name">Apply</button></div>
                  </div>
                </div>
                {% else %}<div class="text-muted small">â€”</div>{% endif %}
              </th>

              <!-- Member name: no filter -->
              <th><div class="text-muted small">â€”</div></th>

              <!-- Social Category -->
              <th>
                {% if groupable_values.social_category %}
                <div class="dropdown w-100">
                  <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" data-field="social_category" id="dd_social" data-bs-toggle="dropdown">Filter</button>
                  <div class="dropdown-menu p-2" style="min-width:220px;">
                    <div class="dropdown-checkboxes">
                      {% for v in groupable_values.social_category %}
                        {% if v %}<div class="form-check"><input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="social_category" value="{{ v }}" id="soc_{{ forloop.counter }}"><label class="form-check-label" for="soc_{{ forloop.counter }}">{{ v }}</label></div>{% endif %}
                      {% endfor %}
                    </div>
                    <div class="d-flex justify-content-between mt-2"><button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="social_category">Clear</button><button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="social_category">Apply</button></div>
                  </div>
                </div>
                {% else %}<div class="text-muted small">â€”</div>{% endif %}
              </th>

              <!-- Designation -->
              <th>
                {% if groupable_values.designation_in_shg_vo_clf %}
                <div class="dropdown w-100">
                  <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" data-field="designation_in_shg_vo_clf" id="dd_desig" data-bs-toggle="dropdown">Filter</button>
                  <div class="dropdown-menu p-2" style="min-width:220px;">
                    <div class="dropdown-checkboxes">
                      {% for v in groupable_values.designation_in_shg_vo_clf %}
                        {% if v %}<div class="form-check"><input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="designation_in_shg_vo_clf" value="{{ v }}" id="des_{{ forloop.counter }}"><label class="form-check-label" for="des_{{ forloop.counter }}">{{ v }}</label></div>{% endif %}
                      {% endfor %}
                    </div>
                    <div class="d-flex justify-content-between mt-2"><button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="designation_in_shg_vo_clf">Clear</button><button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="designation_in_shg_vo_clf">Apply</button></div>
                  </div>
                </div>
                {% else %}<div class="text-muted small">â€”</div>{% endif %}
              </th>

              <!-- Gender -->
              <th>
                {% if groupable_values.gender %}
                <div class="dropdown w-100">
                  <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" data-field="gender" id="dd_gender" data-bs-toggle="dropdown">Filter</button>
                  <div class="dropdown-menu p-2" style="min-width:220px;">
                    <div class="dropdown-checkboxes">
                      {% for v in groupable_values.gender %}
                        {% if v %}<div class="form-check"><input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="gender" value="{{ v }}" id="gen_{{ forloop.counter }}"><label class="form-check-label" for="gen_{{ forloop.counter }}">{{ v }}</label></div>{% endif %}
                      {% endfor %}
                    </div>
                    <div class="d-flex justify-content-between mt-2"><button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="gender">Clear</button><button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="gender">Apply</button></div>
                  </div>
                </div>
                {% else %}<div class="text-muted small">â€”</div>{% endif %}
              </th>

            </tr>
          </thead>

          <tbody>
            {% for obj in page_obj %}
              <tr class="clickable-row" data-id="{{ obj.id }}" title="Click to view details">
                <td><div class="form-check"><input class="form-check-input s_row_select_checkbox" type="checkbox" data-id="{{ obj.id }}"></div></td>
                <td>{{ obj.block.block_name_en|default_if_none:"" }}</td>
                <td>{{ obj.gram_panchayat|default_if_none:"" }}</td>
                <td>{{ obj.village|default_if_none:"" }}</td>
                <td>{{ obj.shg_name|default_if_none:"" }}</td>
                <td>{{ obj.member_name|default_if_none:"" }}</td>
                <td>{{ obj.social_category|default_if_none:"" }}</td>
                <td>{{ obj.designation_in_shg_vo_clf|default_if_none:"" }}</td>
                <td>{{ obj.gender|default_if_none:"" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="9" class="text-center">No beneficiaries found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {% if show_table %}
      <nav aria-label="Page navigation" class="mt-2">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?district_id={{ selected_district }}&page={{ page_obj.previous_page_number }}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if order %}&order={{ order }}{% endif %}">Previous</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}

          {% for num in paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-5' and num < page_obj.number|add:'5' %}
              <li class="page-item"><a class="page-link" href="?district_id={{ selected_district }}&page={{ num }}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?district_id={{ selected_district }}&page={{ page_obj.next_page_number }}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if order %}&order={{ order }}{% endif %}">Next</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

    </div> <!-- left column -->

    <!-- Right: analytics panel -->
    <aside id="s_analyticsPanel" class="analytics-panel" role="complementary" aria-hidden="true">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Analytics</strong>
        <button id="s_hideAnalyticsBtn" class="btn btn-sm btn-outline-secondary">Hide</button>
      </div>
      <p class="text-muted small">SMMU quick stats</p>
      <div style="height:280px;"><canvas id="s_chart1"></canvas></div>
      <div style="height:280px; margin-top:12px;"><canvas id="s_chart2"></canvas></div>
    </aside>

  </div> <!-- dashboard-grid -->

</div> <!-- container -->

<!-- beneficiary detail modal -->
<div class="modal fade" id="beneficiaryDetailModal" tabindex="-1" aria-labelledby="benefDetailLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="benefDetailLabel">Beneficiary details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="benefDetailBody">Loading...</div>
    </div>
  </div>
</div>

<!-- floating Training Requests button -->
<a href="{% url 'smmu_training_requests' %}" class="fab" title="Training requests">
  <span class="fab-label">Pending Training Requests</span>
</a>

<div class="col-md-4">
  <a href="{% url 'smmu_create_partner_target' %}" class="btn btn-outline-success w-100 mb-3">
    <i class="bi bi-people"></i> Training Partner Assignment
  </a>
</div>

<!-- Chart.js (kept) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ---------- Helpers ---------- */
function qsToString(params) {
  // helper to build query string preserving mandal/category/district
  return params.toString();
}
function buildBaseParams() {
  const params = new URLSearchParams(window.location.search || "");
  // preserve selected mandal/category/district when applying search/filters
  const sM = document.getElementById("selMandal")?.value;
  const sC = document.getElementById("selCategory")?.value;
  const sD = document.getElementById("selDistrict")?.value;
  if (sM) params.set("mandal_id", sM); else params.delete("mandal_id");
  if (sC) params.set("category_id", sC); else params.delete("category_id");
  if (sD) params.set("district_id", sD); else params.delete("district_id");
  return params;
}

/* ---------- Chart initialization ---------- */
let _s_chart1 = null, _s_chart2 = null;
function initSCharts() {
  try {
    if (_s_chart1 && _s_chart1.destroy) { try{ _s_chart1.destroy(); }catch(e){} }
    if (_s_chart2 && _s_chart2.destroy) { try{ _s_chart2.destroy(); }catch(e){} }
    const labels = {{ chart_labels|safe }};
    const data1 = {{ chart1|safe }};
    const data2 = {{ chart2|safe }};
    const c1 = document.getElementById('s_chart1');
    if (c1) {
      _s_chart1 = new Chart(c1.getContext('2d'), { type:'bar', data:{ labels: labels, datasets:[{ label:'Metric 1', data: data1 }] }, options:{ responsive:true, maintainAspectRatio:false }});
    }
    const c2 = document.getElementById('s_chart2');
    if (c2) {
      _s_chart2 = new Chart(c2.getContext('2d'), { type:'line', data:{ labels: labels, datasets:[{ label:'Metric 2', data: data2, fill:false }] }, options:{ responsive:true, maintainAspectRatio:false }});
    }
  } catch(e) { console.warn('initSCharts error', e); }
}

/* ---------- UI wiring ---------- */
document.addEventListener('DOMContentLoaded', function(){
  // selectors change behavior: when Mandal changes, reload page so District list updates server-side
  document.getElementById('selMandal')?.addEventListener('change', function(){
    const params = new URLSearchParams(window.location.search || '');
    if (this.value) params.set('mandal_id', this.value); else params.delete('mandal_id');
    // clear downstream selections
    params.delete('district_id');
    params.delete('category_id');
    params.delete('page');
    window.location.search = params.toString();
  });

  // selecting category simply updates URL (server can use it)
  document.getElementById('selCategory')?.addEventListener('change', function(){
    const params = buildBaseParams();
    if (this.value) params.set('category_id', this.value); else params.delete('category_id');
    params.delete('page');
    window.location.search = params.toString();
  });

  // selecting district triggers table display (server renders table)
  document.getElementById('selDistrict')?.addEventListener('change', function(){
    const params = buildBaseParams();
    if (this.value) params.set('district_id', this.value); else params.delete('district_id');
    params.delete('page');
    window.location.search = params.toString();
  });

  // Search
  document.getElementById('s_searchBtn')?.addEventListener('click', function(){
    const val = document.getElementById('s_globalSearch')?.value?.trim() || '';
    const params = buildBaseParams();
    if (val) params.set('search', val); else params.delete('search');
    params.delete('page');
    window.location.search = params.toString();
  });

  // header sorting: clickable headers toggle simple asc sort
  document.querySelectorAll('#s_beneficiariesTable thead th[data-field]').forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', function(e){
      if (e.target.closest('.dropdown') || e.target.closest('.dropdown-menu') || e.target.classList.contains('main-col-filter-checkbox')) return;
      const field = th.dataset.field;
      const params = buildBaseParams();
      const curSort = "{{ sort_by|default:'' }}";
      const curOrder = "{{ order|default:'asc' }}";
      let newOrder = 'asc';
      if (curSort === field && curOrder === 'asc') newOrder = 'desc';
      params.set('sort_by', field);
      params.set('order', newOrder);
      params.set('page', 1);
      window.location.search = params.toString();
    });
  });

  // dropdown apply / clear
  document.querySelectorAll('.main-dd-apply').forEach(btn => {
    btn.addEventListener('click', function(){
      const field = this.dataset.field;
      const checked = Array.from(document.querySelectorAll(`.main-col-filter-checkbox[data-field="${field}"]:checked`)).map(x=>x.value);
      const params = buildBaseParams();
      params.delete('page');
      params.delete('filter_' + field);
      if (checked.length) params.set('filter_' + field, checked.join(','));
      window.location.search = params.toString();
    });
  });
  document.querySelectorAll('.main-dd-clear').forEach(btn => {
    btn.addEventListener('click', function(){
      const field = this.dataset.field;
      document.querySelectorAll(`.main-col-filter-checkbox[data-field="${field}"]`).forEach(cb => cb.checked = false);
      const params = buildBaseParams();
      params.delete('filter_' + field);
      params.delete('page');
      window.location.search = params.toString();
    });
  });

  // select all checkbox
  document.getElementById('s_selectAllRows')?.addEventListener('change', function(){
    const checked = !!this.checked;
    document.querySelectorAll('.s_row_select_checkbox').forEach(cb => cb.checked = checked);
  });

  // clickable rows: fetch beneficiary detail HTML and show in modal
  document.querySelectorAll('.clickable-row').forEach(row => {
    row.style.cursor = 'pointer';
    row.addEventListener('click', function(e){
      // if user clicked the checkbox inside row, ignore
      if (e.target && (e.target.tagName === 'INPUT' || e.target.closest('input'))) return;
      const id = this.dataset.id;
      if (!id) return;
      const url = "{% url 'bmmu_beneficiary_detail' 0 %}".replace('/0/', '/' + id + '/');
      const modal = new bootstrap.Modal(document.getElementById('beneficiaryDetailModal'));
      const body = document.getElementById('benefDetailBody');
      body.innerHTML = 'Loading...';
      modal.show();
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
        .then(resp => {
          if (!resp.ok) throw new Error('Failed to load detail');
          return resp.text();
        })
        .then(html => { body.innerHTML = html; })
        .catch(err => { body.innerHTML = '<div class="alert alert-danger">Failed to load details.</div>'; console.error(err); });
    });
  });

  // show aspirational note if present
  const aspir = {{ aspirational_blocks|length|default:0 }};
  if (aspir && aspir > 0) {
    document.getElementById('asp_note').style.display = 'block';
  }

  // initialize charts
  try { initSCharts(); } catch(e) {}
});
</script>

</body>
</html>
