{% load static %}
{% load custom_tags %}

{% block content %}
<!doctype html>
<!-- Adapted layout to match SMMU Dashboard style (header, left nav) and improved readability -->
<div class="smmu-shell" style="font-family: 'Arial', sans-serif; font-size:16px; min-height:80vh;">

  <!-- top bar (pale yellow) -->
  <header style="background:#f7eecf; padding:10px 18px; border-bottom:1px solid rgba(0,0,0,0.05);">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <div style="font-weight:700; color:#0b2540; font-size:1.05rem;">Training Partner Assignment</div>
      <div style="display:flex; gap:18px; align-items:center;">
        <div style="color:#5c3a6b; font-weight:600;">SMM_FARMLH (SMMU)</div>
        <a href="#" style="color:#0b2540; text-decoration:none;">Logout</a>
      </div>
    </div>
  </header>

  <div style="display:flex;">
    <!-- main area -->
    <main style="flex:1; padding:24px; background:linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.9)), url('{% static "images/bg-blur.jpg" %}') center/cover no-repeat;">

      <!-- assignment panel: two-column card like before but visually aligned with dashboard -->
      <section style="margin-top:8px;">
        <div style="display:grid; grid-template-columns:1fr 360px; gap:20px; align-items:start;">

          <!-- left card -->
          <div style="background:#fff; border-radius:8px; padding:18px; box-shadow:0 6px 18px rgba(10,20,40,0.03);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
              <div>
                <h4 style="margin:0; font-size:1.2rem;">Available Training Plans</h4>
                <div style="color:#6c757d; font-size:0.95rem;">Showing plans where you are theme expert</div>
              </div>
              <div style="display:flex; gap:10px; align-items:center;">
                <div class="form-check" style="margin:0;">
                  <input class="form-check-input" type="checkbox" id="selectAllPlans">
                </div>
                <label for="selectAllPlans" style="color:#6c757d;">Select all</label>
              </div>
            </div>

            <div style="margin-bottom:12px; display:flex; gap:12px;">
              <input id="tp_search" class="form-control" placeholder="Filter plans by name" style="flex:1; padding:10px;" />
            </div>

            <div id="planList" style="max-height:62vh; overflow:auto; border-radius:6px; background:#fbfdff; padding:6px;">
              {% if plans_with_meta %}
                {% for plan in plans_with_meta %}
                  {% with p=plan.obj assign=plan.assign %}
                  <div class="plan-item" data-plan-id="{{ p.id }}" style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #f3f6fb; cursor:pointer;">
                    <div style="display:flex; gap:12px; align-items:center; min-width:0;">
                      <div class="form-check" style="margin:0;">
                        <input class="form-check-input plan-checkbox" type="checkbox" name="training_plan_ids" value="{{ p.id }}" id="plan_{{ p.id }}">
                      </div>
                      <div style="min-width:0;">
                        <div style="font-weight:700; font-size:1.03rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:600px;" title="{{ p.training_name }}">{{ p.training_name }}</div>
                        <div style="font-size:0.95rem; color:#6c757d;">{{ p.theme|default_if_none:"" }}</div>
                      </div>
                    </div>

                    <div style="text-align:right; min-width:160px;">
                      {% if assign %}
                        <div style="display:inline-block; padding:6px 10px; border-radius:14px; background:rgba(47,168,79,0.06); color:#2fa84f; font-weight:600;">Assigned to {{ assign.partner_name }}</div>
                        {% if assign.assigned_on %}
                          <div style="margin-top:6px; color:#6c757d;">on {{ assign.assigned_on|date:"Y-m-d" }}</div>
                        {% endif %}
                      {% else %}
                        <div style="color:#6c757d;">Not assigned</div>
                      {% endif %}
                    </div>

                  </div>
                  {% endwith %}
                {% endfor %}
              {% else %}
                <div class="text-center" style="padding:40px; color:#6c757d;">No training plans found.</div>
              {% endif %}
            </div>
          </div>

          <!-- right sidebar -->
          <aside style="background:#fff; border-radius:8px; padding:18px; min-height:200px;">
            <form id="assignForm">
              {% csrf_token %}

              <div style="margin-bottom:12px;">
                <label class="form-label" style="font-weight:600;">Training Partner</label>
                <select id="partnerSelect" name="partner_id" class="form-select" style="width:100%; padding:10px; font-size:1rem;">
                  <option value="">-- Select partner --</option>
                  {% for tp in partners %}
                    <option value="{{ tp.id }}">{{ tp.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Target input (type-only) -->
              <div style="margin-bottom:12px;">
                <label class="form-label" style="font-weight:600;">Target (number of batches)</label>
                <input type="number" id="partnerTarget" class="form-control" placeholder="Enter target batches (type-only)" style="width:100%; padding:10px; font-size:1rem;" />
                <div style="color:#6c757d; margin-top:6px;">This is for planning only and isn't linked to backend.</div>
              </div>

              <div style="margin-bottom:12px;">
                <label class="form-label" style="font-weight:600;">Quick info</label>
                <div style="color:#6c757d;">Pick one or more training plans from the list and click <strong>Assign</strong>. If a plan is already assigned to another partner you'll be prompted to confirm.</div>
              </div>

              <div style="display:flex; gap:10px;">
                <button type="button" id="assignBtn" class="btn" style="flex:1; background:linear-gradient(135deg,#007bff,#0056d6); color:#fff; border-radius:8px; padding:10px 12px;">Assign selected plans</button>
                <button type="reset" id="resetBtn" class="btn" style="flex:1; border:1px solid #cfcfcf; background:#fff;">Reset selection</button>
              </div>

              <div id="assignmentMessage" style="margin-top:12px; color:#6c757d;"></div>
            </form>

            <div style="margin-top:16px;">
              <h6 style="margin:0 0 6px 0;">Recent activity</h6>
              <div style="color:#6c757d;">Last assignments and updates will appear here after action.</div>
              <ul id="recentActivity" style="list-style:none; padding-left:0; margin-top:8px;"></ul>
            </div>
          </aside>

        </div>
      </section>
    </main>
  </div>

  <!-- floating pending link placed bottom-right similar to screenshot -->
  <a href="{% url 'smmu_dashboard' %}" class="fab" title="Back to dashboard" style="position:fixed; right:18px; bottom:18px; padding:10px 14px; border-radius:24px; background:linear-gradient(135deg,#007bff,#0056d6); color:#fff; text-decoration:none;">Back to Dashboard</a>

</div>

<script>
/* All original behaviour preserved (search, select-all, assign flow) */
function getCookie(name) {
  // use double-escaped backslashes so regex \s is preserved
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
function getSelectedPlanIds() { return Array.from(document.querySelectorAll('.plan-checkbox:checked')).map(i => i.value); }

document.addEventListener('DOMContentLoaded', function(){
  const searchInput = document.getElementById('tp_search');
  searchInput?.addEventListener('input', function(){
    const q = this.value.trim().toLowerCase();
    document.querySelectorAll('#planList .plan-item').forEach(item => {
      // try to read title attribute or fallback to text
      const titleAttr = item.querySelector('[title]')?.getAttribute('title');
      const title = (titleAttr ? titleAttr.toLowerCase() : (item.querySelector('.plan-title')?.textContent?.toLowerCase() || ''));
      if (!q || title.indexOf(q) !== -1) item.style.display = 'flex'; else item.style.display = 'none';
    });
  });

  document.getElementById('selectAllPlans')?.addEventListener('change', function(){
    const checked = !!this.checked;
    document.querySelectorAll('.plan-checkbox').forEach(cb => cb.checked = checked);
  });

  document.querySelectorAll('#planList .plan-item').forEach(it => {
    it.addEventListener('click', function(e){
      if (e.target && (e.target.tagName === 'INPUT' || e.target.closest('input'))) return;
      const cb = this.querySelector('.plan-checkbox'); if (cb) cb.checked = !cb.checked;
    });
  });

  const assignBtn = document.getElementById('assignBtn');
  const messageEl = document.getElementById('assignmentMessage');
  const recentEl = document.getElementById('recentActivity');

  async function postAssign(force=false) {
    const partnerId = document.getElementById('partnerSelect').value;
    const planIds = getSelectedPlanIds();
    const fd = new FormData();
    fd.append('partner_id', partnerId);
    planIds.forEach(id => fd.append('training_plan_ids', id));
    if (force) fd.append('force', '1');

    const resp = await fetch("{% url 'smmu_training_partner_assignment' %}", {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') },
      body: fd
    });
    return resp.json();
  }

  assignBtn?.addEventListener('click', async function(){
    messageEl.innerHTML = '';
    const partnerId = document.getElementById('partnerSelect').value;
    if (!partnerId) { messageEl.innerHTML = '<span style="color:#d9534f;">Select a partner</span>'; return; }
    const planIds = getSelectedPlanIds();
    if (!planIds.length) { messageEl.innerHTML = '<span style="color:#d9534f;">Select at least one training plan</span>'; return; }

    try {
      const r = await postAssign(false);
      if (r && r.conflict) {
        // use template literal for multi-line confirm text
        let txt = `The following plans are assigned to other partners:\n\n`;
        r.conflicts.forEach(c => txt += `• ${c.training_name} — ${c.conflicting_partner_name}\n`);
        txt += `\nProceed? This will remove the previous assignments.`;
        if (confirm(txt)) {
          const r2 = await postAssign(true);
          if (r2 && r2.success) {
            messageEl.innerHTML = '<span style="color:#28a745;">' + (r2.message || 'Assigned successfully.') + '</span>';
            (r2.created || []).forEach(n => { const li = document.createElement('li'); li.textContent = `Created: ${n}`; recentEl.prepend(li); });
            (r2.reassigned || []).forEach(n => { const li = document.createElement('li'); li.textContent = `Reassigned: ${n}`; recentEl.prepend(li); });
            setTimeout(()=> location.reload(), 900);
          } else { messageEl.innerHTML = '<span style="color:#d9534f;">' + (r2?.error || 'Failed to assign') + '</span>'; }
        } else { messageEl.innerHTML = '<span style="color:#6c757d;">Assignment cancelled.</span>'; }
        return;
      }

      if (r && r.success) {
        messageEl.innerHTML = '<span style="color:#28a745;">' + (r.message || 'Assigned successfully.') + '</span>';
        (r.created || []).forEach(n => { const li = document.createElement('li'); li.textContent = `Created: ${n}`; recentEl.prepend(li); });
        (r.reassigned || []).forEach(n => { const li = document.createElement('li'); li.textContent = `Reassigned: ${n}`; recentEl.prepend(li); });
        setTimeout(()=> location.reload(), 900);
        return;
      }

      messageEl.innerHTML = '<span style="color:#d9534f;">' + (r?.error || 'Assignment failed') + '</span>';
    } catch (e) {
      messageEl.innerHTML = '<span style="color:#d9534f;">Error: ' + (e.message || e) + '</span>';
    }
  });

  document.getElementById('resetBtn')?.addEventListener('click', function(e){
    // let default reset run first (it will clear form fields)
    // but ensure checkboxes & select-all are cleared as well
    setTimeout(() => {
      document.querySelectorAll('.plan-checkbox').forEach(cb => cb.checked = false);
      const selAll = document.getElementById('selectAllPlans');
      if (selAll) selAll.checked = false;
      if (messageEl) messageEl.innerHTML = '';
      const t = document.getElementById('partnerTarget');
      if (t) t.value = '';
    }, 0);
  });

});
</script>


{% endblock %}
