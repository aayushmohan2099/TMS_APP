{% load static %}
{% load custom_tags %}

{% block content %}
<!doctype html>
<div class="container-fluid py-3">

<div class="d-flex justify-content-center align-items-center mb-3">
  <div class="text-center flex-grow-1">
    <h3 class="mb-0" style="font-family: 'Arial', sans-serif; font-size: 2rem; color: #333;">Training Partner Assignment</h3>
    <div class="muted small" style="font-family: 'Arial', sans-serif; color: #6c757d;">Assign training plans to training partners</div>
  </div>
  
  <!-- Right-aligned button -->
  <div class="position-relative w-100">
    <a href="{% url 'smmu_dashboard' %}" class="btn btn-lg btn-primary" style="
      position: absolute; 
      right: 20px; 
      top: 10px; 
      background: linear-gradient(135deg, #d6ff6eff, #efff3bff); 
      border-radius: 50px; 
      padding: 12px 24px; 
      color: black; 
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
      font-size: 1.1rem;
      transition: all 0.3s ease-in-out;
    ">
      Back to Dashboard
    </a>
  </div>
</div>



  <style>
    /* Color + theme tuned to your dashboard */
    :root{
      --accent-blue: #0b5394;
      --accent-blue-weak: rgba(11,83,148,0.06);
      --card-bg: #fff;
      --panel-border: #e6f0ff;
      --muted: #6c757d;
      --dark-head: #212529;
    }

    .tp-card {
      background: var(--card-bg);
      border: 1px solid var(--panel-border);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(10, 20, 40, 0.03);
    }

    .tp-grid { display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start; }
    @media (max-width:900px){ .tp-grid { grid-template-columns: 1fr; } }

    .tp-steps { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .aspirational { font-weight:700; color:var(--accent-blue); background: var(--accent-blue-weak); padding:4px 8px; border-radius:6px; display:inline-block; }

    /* left panel list */
    .plan-list { max-height:62vh; overflow:auto; border-radius:6px; border:1px solid #f0f4ff; background:#fbfdff; padding:8px; }
    .plan-item { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #f3f6fb; }
    .plan-item:last-child { border-bottom: none; }
    .plan-left { display:flex; gap:12px; align-items:center; min-width:0; }
    .plan-meta { font-size:13px; color:var(--muted); }
    .plan-title { font-weight:700; font-size:0.98rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:520px; }

    .assigned-badge {
      font-size:0.78rem; padding:6px 8px; border-radius:14px; display:inline-block;
      background: rgba(0,123,255,0.06); color:#065; /* subtle */
    }
    .not-assigned { color:var(--muted); font-size:0.9rem; }

    /* right panel */
    .tp-sidebar { background:#fff; border:1px solid #eef6ff; border-radius:8px; padding:14px; min-height:120px; }
    .form-label.small { font-size:0.86rem; font-weight:600; color:var(--dark-head); }

    /* buttons */
    .btn-assign {
      background: linear-gradient(135deg, #007bff, #0056d6);
      color:#fff;
      border-radius:8px;
      padding:10px 16px;
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
      border:0;
    }
    .btn-assign:active { transform: translateY(1px); }

    /* floating action button */
    .fab {
      position: fixed;
      right: 22px;
      bottom: 22px;
      z-index: 4000;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 20px;
      border-radius: 28px;
      background: linear-gradient(135deg, #007bff, #0056d6);
      color: #fff;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
    }

    .muted { color: var(--muted); font-size: 0.95rem; }

    /* small helpers */
    .small-muted { font-size:0.86rem; color:var(--muted); }
  </style>

  <div class="tp-grid">

    <!-- LEFT: plans list -->
    <div class="tp-card">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
          <h5 class="mb-0">Available Training Plans</h5>
          <div class="small-muted">Showing plans where you are theme expert</div>
        </div>
        <div class="small-muted text-end">
          <div class="aspirational">SMMU</div>
        </div>
      </div>

      <div class="tp-steps">
        <div class="select-row">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="selectAllPlans">
          </div>
          <div class="small-muted">Select all</div>
        </div>

        <div class="ms-auto">
          <input id="tp_search" class="form-control form-control-sm" placeholder="Filter plans by name" style="min-width:240px;">
        </div>
      </div>

      <div class="plan-list" id="planList">
        {% if plans_with_meta %}
          {% for plan in plans_with_meta %}
            {% with p=plan.obj assign=plan.assign %}
            <div class="plan-item" data-plan-id="{{ p.id }}">
              <div class="plan-left">
                <div class="form-check">
                  <input class="form-check-input plan-checkbox" type="checkbox" name="training_plan_ids" value="{{ p.id }}" id="plan_{{ p.id }}">
                </div>
                <div style="min-width:0;">
                  <div class="plan-title" title="{{ p.training_name }}">{{ p.training_name }}</div>
                  <div class="plan-meta">{{ p.theme|default_if_none:"" }}</div>
                </div>
              </div>

              <div class="text-end">
                {% if assign %}
                  <div class="assigned-badge">Assigned to {{ assign.partner_name }}</div>
                  {% if assign.assigned_on %}
                    <div class="small-muted" style="margin-top:4px;">on {{ assign.assigned_on|date:"Y-m-d" }}</div>
                  {% endif %}
                {% else %}
                  <div class="not-assigned">Not assigned</div>
                {% endif %}
              </div>
            </div>
            {% endwith %}
          {% endfor %}
        {% else %}
          <div class="text-center muted py-4">No training plans found.</div>
        {% endif %}
      </div>
    </div>

    <!-- RIGHT: controls -->
    <aside class="tp-sidebar">
      <form id="assignForm">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label small">Training Partner</label>
          <select id="partnerSelect" name="partner_id" class="form-select form-select-sm">
            <option value="">-- Select partner --</option>
            {% for tp in partners %}
              <option value="{{ tp.id }}">{{ tp.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label small">Quick info</label>
          <div class="small-muted">Pick one or more training plans from the list and click <strong>Assign</strong>. If a plan is already assigned to another partner you'll be prompted to confirm — continuing will remove the previous assignment.</div>
        </div>

        <div class="d-grid gap-2">
          <button type="button" id="assignBtn" class="btn btn-assign">Assign selected plans</button>
          <button type="reset" id="resetBtn" class="btn btn-outline-secondary">Reset selection</button>
        </div>

        <div class="mt-3 small-muted" id="assignmentMessage"></div>
      </form>

      <!-- activity / recent results -->
      <div class="mt-3">
        <h6 class="mb-1">Recent activity</h6>
        <div class="small-muted">Last assignments and updates will appear here after action.</div>
        <ul id="recentActivity" class="mt-2" style="list-style:none; padding-left:0;"></ul>
      </div>
    </aside>

  </div> <!-- tp-grid -->

  <!-- floating shortcut -->
  <a href="{% url 'smmu_training_requests' %}" class="fab" title="Pending Training Requests">
    <span class="fab-label">Pending Training Requests</span>
  </a>

</div>

<script>
/* --- UI helpers --- */
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
function getSelectedPlanIds() {
  return Array.from(document.querySelectorAll('.plan-checkbox:checked')).map(i => i.value);
}

/* --- quick search/filter inside left list --- */
document.addEventListener('DOMContentLoaded', function(){
  const searchInput = document.getElementById('tp_search');
  const planList = document.getElementById('planList');
  searchInput?.addEventListener('input', function(){
    const q = this.value.trim().toLowerCase();
    document.querySelectorAll('#planList .plan-item').forEach(item => {
      const title = item.querySelector('.plan-title')?.textContent?.toLowerCase() || '';
      if (!q || title.indexOf(q) !== -1) item.style.display = 'flex'; else item.style.display = 'none';
    });
  });

  // select all behavior
  document.getElementById('selectAllPlans')?.addEventListener('change', function(){
    const checked = !!this.checked;
    document.querySelectorAll('.plan-checkbox').forEach(cb => cb.checked = checked);
  });

  // individual plan click to toggle checkbox (click on item)
  document.querySelectorAll('#planList .plan-item').forEach(it => {
    it.addEventListener('click', function(e){
      // ignore clicks on checkbox itself
      if (e.target && (e.target.tagName === 'INPUT' || e.target.closest('input'))) return;
      const cb = this.querySelector('.plan-checkbox');
      if (cb) cb.checked = !cb.checked;
    });
  });

  // assignment logic (AJAX)
  const assignBtn = document.getElementById('assignBtn');
  const messageEl = document.getElementById('assignmentMessage');
  const recentEl = document.getElementById('recentActivity');

  async function postAssign(force=false) {
    const partnerId = document.getElementById('partnerSelect').value;
    const planIds = getSelectedPlanIds();
    const fd = new FormData();
    fd.append('partner_id', partnerId);
    planIds.forEach(id => fd.append('training_plan_ids', id));
    if (force) fd.append('force', '1');

    const resp = await fetch("{% url 'smmu_training_partner_assignment' %}", {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: fd
    });
    return resp.json();
  }

  assignBtn?.addEventListener('click', async function(){
    messageEl.innerHTML = '';
    const partnerId = document.getElementById('partnerSelect').value;
    if (!partnerId) { messageEl.innerHTML = '<span class="text-danger">Select a partner</span>'; return; }
    const planIds = getSelectedPlanIds();
    if (!planIds.length) { messageEl.innerHTML = '<span class="text-danger">Select at least one training plan</span>'; return; }

    try {
      const r = await postAssign(false);
      if (r && r.conflict) {
        // build readable summary
        let txt = 'The following plans are assigned to other partners:\\n\\n';
        r.conflicts.forEach(c => txt += `• ${c.training_name} — ${c.conflicting_partner_name}\\n`);
        txt += '\\nProceed? This will remove the previous assignments.';
        if (confirm(txt)) {
          const r2 = await postAssign(true);
          if (r2 && r2.success) {
            messageEl.innerHTML = '<span class="text-success">' + (r2.message || 'Assigned successfully.') + '</span>';
            // add activity lines
            (r2.created || []).forEach(n => {
              const li = document.createElement('li'); li.textContent = `Created: ${n}`; recentEl.prepend(li);
            });
            (r2.reassigned || []).forEach(n => {
              const li = document.createElement('li'); li.textContent = `Reassigned: ${n}`; recentEl.prepend(li);
            });
            setTimeout(()=> location.reload(), 900);
          } else {
            messageEl.innerHTML = '<span class="text-danger">' + (r2?.error || 'Failed to assign') + '</span>';
          }
        } else {
          messageEl.innerHTML = '<span class="text-muted">Assignment cancelled.</span>';
        }
        return;
      }

      if (r && r.success) {
        messageEl.innerHTML = '<span class="text-success">' + (r.message || 'Assigned successfully.') + '</span>';
        (r.created || []).forEach(n => {
          const li = document.createElement('li'); li.textContent = `Created: ${n}`; recentEl.prepend(li);
        });
        (r.reassigned || []).forEach(n => {
          const li = document.createElement('li'); li.textContent = `Reassigned: ${n}`; recentEl.prepend(li);
        });
        setTimeout(()=> location.reload(), 900);
        return;
      }

      messageEl.innerHTML = '<span class="text-danger">' + (r?.error || 'Assignment failed') + '</span>';
    } catch (e) {
      messageEl.innerHTML = '<span class="text-danger">Error: ' + (e.message || e) + '</span>';
    }
  });

  // reset button clears selections and messages
  document.getElementById('resetBtn')?.addEventListener('click', function(){
    document.querySelectorAll('.plan-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllPlans').checked = false;
    messageEl.innerHTML = '';
  });

});
</script>
{% endblock %}
