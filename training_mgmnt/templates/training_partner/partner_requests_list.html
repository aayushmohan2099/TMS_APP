{% extends "training_partner/base_partner.html" %}
{% load humanize %}
{% block title %}All Training Requests{% endblock %}
{% block header_title %}All Training Requests{% endblock %}
{% block header_subtitle %}Requests assigned to {{ partner.name }}{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <!-- Filters row -->
    <div class="row g-2 align-items-center mb-3">
      <div class="col-auto">
        <label class="form-label small mb-1">Theme</label>
        <select id="filterTheme" class="form-select form-select-sm">
          <option value="">All themes</option>
        </select>
      </div>

      <div class="col-auto">
        <label class="form-label small mb-1">Module (Training)</label>
        <select id="filterModule" name="module" class="form-select form-select-sm">
          <option value="">All modules</option>
        </select>
      </div>

      <div class="col-auto">
        <label class="form-label small mb-1">Status</label>
        <select id="filterStatus" name="status" class="form-select form-select-sm">
          <option value="">All</option>
          <option value="BATCHING">Batching</option>
          <option value="PENDING">Pending</option>
          <option value="ONGOING">Ongoing</option>
          <option value="COMPLETED">Completed</option>
          <option value="REJECTED">Rejected</option>
        </select>
      </div>

      <div class="col">
        <label class="form-label small mb-1">Search</label>
        <div class="input-group input-group-sm">
          <input id="qInput" type="search" class="form-control" placeholder="Search by ID or training name" value="{{ q }}">
          <button id="applyFiltersBtn" class="btn btn-outline-primary btn-flat btn-sm">Apply</button>
          <a id="clearFiltersBtn" class="btn btn-outline-secondary btn-flat btn-sm" href="{% url 'partner_view_requests' %}">Reset</a>
        </div>
      </div>
    </div>

    {% if rows %}
      <div class="table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:90px;">Request</th>
              <th>Created by</th>
              <th style="width:140px;">Block</th>
              <th style="width:120px;">No. of Participants sent</th>
              <th style="width:120px;">Status</th>
              <th style="width:160px;">Last updated</th>
              <th style="width:150px;">Actions</th>
            </tr>
          </thead>
          <tbody id="requestsBody">
            {% for r in rows %}
              <tr data-request-id="{{ r.id }}" data-training-name="{{ r.training_plan|lower }}" data-theme="">
                <td>
                  <div><strong>#{{ r.id }}</strong></div>
                </td>
                <td>{{ r.created_by }}</td>
                <td>{{ r.block }}</td>
                <td>{{ r.participants_sent }}</td>
                <td>
                  <span class="badge bg-{% if r.status|lower == 'pending' or r.status|lower == 'pending approval' %}warning{% elif r.status|lower == 'ongoing' %}success{% elif r.status|lower == 'completed' %}secondary{% elif r.status|lower == 'rejected' %}danger{% else %}secondary{% endif %}">
                    {{ r.status|title }}
                  </span>
                </td>
                <td><small class="text-muted">{{ r.updated|default:"â€”" }}</small></td>
                <td>
                  <div class="d-flex gap-1">
                    <a href="{% url 'partner_request_detail_page' r.id %}" class="btn btn-sm btn-outline-secondary"><i class="fa fa-eye"></i></a>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <nav class="mt-3" aria-label="pagination">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}">Previous</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}

          {% for num in paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-4' and num < page_obj.number|add:'4' %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}{% if q %}&q={{ q }}{% endif %}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}">Next</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        </ul>
      </nav>

    {% else %}
      <div class="text-muted py-4">No training requests assigned to you.</div>
    {% endif %}

    <div class="mt-3 text-end">
      <a href="{% url 'training_partner_dashboard' %}" class="btn btn-outline-secondary btn-sm">Back to dashboard</a>
    </div>
  </div>
</div>

<!-- client data and small UI script (no modal/AJAX) -->
<script>
  (function(){
    // parse modules map and themes passed by view context
    const THEMES = {{ themes_json|default:"[]"|safe }};
    const MODULES_MAP = {{ modules_map_json|default:"{}"|safe }};

    // element refs
    const themeSel = document.getElementById('filterTheme');
    const moduleSel = document.getElementById('filterModule');
    const statusSel = document.getElementById('filterStatus');
    const qInput = document.getElementById('qInput');
    const applyBtn = document.getElementById('applyFiltersBtn');

    // populate theme select
    function populateThemes() {
      // ensure base "All themes" is present already in template
      THEMES.forEach(t => {
        if(!t) return;
        const opt = document.createElement('option');
        opt.value = t;
        opt.text = t;
        themeSel.appendChild(opt);
      });
    }

    function populateModulesForTheme(themeVal) {
      moduleSel.innerHTML = '';
      const opAll = document.createElement('option'); opAll.value=''; opAll.text='All modules'; moduleSel.appendChild(opAll);

      const mods = MODULES_MAP[themeVal] || MODULES_MAP[''] || [];
      mods.forEach(m => {
        const o = document.createElement('option');
        o.value = m.id;
        o.text = m.name;
        moduleSel.appendChild(o);
      });

      {% if selected_module %}
        try { moduleSel.value = "{{ selected_module }}"; } catch(e) {}
      {% endif %}
    }

    // Read status from server-selected context if present
    {% if status_filter %}
      const initialStatus = "{{ status_filter }}";
    {% else %}
      const initialStatus = "";
    {% endif %}

    // initialize
    try {
      populateThemes();

      {% if selected_theme %}
        try { themeSel.value = "{{ selected_theme|escapejs }}"; } catch(e) {}
      {% endif %}

      // set status select if the server passed one
      try { if(initialStatus) statusSel.value = initialStatus; } catch(e) {}

      populateModulesForTheme(themeSel.value || '');

      themeSel.addEventListener('change', function(){ populateModulesForTheme(this.value || ''); });

      applyBtn.addEventListener('click', function(ev){
        ev.preventDefault();
        const params = new URLSearchParams(window.location.search);

        const qv = (qInput.value||'').trim();
        if(qv) params.set('q', qv); else params.delete('q');

        const tv = (themeSel.value||'').trim();
        if(tv) params.set('theme', tv); else params.delete('theme');

        const mv = (moduleSel.value||'').trim();
        if(mv) params.set('module', mv); else params.delete('module');

        const sv = (statusSel.value||'').trim();
        if(sv) params.set('status', sv); else params.delete('status');

        params.delete('page'); // reset to first page on filter change
        const qs = params.toString();
        window.location.search = qs ? ('?' + qs) : '';
      });

      // wire create-batches buttons to correct url with request id
      document.querySelectorAll('.create-batches-btn').forEach(btn => {
        btn.addEventListener('click', function(ev){
          ev.preventDefault();
          const reqId = this.dataset.requestId;
          if(!reqId) return;
          const urlTemplate = this.getAttribute('href');
          const finalUrl = urlTemplate.replace(/0(\/)?$/, reqId + '$1');
          window.location.href = finalUrl;
        });
      });

    } catch(e){
      console.error('partner_requests_list init error', e);
    }
  })();
</script>
{% endblock %}
