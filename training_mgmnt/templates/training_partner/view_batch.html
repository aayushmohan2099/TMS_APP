{% extends "training_partner/base_partner.html" %}
{% load custom_tags %}
{% block title %}Batch {{ batch.code|default:batch.id }}{% endblock %}
{% block header_title %}Batch: {{ batch.code|default:batch.id }}{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-body">
      <h5>Training: {{ batch.training_plan.training_name }}</h5>
      <p><strong>Theme:</strong> {{ batch.training_plan.theme }}</p>
      <p><strong>Partner:</strong>
        {% if partner and partner.name %}
          {{ partner.name }}
        {% elif batch and batch.partner %}
          {% if batch.partner.name %}{{ batch.partner.name }}{% else %}{{ batch.partner }}{% endif %}
        {% else %}
          Not assigned
        {% endif %}
      </p>

      <hr>

      <!-- Beneficiaries table (select participants) -->
      <div class="mb-3">
        <h6>Beneficiaries (choose participants for split)</h6>
        <p class="small text-muted">Select specific beneficiaries to include in a batch. After adding to preview these participants are reserved (removed from the list). Use Cancel Preview to restore.</p>
        {% if beneficiaries and beneficiaries|length %}
          <div class="table-responsive" style="max-height:320px; overflow:auto;">
            <table class="table table-sm table-hover mb-0" id="beneficiariesTable">
              <thead class="table-light position-sticky" style="top:0; z-index:1;">
                <tr>
                  <th style="width:32px;"><input type="checkbox" id="selectAllBeneficiaries" /></th>
                  <th style="width:80px;">ID</th>
                  <th>Name</th>
                  <th style="width:90px;">Gender</th>
                  <th style="width:70px;">Age</th>
                  <th style="width:120px;">Mobile</th>
                  <th class="text-start">Location</th>
                </tr>
              </thead>
              <tbody>
                {% for b in beneficiaries %}
                  <tr data-ben-id-row="{{ b.id }}">
                    <td><input class="form-check-input ben-checkbox" type="checkbox" data-ben-id="{{ b.id }}" id="ben_{{ b.id }}"></td>
                    <td>{{ b.id }}</td>
                    <td>{{ b.display_name }}</td>
                    <td>{{ b.gender_display }}</td>
                    <td>{{ b.age }}</td>
                    <td>{{ b.mobile_display }}</td>
                    <td class="text-start small text-muted">{{ b.village_display }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="mt-2 d-flex justify-content-between">
            <div><small class="text-muted">Showing {{ beneficiaries|length }} beneficiaries</small></div>
            <div><small class="text-muted">Selected: <span id="selectedCount">0</span></small></div>
          </div>
        {% else %}
          <div class="text-muted">No beneficiaries found for this training request.</div>
        {% endif %}
      </div>

      <hr>

      <!-- Confirmed / Proposed centre & dates -->
      <div class="mb-3">
        <h6>Centre & Dates</h6>
        <p><strong>No. of Days (Training Runtime):</strong> {{ batch.training_plan.no_of_days }}</p>
        <p><strong>Confirmed Centre:</strong> {{ batch.centre|default:"(not set)" }}</p>
        <p>
          <strong>Proposed Centre (by partner):</strong>
          {{ batch.centre_proposed|default:"(not proposed)" }}
          &nbsp;
          <a class="btn btn-sm btn-outline-primary ms-2" href="{% url 'training_partner_centre_registration' %}" target="_blank">Open Centre Registration</a>
        </p>
        <p><strong>Start date:</strong> {{ batch.start_date|date:"Y-m-d"|default:"(not set)" }} &nbsp;
           <strong>End date:</strong> {{ batch.end_date|date:"Y-m-d"|default:"(not set)" }}</p>
      </div>

      <hr>

      <!-- Centre selection (single-centre choose) + manual-split UI -->
      <div class="mb-3">
        <h6>Create / Split Batches (manual)</h6>
        <p class="small text-muted">
          Select beneficiaries (via checkboxes), choose a single centre from the dropdown below, set a preferred start date (optional),
          then click <strong>Add to preview</strong>. Repeat for the next batch. When all preview rows look correct click <strong>Create Batches (server)</strong>.
        </p>

        <div class="row g-2 align-items-center mb-2">
          <div class="col-md-5">
            <label class="form-label">Select centre for this allocation</label>
            <select id="centreSelect" class="form-select">
              <option value="">-- Choose centre --</option>
              {% if partner_centres and partner_centres.exists %}
                {% for c in partner_centres %}
                  <option value="{{ c.id }}" data-capacity="{{ c.training_hall_capacity|default:0 }}">{{ c.venue_name|truncatechars:60 }} — capacity: {{ c.training_hall_capacity|default:"—" }}</option>
                {% endfor %}
              {% elif partner and partner.centres.exists %}
                {% for c in partner.centres.all %}
                  <option value="{{ c.id }}" data-capacity="{{ c.training_hall_capacity|default:0 }}">{{ c.venue_name|truncatechars:60 }} — capacity: {{ c.training_hall_capacity|default:"—" }}</option>
                {% endfor %}
              {% else %}
                <option value="">{{ "No registered centres" }}</option>
              {% endif %}
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Preferred start date</label>
            <input type="date" class="form-control" id="preferredStart" value="{{ batch.start_date|date:'Y-m-d' }}">
          </div>

          <div class="col-md-2">
            <label class="form-label">Auto-calc days</label>
            <input type="number" class="form-control" id="runtimeDays" value="{{ batch.training_plan.no_of_days|default:2 }}" min="1">
          </div>

          <div class="col-md-2 d-grid">
            <label class="form-label">&nbsp;</label>
            <button id="addToPreviewBtn" class="btn btn-outline-primary">Add to preview</button>
          </div>
        </div>

        <!-- preview area -->
        <div id="splitPreview" class="mt-3" style="display:none;">
          <h6 class="mb-2">Preview: Batches to create</h6>
          <div class="table-responsive">
            <table class="table table-sm table-bordered" id="previewTable">
              <thead class="table-light">
                <tr><th style="width:48px;">#</th><th>Centre</th><th style="width:110px;">Capacity</th><th style="width:160px;">Assigned participants</th><th style="width:120px;">Start</th><th style="width:120px;">End</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="d-flex justify-content-end gap-2 mt-2">
            <button id="createBatchesBtn" class="btn btn-primary">Create Batches (server)</button>
            <a href="#" id="cancelPreview" class="btn btn-outline-secondary">Cancel Preview</a>
          </div>

          <div class="mt-2 small text-muted">Once created, each preview row will become a Batch linked to this TrainingRequest.</div>
        </div>
      </div>

      <hr>

    </div>
  </div>

  <!-- Tiny hidden holder with beneficiary ids so JS can slice them (fallback) -->
  <script>
    const ALL_BENEFICIARIES = [
      {% if batch.request and batch.request.beneficiaries.exists %}
        {% for ben in batch.request.beneficiaries.all %}
          {{ ben.id }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      {% elif batch.beneficiaries and batch.beneficiaries.exists %}
        {% for ben in batch.beneficiaries.all %}
          {{ ben.id }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      {% endif %}
    ];
    {% if batch.request %}
      const TRAINING_REQUEST_ID = {{ batch.request.id }};
    {% else %}
      const TRAINING_REQUEST_ID = null;
    {% endif %}
  </script>

  <!-- Manual splitting logic (redirects to dashboard after success) -->
  <script>
    (function(){
      const addBtn = document.getElementById('addToPreviewBtn');
      const previewArea = document.getElementById('splitPreview');
      const previewTableBody = document.querySelector('#previewTable tbody');
      const createBatchesBtn = document.getElementById('createBatchesBtn');
      const cancelPreview = document.getElementById('cancelPreview');
      const runtimeDaysInput = document.getElementById('runtimeDays');
      const preferredStartInput = document.getElementById('preferredStart');
      const centreSelect = document.getElementById('centreSelect');
      const totalParticipantsInput = document.getElementById('totalParticipants') || { value: (ALL_BENEFICIARIES.length || 0) };
      const selectAll = document.getElementById('selectAllBeneficiaries');
      const selectedCountEl = document.getElementById('selectedCount');
      const beneficiariesTbody = document.querySelector('#beneficiariesTable tbody');

      // maintain an array of preview rows (each row = {centre_id, centre_label, capacity, assigned_ids, start, end})
      previewArea._previewRows = previewArea._previewRows || [];
      // store removed rows to restore on cancel
      previewArea._removedRows = previewArea._removedRows || [];

      // helper: get ids of checked ben checkboxes
      function getCheckedBeneficiaryIds() {
        const nodes = Array.from(document.querySelectorAll('.ben-checkbox:checked'));
        return nodes.map(n => parseInt(n.dataset.benId || n.getAttribute('data-ben-id')));
      }
      function updateSelectedCount() {
        const cnt = getCheckedBeneficiaryIds().length;
        selectedCountEl.textContent = String(cnt);
      }
      if(selectAll) {
        selectAll.addEventListener('change', function(){
          const checked = selectAll.checked;
          document.querySelectorAll('.ben-checkbox').forEach(function(cb){ cb.checked = checked; });
          updateSelectedCount();
        });
      }
      document.querySelectorAll('.ben-checkbox').forEach(cb => cb.addEventListener('change', updateSelectedCount));

      // helper to find beneficiary row element by id
      function _findRowForBenId(id) {
        return beneficiariesTbody.querySelector(`tr[data-ben-id-row="${id}"]`);
      }

      // remove rows for given IDs (store their HTML & index so we can restore)
      function removeAssignedFromDOM(assignedIds) {
        assignedIds = assignedIds.map(x => parseInt(x));
        const currentRows = Array.from(beneficiariesTbody.children);
        for(const id of assignedIds) {
          const tr = _findRowForBenId(id);
          if(tr) {
            const idx = currentRows.indexOf(tr);
            previewArea._removedRows.push({id: id, index: idx, html: tr.outerHTML});
            tr.remove();
          }
        }
        // update totals
        totalParticipantsInput.value = String(beneficiariesTbody.querySelectorAll('.ben-checkbox').length);
        // reset selection state
        if(selectAll) selectAll.checked = false;
        document.querySelectorAll('.ben-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
      }

      // restore removed rows in original order
      function restoreRemovedRows() {
        if(!previewArea._removedRows || !previewArea._removedRows.length) return;
        // sort by index then insert at index or append
        previewArea._removedRows.sort((a,b) => (a.index - b.index));
        const children = Array.from(beneficiariesTbody.children);
        for(const item of previewArea._removedRows) {
          beneficiariesTbody.insertAdjacentHTML('beforeend', item.html);
        }
        // rebind change listeners on the restored checkboxes
        document.querySelectorAll('.ben-checkbox').forEach(cb => {
          cb.removeEventListener('change', updateSelectedCount);
          cb.addEventListener('change', updateSelectedCount);
        });
        // clear removed list
        previewArea._removedRows = [];
        // update totals
        totalParticipantsInput.value = String(beneficiariesTbody.querySelectorAll('.ben-checkbox').length);
        selectedCountEl.textContent = String(getCheckedBeneficiaryIds().length);
      }

      // compute end date (add days)
      function addDays(iso, days) {
        if(!iso) return '';
        const d = new Date(iso);
        d.setDate(d.getDate() + days);
        return d.toISOString().slice(0,10);
      }

      // add selected participants + selected centre as one preview row
      addBtn?.addEventListener('click', function(ev){
        ev.preventDefault();
        const selectedCentreId = centreSelect.value || null;
        if(!selectedCentreId) {
          alert('Please choose a centre for this allocation.');
          return;
        }
        const centreOption = centreSelect.querySelector(`option[value="${selectedCentreId}"]`);
        const capacity = centreOption ? parseInt(centreOption.dataset.capacity||0,10) : 0;
        const centreLabel = centreOption ? centreOption.textContent.trim() : ('Centre #' + selectedCentreId);

        const selectedBenIds = getCheckedBeneficiaryIds();
        if(!selectedBenIds || selectedBenIds.length === 0) {
          alert('Please select one or more beneficiaries to add to the preview.');
          return;
        }

        // compute start/end
        const days = parseInt(runtimeDaysInput.value||2,10) || 2;
        const startDate = preferredStartInput.value || '';
        const endDate = startDate ? addDays(startDate, days) : '';

        // create preview row object
        const rowObj = {
          centre_id: parseInt(selectedCentreId),
          centre_label: centreLabel,
          capacity: capacity,
          assigned_ids: selectedBenIds.slice(),
          assigned_count: selectedBenIds.length,
          start: startDate,
          end: endDate
        };

        // append to in-memory preview array
        previewArea._previewRows.push(rowObj);

        // render new row in preview table
        const idx = previewArea._previewRows.length;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx}</td>
                        <td>${rowObj.centre_label} <small class="text-muted">#${rowObj.centre_id}</small></td>
                        <td>${rowObj.capacity || '-'}</td>
                        <td>${rowObj.assigned_count}</td>
                        <td>${rowObj.start || '-'}</td>
                        <td>${rowObj.end || '-'}</td>`;
        tr.dataset.assignedIds = JSON.stringify(rowObj.assigned_ids);
        tr.dataset.centreId = rowObj.centre_id;
        tr.dataset.start = rowObj.start;
        previewTableBody.appendChild(tr);

        // Remove these assigned beneficiaries from the visible list
        removeAssignedFromDOM(selectedBenIds);

        // show preview area
        previewArea.style.display = 'block';
        previewArea.scrollIntoView({behavior:'smooth'});
      });

      // Cancel: restore removed beneficiaries and clear preview rows
      cancelPreview?.addEventListener('click', function(e){
        e.preventDefault();
        restoreRemovedRows();
        previewTableBody.innerHTML = '';
        previewArea._previewRows = [];
        previewArea.style.display = 'none';
      });

      // csrf helper
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const c = cookies[i].trim();
            if (c.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(c.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      // Create Batches: send the preview rows as centres payload
      createBatchesBtn?.addEventListener('click', async function(){
        if(!previewArea._previewRows || !previewArea._previewRows.length) {
          alert('No preview rows to create. Add one or more allocations first.');
          return;
        }
        if(!TRAINING_REQUEST_ID) {
          alert('Training request id not available. Cannot create batches.');
          return;
        }

        // Build payload
        const centresPayload = previewArea._previewRows.map(r => ({
          centre_id: r.centre_id,
          capacity: r.capacity,
          start: r.start || null,
          beneficiaries: r.assigned_ids || []
        }));

        const payload = {
          training_request_id: TRAINING_REQUEST_ID,
          centres: centresPayload
        };

        const csrftoken = getCookie('csrftoken');

        try {
          let createBatchesUrl = "{% url 'partner_create_batches' 0 %}";
          createBatchesUrl = createBatchesUrl.replace(/0(\/)?$/, String(TRAINING_REQUEST_ID) + '$1');

          const resp = await fetch(createBatchesUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(payload)
          });
          const data = await resp.json();
          if(!resp.ok || !data.ok) {
            const msg = data.error || data.message || JSON.stringify(data);
            alert('Failed to create batches: ' + msg);
            console.error('Create batches error', data);
            return;
          }

          const created = data.created || [];
          alert(`Created ${created.length} batches successfully.`);

          // Redirect to TP dashboard so the TrainingRequest disappears from requests list.
          // Uses the standard partner dashboard path (adjust if your site uses a different path).
          window.location.href = "/bmmu/partner/";
        } catch (err) {
          console.error(err);
          alert('Unexpected error creating batches. See console for details.');
        }
      });

      // small UX: collapse placeholder when no submissions
      document.querySelectorAll('.collapse').forEach(function(el){
        el.addEventListener('shown.bs.collapse', function(e){
          const table = el.querySelector('table tbody');
          if(table && table.children.length === 0){
            const cardBody = el.querySelector('.card-body');
            if(cardBody && !cardBody.querySelector('.no-submissions')) {
              const no = document.createElement('div');
              no.className = 'no-submissions text-muted small';
              no.textContent = 'No submissions for this centre.';
              cardBody.appendChild(no);
            }
          } else {
            const placeholder = el.querySelector('.no-submissions');
            if(placeholder) placeholder.remove();
          }
        });
      });

    })();
  </script>
{% endblock %}
