{% extends "training_partner/base_partner.html" %}
{% load static %}

{% block title %}TP Dashboard{% endblock %}
{% block header_title %}Welcome, {% if partner and partner.name %}{{ partner.name }}{% else %}{{ user.get_full_name|default:user.username }}{% endif %}{% endblock %}
{% block header_subtitle %}Select an application from the left to begin.{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- KPI Row -->
  <div class="row mb-3 text-center justify-content-center">
    <div class="col-auto">
      <div class="card p-2" style="min-width:140px;">
        <div class="small text-muted">Total Trainings</div>
        <div class="h5 mb-0">{{ partner.assigned_batches_qs|length }}</div>
      </div>
    </div>
    <div class="col-auto">
      <div class="card p-2" style="min-width:140px;">
        <div class="small text-muted">Upcoming (7d)</div>
        <div class="h5 mb-0">
          {% if running %}{{ running|length }}{% else %}0{% endif %}
        </div>
      </div>
    </div>
    <div class="col-auto">
      <div class="card p-2" style="min-width:140px;">
        <div class="small text-muted">Avg Attendance</div>
        <div class="h5 mb-0">—</div>
      </div>
    </div>
    <div class="col-auto">
      <div class="card p-2" style="min-width:140px;">
        <div class="small text-muted">Invoices Pending</div>
        <div class="h5 mb-0">—</div>
      </div>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="row g-3">
    <!-- LEFT: Targets + Requests -->
    <div class="col-md-8">
      <!-- Training Targets -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="mb-2">Training Targets</h5>
          <p class="small text-muted">Targets assigned to your partner (summary).</p>

          {% if partner and partner.targets.exists %}
            <ul class="list-group mb-2">
              {% for t in partner.targets.all|slice:":8" %}
                <li class="list-group-item d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-bold">{{ t.target_key }}</div>
                    <div class="small text-muted">{{ t.target_type }} — {{ t.notes|default:"" }}</div>
                  </div>
                  <div class="text-end">
                    <div class="h5 mb-0">{{ t.target_count|default:"—" }}</div>
                  </div>
                </li>
              {% endfor %}
            </ul>
            <div class="text-end"><a href="#" class="btn btn-sm btn-link">View all targets</a></div>
          {% else %}
            <div class="text-center text-muted py-3">No targets assigned yet.</div>
          {% endif %}
        </div>
      </div>

      <!-- Training Requests -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="mb-2">Training Requests</h5>
          <p class="small text-muted">Recent requests sent by BMMU/DMMU/SMMU for which your partner may create batches.</p>

          <ul class="list-group mb-2">
            {% for req in training_requests|default:assignments|slice:":8" %}
              <li class="list-group-item d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">{{ req.training_plan.training_name }}</div>
                  <div class="small text-muted">Requested: {{ req.created_at|date:"Y-m-d" }} — Level: {{ req.level }}</div>
                  <div class="small text-muted">Requested beneficiaries: {{ req.beneficiary_registrations.count|default:req.beneficiaries.count }}</div>
                </div>
                <div class="d-flex flex-column align-items-end gap-2">
                  <a href="{% url 'partner_view_request' req.id %}" class="btn btn-sm btn-outline-primary">Open Request</a>
                  {% if req.partner_id == partner.id or not req.partner_id %}
                    <a href="{% url 'partner_view_request' req.id %}" class="btn btn-sm btn-primary">Create Batches</a>
                  {% endif %}
                </div>
              </li>
            {% empty %}
              <li class="list-group-item text-center text-muted">No requests</li>
            {% endfor %}
          </ul>
          <div class="text-end"><a href="#" class="btn btn-sm btn-link">View all requests</a></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Quick Actions + Analytics -->
    <div class="col-md-4">
      <!-- Quick Actions -->
      <div class="card mb-3">
        <div class="card-body">
          <h6>Quick Actions</h6>
          <div class="d-grid gap-2">
            <a class="btn btn-primary" href="{% url 'partner_ongoing_trainings' %}">Ongoing Trainings</a>
            <a class="btn btn-outline-secondary" href="{% url 'training_partner_centre_registration' %}">Centre Registration</a>
            <a class="btn btn-outline-secondary" href="{% url 'partner_profile' %}">Edit Profile</a>
          </div>
        </div>
      </div>

      <!-- Analytics -->
      <div class="text-center mb-2">
        <button class="btn btn-outline-primary btn-sm" id="toggleAnalyticsBtn">Show Analytics</button>
      </div>

      <div id="analyticsSection" style="display:none;">
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="mb-3">Monthly Trainings & Attendance</h6>
            <canvas id="tpChartLineSmall" style="height:220px;"></canvas>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-body">
                <h6 class="mb-2">By Theme (sample)</h6>
                <canvas id="tpChartBarSmall" style="height:180px;"></canvas>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-body text-center">
                <h6 class="mb-2">Attendance Breakdown</h6>
                <canvas id="tpChartDoughnutSmall" style="height:180px; max-width:180px; margin:auto;"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Toggle analytics visibility
  const toggleBtn = document.getElementById('toggleAnalyticsBtn');
  const analyticsSection = document.getElementById('analyticsSection');
  toggleBtn.addEventListener('click', () => {
    const isHidden = analyticsSection.style.display === 'none';
    analyticsSection.style.display = isHidden ? 'block' : 'none';
    toggleBtn.textContent = isHidden ? 'Hide Analytics' : 'Show Analytics';
  });

  // Chart rendering (unchanged)
  const months = ['May','Jun','Jul','Aug','Sep','Oct'];
  const trainingsPerMonth = [2,4,3,6,5,4];
  const attendancePct = [78,82,80,85,83,81];

  const ctxL = document.getElementById('tpChartLineSmall')?.getContext('2d');
  if(ctxL) new Chart(ctxL, {
    data:{ labels: months, datasets: [
      { type:'bar', label:'Trainings', data:trainingsPerMonth, borderRadius:6 },
      { type:'line', label:'Attendance %', data:attendancePct, tension:0.35 }
    ]},
    options:{ responsive:true, interaction:{mode:'index',intersect:false} }
  });

  const ctxB = document.getElementById('tpChartBarSmall')?.getContext('2d');
  if(ctxB) new Chart(ctxB, { type:'bar', data:{ labels:['Agri','IT','Hosp'], datasets:[{ data:[6,4,3], borderRadius:6 }] }, options:{ indexAxis:'y', responsive:true } });

  const ctxD = document.getElementById('tpChartDoughnutSmall')?.getContext('2d');
  if(ctxD) new Chart(ctxD, { type:'doughnut', data:{ labels:['Present','Absent','Excused'], datasets:[{ data:[820,140,40] }] }, options:{ responsive:true } });
</script>
{% endblock %}
