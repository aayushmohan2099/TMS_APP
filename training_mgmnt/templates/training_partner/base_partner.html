{% load static %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}Training Partner Portal{% endblock %}</title>

  <!-- Bootstrap CSS (use your project's bootstrap or this CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <style>
    /* Minimal styling to match your mockup (preserved) */
    body { background:#fff; min-height:100vh; }
    .tp-header { background: #fff7e6; border-bottom:4px solid #f0a040; padding:10px 18px; }
    .tp-header h1 { font-size:18px; margin:0; font-weight:600; color:#333; display:inline-block; vertical-align:middle; }
    .tp-topright { display:flex; align-items:center; gap:12px; }
    .tp-pfp { width:44px; height:44px; border-radius:999px; object-fit:cover; border:2px solid #f0a040; cursor:pointer; }
    .tp-sidebar { border-right:4px solid #f0a040; background:#fff; min-height:calc(100vh - 64px); padding-top:18px; transition: width 180ms ease, padding 180ms ease, margin 180ms ease; }
    .tp-sidebar .nav-link { color:#222; padding:12px 20px; font-weight:600; }
    .tp-sidebar .nav-link.active { background:#fff2e6; color:#d35400; }
    .tp-content { padding:24px; }

    /* small dropdown under pfp */
    .tp-pfp-dropdown { position:relative; }
    .tp-pfp-menu {
      display:none;
      position:absolute;
      right:0;
      top:52px;
      background:#fff;
      border:1px solid #eee;
      box-shadow:0 6px 20px rgba(0,0,0,0.08);
      z-index:50;
      min-width:160px;
      border-radius:6px;
      overflow:hidden;
    }
    .tp-pfp-menu a { display:block; padding:10px 14px; color:#333; text-decoration:none; }
    .tp-pfp-menu a:hover { background:#f6f6f6; color:#000; }

    .btn-flat.btn-info {
          background-color: #00c0ef;
          border: none;
          color: white;
          transition: background 0.2s ease;
    }
    .btn-flat.btn-info:hover {
      background-color: #00a7d0;
    }


    /* make content area scroll if large */
    .tp-main { height:calc(100vh - 64px); overflow:auto; }

    footer.tp-footer { position:fixed; left:0; right:0; bottom:0; background:#222; color:#fff; padding:10px 0; text-align:center; }

    /* helper for compact controls placed near lists */
    .compact-actions .btn { padding:6px 10px; font-size:13px; }

    /* === Collapsible sidebar (surgical & minimal) === */
    /* collapsed hides sidebar visually and lets main take full width */
    .tp-sidebar.collapsed {
      display: none !important;
      width: 0 !important;
      padding: 0 !important;
      border-right: 0 !important;
    }
    /* when sidebar hidden, make main occupy full width - no layout jump on flex */
    .tp-main.fullwidth { width: 100%; }

    /* toggle button styling (small) */
    .sidebar-toggle-btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:34px;
      height:34px;
      border-radius:6px;
      border:1px solid rgba(0,0,0,0.06);
      background:#fff;
      cursor:pointer;
      margin-left:8px;
      font-size:16px;
    }
    .sidebar-toggle-btn:focus { outline:3px solid rgba(240,160,64,0.15); }
  </style>

  {% block head_extra %}{% endblock %}
</head>
<body>
  <!-- Header -->
  <header class="tp-header d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <div style="padding-right:18px;">
        <strong style="font-size:18px;">Training Partner Management</strong>
      </div>
      <div class="ms-2 d-flex align-items-center">
        <h1 style="font-size:20px; margin:0;">{% block header_title %}Welcome{% endblock %}</h1>

        <!-- COLLAPSE BUTTON: surgical addition beside header title -->
        <button id="toggleTpSidebarBtn" class="sidebar-toggle-btn" type="button" aria-controls="tpSidebar" aria-expanded="true" title="Toggle sidebar">
          ☰
        </button>

        <div class="small text-muted ms-3">{% block header_subtitle %}Select an application from the left to begin.{% endblock %}</div>
      </div>
    </div>

    <div class="tp-topright">
      <div class="text-end me-2">
        <!-- show real partner name -->
        <div style="font-weight:600; font-size:14px;">
          {% if partner and partner.name %}{{ partner.name }}
          {% elif user.get_full_name %}{{ user.get_full_name }}
          {% else %}{{ user.username }}{% endif %}
        </div>
        <div class="small text-muted">({{ user.username }})</div>
      </div>

      <div class="tp-pfp-dropdown">
        {% if partner and partner.profile_picture %}
          <img src="{{ partner.profile_picture.url }}" alt="pfp" class="tp-pfp" id="tpPfp">
        {% else %}
          <img src="{% static 'images/default-avatar.png' %}" alt="pfp" class="tp-pfp" id="tpPfp">
        {% endif %}

        <div class="tp-pfp-menu" id="tpPfpMenu" aria-hidden="true">
          <a href="{% url 'partner_profile' %}">Profile</a>
          <a href="{% url 'custom_logout' %}">Logout</a>
        </div>
      </div>
    </div>
  </header>

  <div class="d-flex">
    <!-- Sidebar -->
    <nav class="tp-sidebar col-2 p-0" id="tpSidebar" role="navigation" aria-label="Main menu">
      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="{% url 'training_partner_dashboard' %}" data-menu="dashboard">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'partner_ongoing_trainings' %}" data-menu="attendance">Attendance Management</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'training_partner_centre_registration' %}" data-menu="centre">Centre Registration</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-menu="invoice">Invoice generation</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-menu="reports">Reports generation</a>
        </li>
      </ul>
    </nav>

    <!-- Main content -->
    <main class="tp-main col p-3" id="tpMain">
      {% if messages %}
        <div class="container mt-2">
          {% for msg in messages %}
            <div class="alert alert-{{ msg.tags|default:'info' }} alert-dismissible fade show" role="alert">
              {{ msg }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
      <div class="tp-content">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  <footer class="tp-footer">© {{ now.year }} Training Management Portal. All Rights Reserved.</footer>

  <!-- Bootstrap + minimal helpers -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // small pfp dropdown toggle
    const pfp = document.getElementById('tpPfp');
    const pfpMenu = document.getElementById('tpPfpMenu');
    if (pfp) {
      pfp.addEventListener('click', function(e){
        e.stopPropagation();
        if (pfpMenu.style.display === 'block') { pfpMenu.style.display = 'none'; pfpMenu.setAttribute('aria-hidden','true');}
        else { pfpMenu.style.display = 'block'; pfpMenu.setAttribute('aria-hidden','false');}
      });
      // hide on outside click
      document.addEventListener('click', function(){ pfpMenu.style.display = 'none'; pfpMenu.setAttribute('aria-hidden','true'); });
    }

    // sidebar active toggle (small)
    document.querySelectorAll('.tp-sidebar .nav-link').forEach(a=>{
      a.addEventListener('click', function(ev){
        document.querySelectorAll('.tp-sidebar .nav-link').forEach(x=>x.classList.remove('active'));
        this.classList.add('active');
      });
    });
  </script>

  <!-- === Collapsible sidebar toggle (surgical, minimal) === -->
  <script>
    (function(){
      const btn = document.getElementById('toggleTpSidebarBtn');
      const sidebar = document.getElementById('tpSidebar');
      const main = document.getElementById('tpMain');

      if (!btn || !sidebar || !main) return; // guard - won't run if elements missing

      let collapsed = false;

      function setCollapsed(v) {
        collapsed = !!v;
        if (collapsed) {
          sidebar.classList.add('collapsed');
          main.classList.add('fullwidth');
          btn.setAttribute('aria-expanded', 'false');
          btn.title = 'Show sidebar';
        } else {
          sidebar.classList.remove('collapsed');
          main.classList.remove('fullwidth');
          btn.setAttribute('aria-expanded', 'true');
          btn.title = 'Hide sidebar';
        }
      }

      // toggle click
      btn.addEventListener('click', function(e){
        setCollapsed(!collapsed);
      });

      // keyboard accessibility for the toggle (Enter/Space)
      btn.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          setCollapsed(!collapsed);
        }
      });

      // optional: on narrow screens, start with collapsed to maximize content (kept off by default)
      // if (window.innerWidth < 900) setCollapsed(true);

      // close when clicking outside on small screens (non-intrusive)
      document.addEventListener('click', function(e){
        if (!collapsed && window.innerWidth < 900 && !sidebar.contains(e.target) && !btn.contains(e.target)) {
          setCollapsed(true);
        }
      });

      // expose for debugging
      window.setTpSidebarCollapsed = setCollapsed;

      // init state
      setCollapsed(true);
    })();
  </script>

  {% block body_extra %}
  {% endblock %}
  {% block scripts %}
  {% endblock %}
</body>
</html>
