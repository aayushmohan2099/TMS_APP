{% extends "training_partner/base_partner.html" %}
{% load static %}

{% block title %}Batch Attendance{% endblock %}

{% block header_title %}
  {% if batch.training_plan and batch.training_plan.training_name %}
    {{ batch.training_plan.training_name }}
  {% elif batch.request and batch.request.training_plan and batch.request.training_plan.training_name %}
    {{ batch.request.training_plan.training_name }}
  {% else %}
    Batch {{ batch.code|default:batch.id }}
  {% endif %}
{% endblock %}

{% block header_subtitle %}Batch: {{ batch.code|default:batch.id }}{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Batch Details -->
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <h5 class="mb-2">Batch Details</h5>
      <p><strong>Centre:</strong>
        {% if batch.centre %}
          {{ batch.centre.venue_name }}
        {% else %}
          {{ batch.centre_name|default:"â€”" }}
        {% endif %}
      </p>
      <p><strong>Start Date:</strong> {{ batch.start_date|date:"Y-m-d" }} | <strong>End Date:</strong> {{ batch.end_date|date:"Y-m-d" }}</p>
      <p><strong>Status:</strong>
        <span class="badge bg-{% if batch.status|lower == 'ongoing' %}success{% else %}secondary{% endif %}">
          {{ batch.status|title }}
        </span>
      </p>
    </div>
  </div>

  {% if show_attendance %}
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <h5 class="mb-3">Attendance for {{ today|date:"Y-m-d" }}</h5>
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label fw-bold">Upload Punch Machine CSV (optional):</label>
          <input type="file" name="csv_file" accept=".csv" class="form-control">
          <small class="text-muted">Optional - upload one CSV file for today's punch records.</small>
        </div>

        <h6>Master Trainers</h6>
        <table class="table table-sm table-bordered">
          <thead><tr><th>Name</th><th>Present</th></tr></thead>
          <tbody>
            {% for t in trainers %}
            <tr>
              <td>{{ t.name }}</td>
              <td><input type="checkbox" name="trainer_{{ t.id }}" aria-label="Present {{ t.name }}"></td>
            </tr>
            {% empty %}
            <tr><td colspan="2" class="text-muted">No trainers assigned.</td></tr>
            {% endfor %}
          </tbody>
        </table>

        <h6>Beneficiaries</h6>
        <table class="table table-sm table-bordered">
          <thead><tr><th>Name</th><th>Present</th></tr></thead>
          <tbody>
            {% for b in beneficiaries %}
            <tr>
              <td>{{ b.name }}</td>
              <td><input type="checkbox" name="beneficiary_{{ b.id }}" aria-label="Present {{ b.name }}"></td>
            </tr>
            {% empty %}
            <tr><td colspan="2" class="text-muted">No beneficiaries found for this batch.</td></tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="text-end">
          <button type="submit" class="btn btn-success">Submit Attendance</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <h5 class="mb-3">Attendance Records</h5>
      {% if attendance_list %}
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead><tr><th>Date</th><th>Note / Label</th></tr></thead>
            <tbody>
              {% for a in attendance_list %}
              <tr>
                <td><a href="{% url 'attendance_per_batch' batch.id %}?date={{ a.date|date:'Y-m-d' }}">{{ a.date|date:"Y-m-d" }}</a></td>
                <td>{{ a.note|default:"Attendance" }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-muted"></div>
      {% endif %}
    </div>
  </div>

  {# Selected-date detail view (unchanged) #}
  {% if selected_date and attendance_records %}
    <div class="card shadow-sm">
      <div class="card-body">
        <h5>Attendance on {{ selected_date }}</h5>
        <table class="table table-sm table-striped">
          <thead><tr><th>Name</th><th>Role</th><th>Status</th></tr></thead>
          <tbody>
            {% for record in attendance_records %}
            <tr>
              <td>{{ record.participant_name }}</td>
              <td>{{ record.participant_role|title }}</td>
              <td>
                <span class="badge bg-{% if record.present %}success{% else %}danger{% endif %}">
                  {% if record.present %}Present{% else %}Absent{% endif %}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% elif selected_date and not attendance_records %}
    <div class="card shadow-sm">
      <div class="card-body text-muted">No attendance records for {{ selected_date }}.</div>
    </div>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
  {# no special JS required for normal attendance beyond base scripts #}
{% endblock %}
