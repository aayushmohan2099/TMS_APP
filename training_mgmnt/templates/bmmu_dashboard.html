{% load static %}
{% load custom_tags %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>BMMU Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Bootstrap CSS assumed loaded globally in your base; if not include here -->
  <style>
  #beneficiariesTable td {
    color: #212529 !important;
    text-indent: 0 !important;
    opacity: 1 !important;
  }

  /* preserve your old styles + sticky header */
  .table-responsive.custom-scroll { overflow-x: auto; max-height: 60vh; }
  #beneficiariesTable thead th {
    position: sticky;
    top: 0;
    z-index: 7;
    background: #212529; /* table-dark bg */
    color: white;
    font-weight: 700;
    font-size: 14px;
    padding: .6rem .75rem;
  }

  .table thead .form-control, .table thead .form-select {
    height: calc(1.5em + .5rem);
    padding: .25rem .5rem;
    font-size: .85rem;
  }

  #addBeneficiaryModal .modal-body,
  #deleteBeneficiariesModal .modal-body {
      max-height: 75vh;
      overflow-y: auto;
      padding: 1rem;
  }

  .dropdown-checkboxes { max-height: 260px; overflow:auto; padding: .25rem; }
  .dropdown-checkboxes label { display:block; padding: .15rem .25rem; font-size: .9rem; }

  .filter-btn { padding: .25rem .5rem; font-size: .85rem; }

  .col-header { font-weight: 700; font-size: .95rem; color: #fff; display:block; margin-bottom:.25rem;}

  .dropdown-menu.moved-to-body {
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    max-height: 360px;
    overflow:auto;
    z-index: 3000 !important;
  }

  /* Dashboard grid & analytics panel */
  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
    align-items: start;
  }
  .dashboard-grid.analytics-open {
    grid-template-columns: 2fr 1fr;
  }
  .analytics-panel {
    background: #fbfdff;
    border: 1px solid #e6f0ff;
    border-radius: 6px;
    padding: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    display: none;
    min-height: 60vh;
  }
  .analytics-panel.visible { display:block; }

  /* compress table when analytics open */
  table.table-compressed td, table.table-compressed th {
    padding: .35rem .5rem;
    font-size: .88rem;
  }

  /* clickable row visuals */
  #beneficiariesTable tbody tr.clickable-row { cursor: pointer; }
  #beneficiariesTable tbody tr.clickable-row td { user-select: none; }

  @media (max-width: 768px) {
    .dashboard-grid.analytics-open { grid-template-columns: 1fr; }
    .analytics-panel { order: 2; }
  }
  </style>
</head>
<body>
<div class="container-fluid">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <!-- Analytics toggle -->
    <button id="toggleAnalyticsTop" class="btn btn-sm btn-outline-primary ms-auto" aria-expanded="false" aria-controls="analyticsPanel">Show analytics</button>
  </div>

  <div class="dashboard-grid" id="dashboardGrid">

    <!-- Left: Beneficiary Management -->
    <div>
      <h4 class="mb-3">Beneficiary Management</h4>

      <!-- Toolbar: Search (global), Sort controls -->
      <div class="d-flex align-items-center fragment-toolbar gap-2 mb-2">
        <div style="flex:1 1 520px;">
          <div class="input-group">
            <input id="globalSearch" class="form-control form-control-lg" placeholder="Search member name / SHG / Gram Panchayat / Village" value="{{ search_query }}">
            <button class="btn btn-outline-secondary" id="globalSearchBtn">Search</button>
          </div>
        </div>

        <div style="min-width:260px;">
          <div class="input-group">
            <select id="toolbarSortBy" class="form-select form-select-sm">
              <option value="">Sort by</option>
              <!-- Provide only the model-field names we expose -->
              <option value="member_name" {% if sort_by == 'member_name' %}selected{% endif %}>Member Name</option>
              <option value="date_of_birth" {% if sort_by == 'date_of_birth' %}selected{% endif %}>Age</option>
              <option value="shg_name" {% if sort_by == 'shg_name' %}selected{% endif %}>SHG Name</option>
              <option value="social_category" {% if sort_by == 'social_category' %}selected{% endif %}>Social Category</option>
              <option value="designation_in_shg_vo_clf" {% if sort_by == 'designation_in_shg_vo_clf' %}selected{% endif %}>Designation</option>
              <option value="religion" {% if sort_by == 'religion' %}selected{% endif %}>Religion</option>
              <option value="gender" {% if sort_by == 'gender' %}selected{% endif %}>Gender</option>
              <option value="gram_panchayat" {% if sort_by == 'gram_panchayat' %}selected{% endif %}>Gram Panchayat</option>
              <option value="village" {% if sort_by == 'village' %}selected{% endif %}>Village</option>
            </select>
            <select id="toolbarOrder" class="form-select form-select-sm" style="min-width:110px;">
              <option value="asc" {% if order == 'asc' %}selected{% endif %}>Ascending</option>
              <option value="desc" {% if order == 'desc' %}selected{% endif %}>Descending</option>
            </select>
            <button id="toolbarApplyBtn" class="btn btn-secondary btn-sm">Apply</button>
          </div>
        </div>

        <div class="ms-auto d-flex gap-2 align-items-center">
          <div id="import-placeholder" class="d-none d-flex align-items-center gap-2">
            <form id="importForm" method="post" enctype="multipart/form-data" action="{% url 'bmmu_dashboard' %}">
              {% csrf_token %}
              <input type="file" name="import_file" class="form-control form-control-sm" style="display:inline-block; width:220px;">
              <button type="submit" class="btn btn-warning btn-sm">Import Excel</button>
            </form>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Actions</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="action_import">Import</a></li>
              <li><a class="dropdown-item" href="{% url 'bmmu_dashboard' %}?export=1">Export Excel</a></li>
              <li><a class="dropdown-item" href="{% url 'bmmu_dashboard' %}?blueprint=1">Download Blueprint</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="action_add_inline">Add Beneficiary</a></li>
              <li><a class="dropdown-item text-danger" href="#" id="action_delete_selected">Delete selected beneficiaries?</a></li>
            </ul>
          </div>
        </div>
      </div>

      <script id="__groupable_values_json" type="application/json">{{ groupable_values_json|safe }}</script>

      <div class="table-responsive custom-scroll mt-3">
        <table class="table table-bordered table-hover table-sm" id="beneficiariesTable" style="min-width:1100px;">
          <thead class="table-dark">
            <tr>
              <th style="width:60px; white-space:nowrap;">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="selectAllRows" title="Select all visible">
                </div>
              </th>

              <!-- Explicit column definitions (only requested fields) -->
              <th style="min-width:200px; white-space:nowrap;" data-field="member_name">
                <span class="col-header">Member Name</span>
                <div class="d-flex">
                  <div class="text-muted small">—</div>
                </div>
              </th>

              <th style="min-width:90px; white-space:nowrap;" data-field="date_of_birth">
                <span class="col-header">Age</span>
                <div class="d-flex">
                  <div class="text-muted small">Sort by DOB</div>
                </div>
              </th>

              <th style="min-width:180px; white-space:nowrap;" data-field="shg_name">
                <span class="col-header">SHG Name</span>
                <div class="d-flex">
                  {% if groupable_values and groupable_values|get_item:"shg_name" %}
                    <div class="dropdown w-100">
                      <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" id="dd_main_shg_name" data-bs-toggle="dropdown" aria-expanded="false" data-field="shg_name">Filter</button>
                      <div class="dropdown-menu p-2" style="min-width:220px; max-height:300px; overflow-y:auto;">
                        <div class="dropdown-checkboxes">
                          {% with groupable_values|get_item:"shg_name" as vals %}
                            {% for val in vals %}
                              {% if val %}
                                <div class="form-check">
                                  <input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="shg_name" value="{{ val }}" id="chk_shg_name_{{ forloop.counter }}">
                                  <label class="form-check-label" for="chk_shg_name_{{ forloop.counter }}">{{ val }}</label>
                                </div>
                              {% endif %}
                            {% endfor %}
                          {% endwith %}
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                          <button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="shg_name">Clear</button>
                          <button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="shg_name">Apply</button>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <div class="text-muted small">—</div>
                  {% endif %}
                </div>
              </th>

              <th style="min-width:140px; white-space:nowrap;" data-field="social_category">
                <span class="col-header">Social Category</span>
                <div class="d-flex">
                  {% if groupable_values and groupable_values|get_item:"social_category" %}
                    <div class="dropdown w-100">
                      <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" id="dd_main_social_category" data-bs-toggle="dropdown" aria-expanded="false" data-field="social_category">Filter</button>
                      <div class="dropdown-menu p-2" style="min-width:220px; max-height:300px; overflow-y:auto;">
                        <div class="dropdown-checkboxes">
                          {% with groupable_values|get_item:"social_category" as vals %}
                            {% for val in vals %}
                              {% if val %}
                                <div class="form-check">
                                  <input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="social_category" value="{{ val }}" id="chk_social_category_{{ forloop.counter }}">
                                  <label class="form-check-label" for="chk_social_category_{{ forloop.counter }}">{{ val }}</label>
                                </div>
                              {% endif %}
                            {% endfor %}
                          {% endwith %}
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                          <button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="social_category">Clear</button>
                          <button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="social_category">Apply</button>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <div class="text-muted small">—</div>
                  {% endif %}
                </div>
              </th>

              <th style="min-width:160px; white-space:nowrap;" data-field="designation_in_shg_vo_clf">
                <span class="col-header">Designation</span>
                <div class="d-flex">
                  {% if groupable_values and groupable_values|get_item:"designation_in_shg_vo_clf" %}
                    <div class="dropdown w-100">
                      <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" id="dd_main_designation_in_shg_vo_clf" data-bs-toggle="dropdown" aria-expanded="false" data-field="designation_in_shg_vo_clf">Filter</button>
                      <div class="dropdown-menu p-2" style="min-width:220px; max-height:300px; overflow-y:auto;">
                        <div class="dropdown-checkboxes">
                          {% with groupable_values|get_item:"designation_in_shg_vo_clf" as vals %}
                            {% for val in vals %}
                              {% if val %}
                                <div class="form-check">
                                  <input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="designation_in_shg_vo_clf" value="{{ val }}" id="chk_designation_{{ forloop.counter }}">
                                  <label class="form-check-label" for="chk_designation_{{ forloop.counter }}">{{ val }}</label>
                                </div>
                              {% endif %}
                            {% endfor %}
                          {% endwith %}
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                          <button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="designation_in_shg_vo_clf">Clear</button>
                          <button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="designation_in_shg_vo_clf">Apply</button>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <div class="text-muted small">—</div>
                  {% endif %}
                </div>
              </th>

              <th style="min-width:120px; white-space:nowrap;" data-field="religion">
                <span class="col-header">Religion</span>
                <div class="d-flex">
                  {% if groupable_values and groupable_values|get_item:"religion" %}
                    <div class="dropdown w-100">
                      <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" id="dd_main_religion" data-bs-toggle="dropdown" aria-expanded="false" data-field="religion">Filter</button>
                      <div class="dropdown-menu p-2" style="min-width:220px; max-height:300px; overflow-y:auto;">
                        <div class="dropdown-checkboxes">
                          {% with groupable_values|get_item:"religion" as vals %}
                            {% for val in vals %}
                              {% if val %}
                                <div class="form-check">
                                  <input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="religion" value="{{ val }}" id="chk_religion_{{ forloop.counter }}">
                                  <label class="form-check-label" for="chk_religion_{{ forloop.counter }}">{{ val }}</label>
                                </div>
                              {% endif %}
                            {% endfor %}
                          {% endwith %}
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                          <button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="religion">Clear</button>
                          <button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="religion">Apply</button>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <div class="text-muted small">—</div>
                  {% endif %}
                </div>
              </th>

              <th style="min-width:100px; white-space:nowrap;" data-field="gender">
                <span class="col-header">Gender</span>
                <div class="d-flex">
                  {% if groupable_values and groupable_values|get_item:"gender" %}
                    <div class="dropdown w-100">
                      <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" id="dd_main_gender" data-bs-toggle="dropdown" aria-expanded="false" data-field="gender">Filter</button>
                      <div class="dropdown-menu p-2" style="min-width:220px; max-height:300px; overflow-y:auto;">
                        <div class="dropdown-checkboxes">
                          {% with groupable_values|get_item:"gender" as vals %}
                            {% for val in vals %}
                              {% if val %}
                                <div class="form-check">
                                  <input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="gender" value="{{ val }}" id="chk_gender_{{ forloop.counter }}">
                                  <label class="form-check-label" for="chk_gender_{{ forloop.counter }}">{{ val }}</label>
                                </div>
                              {% endif %}
                            {% endfor %}
                          {% endwith %}
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                          <button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="gender">Clear</button>
                          <button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="gender">Apply</button>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <div class="text-muted small">—</div>
                  {% endif %}
                </div>
              </th>

              <th style="min-width:150px; white-space:nowrap;" data-field="gram_panchayat">
                <span class="col-header">Gram Panchayat</span>
                <div class="d-flex">
                  {% if groupable_values and groupable_values|get_item:"gram_panchayat" %}
                    <div class="dropdown w-100">
                      <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" id="dd_main_gram_panchayat" data-bs-toggle="dropdown" aria-expanded="false" data-field="gram_panchayat">Filter</button>
                      <div class="dropdown-menu p-2" style="min-width:220px; max-height:300px; overflow-y:auto;">
                        <div class="dropdown-checkboxes">
                          {% with groupable_values|get_item:"gram_panchayat" as vals %}
                            {% for val in vals %}
                              {% if val %}
                                <div class="form-check">
                                  <input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="gram_panchayat" value="{{ val }}" id="chk_gram_panchayat_{{ forloop.counter }}">
                                  <label class="form-check-label" for="chk_gram_panchayat_{{ forloop.counter }}">{{ val }}</label>
                                </div>
                              {% endif %}
                            {% endfor %}
                          {% endwith %}
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                          <button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="gram_panchayat">Clear</button>
                          <button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="gram_panchayat">Apply</button>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <div class="text-muted small">—</div>
                  {% endif %}
                </div>
              </th>

              <th style="min-width:140px; white-space:nowrap;" data-field="village">
                <span class="col-header">Village</span>
                <div class="d-flex">
                  {% if groupable_values and groupable_values|get_item:"village" %}
                    <div class="dropdown w-100">
                      <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" id="dd_main_village" data-bs-toggle="dropdown" aria-expanded="false" data-field="village">Filter</button>
                      <div class="dropdown-menu p-2" style="min-width:220px; max-height:300px; overflow-y:auto;">
                        <div class="dropdown-checkboxes">
                          {% with groupable_values|get_item:"village" as vals %}
                            {% for val in vals %}
                              {% if val %}
                                <div class="form-check">
                                  <input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="village" value="{{ val }}" id="chk_village_{{ forloop.counter }}">
                                  <label class="form-check-label" for="chk_village_{{ forloop.counter }}">{{ val }}</label>
                                </div>
                              {% endif %}
                            {% endfor %}
                          {% endwith %}
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                          <button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="village">Clear</button>
                          <button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="village">Apply</button>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <div class="text-muted small">—</div>
                  {% endif %}
                </div>
              </th>

            </tr>
          </thead>
          <tbody>
            {% for obj in page_obj %}
              <tr class="clickable-row" data-pk="{{ obj.pk }}">
                <td>
                  <div class="form-check">
                    <input class="form-check-input row-select-checkbox" type="checkbox" data-id="{{ obj.id }}" title="Select row">
                  </div>
                </td>

                <!-- Member Name -->
                <td style="white-space:normal;">{{ obj|attr:"member_name" }}</td>

                <!-- Age (computed from date_of_birth client-side). store dob in data attribute for JS -->
                <td style="white-space:normal;" data-dob="{{ obj.date_of_birth|default:'' }}">{{ obj.date_of_birth|default:'' }}</td>

                <!-- SHG Name -->
                <td style="white-space:normal;">{{ obj|attr:"shg_name" }}</td>

                <!-- Social Category -->
                <td style="white-space:normal;">{{ obj|attr:"social_category" }}</td>

                <!-- Designation -->
                <td style="white-space:normal;">{{ obj|attr:"designation_in_shg_vo_clf"}}</td>

                <!-- Religion -->
                <td style="white-space:normal;">{{ obj|attr:"religion" }}</td>

                <!-- Gender -->
                <td style="white-space:normal;">{{ obj|attr:"gender" }}</td>

                <!-- Gram Panchayat -->
                <td style="white-space:normal;">{{ obj|attr:"gram_panchayat" }}</td>

                <!-- Village -->
                <td style="white-space:normal;">{{ obj|attr:"village" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="10" class="text-center">No beneficiaries found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <nav aria-label="Page navigation example" class="mt-2">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if order %}&order={{ order }}{% endif %}">Previous</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}

          {% for num in paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-5' and num < page_obj.number|add:'5' %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if order %}&order={{ order }}{% endif %}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if order %}&order={{ order }}{% endif %}">Next</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        </ul>
      </nav>

      <!-- Inline Add container and modals -->
      <div id="inlineAddContainer" class="mt-3" style="display:none;"></div>

      <div class="modal fade" id="addBeneficiaryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Add Beneficiary</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><div id="addBeneficiaryContainer">Loading...</div></div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="deleteBeneficiariesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable" style="max-width:95%;">
          <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Delete Beneficiaries</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><div id="deleteBeneficiariesContainer">Loading...</div></div>
            <div class="modal-footer"><button id="confirmDeleteBtn" class="btn btn-danger">Delete Selected</button><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button></div>
          </div>
        </div>
      </div>

      <!-- Beneficiary detail modal (new) -->
      <div class="modal fade" id="beneficiaryDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 id="beneficiaryDetailModalLabel" class="modal-title">Beneficiary details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="beneficiaryDetailModalBody" class="modal-body">
              <div class="text-center text-muted">Loading...</div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- end left column -->

    <!-- Right: Analytics panel (hidden initially) -->
    <aside id="analyticsPanel" class="analytics-panel" role="complementary" aria-hidden="true">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Analytics</strong>
        <button id="hideAnalyticsBtn" class="btn btn-sm btn-outline-secondary">Hide</button>
      </div>

      <p class="text-muted small">SMMU quick stats</p>
      <div class="row mb-2">
        <div class="col-12" style="height:320px;">
          <canvas id="chart1"></canvas>
        </div>
      </div>
      <div class="row">
        <div class="col-12" style="height:320px;">
          <canvas id="chart2"></canvas>
        </div>
      </div>
    </aside>

  </div> <!-- end dashboardGrid -->

</div> <!-- end container -->

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Inline JS: preserved from old template + analytics toggle wrapping -->
<script>
/* ---------- Constants & util functions ---------- */
const FRAGMENT_URL = "{% url 'load_app_content' app_name='bmmu' %}";
const LOAD_ADD_URL = "{% url 'load_app_content' app_name='bmmu_add' %}";
const ADD_POST_URL = "{% url 'bmmu_add_beneficiary' %}";
const DELETE_POST_URL = "{% url 'bmmu_delete_beneficiaries' %}";

// detail URL template uses Django reverse with a dummy pk (0), we will replace the '0' with actual pk
const DETAIL_URL_TEMPLATE = "{% url 'bmmu_beneficiary_detail' 0 %}";

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i=0;i<cookies.length;i++){
      const c = cookies[i].trim();
      if (c.substring(0, name.length+1) === (name + '=')) {
        cookieValue = decodeURIComponent(c.substring(name.length+1));
        break;
      }
    }
  }
  return cookieValue;
}
const CSRF_TOKEN = getCookie('csrftoken');

let GROUPABLE_VALUES = {};
try {
  const el = document.getElementById('__groupable_values_json');
  if (el) GROUPABLE_VALUES = JSON.parse(el.textContent || el.innerText || '{}');
} catch(e){ GROUPABLE_VALUES = {}; }

let _chart1 = null, _chart2 = null;
function initCharts() {
  try {
    if (_chart1 && _chart1.destroy) { try{ _chart1.destroy(); }catch(e){} }
    if (_chart2 && _chart2.destroy) { try{ _chart2.destroy(); }catch(e){} }

    const labels = {{ chart_labels|safe }};
    const data1 = {{ chart1|safe }};
    const data2 = {{ chart2|safe }};

    const c1 = document.getElementById('chart1');
    if (c1) {
      const ctx1 = c1.getContext('2d');
      _chart1 = new Chart(ctx1, {
        type: 'bar',
        data: { labels: labels, datasets: [{ label: 'Metric 1', data: data1 }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    const c2 = document.getElementById('chart2');
    if (c2) {
      const ctx2 = c2.getContext('2d');
      _chart2 = new Chart(ctx2, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'Metric 2', data: data2, fill:false }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
  } catch(e) {
    console.warn('Chart init error', e);
  }
}

function reloadFragmentWithParams(params) {
  const qs = params && params.toString() ? ('?' + params.toString()) : '';
  const url = FRAGMENT_URL + qs;
  fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(r => {
      if (!r.ok) throw new Error('Failed to load fragment');
      return r.text();
    })
    .then(html => {
      document.getElementById('content-area').innerHTML = html;
      if (typeof window.fragmentInit === 'function') {
        try { window.fragmentInit(); } catch(e) { console.warn('fragmentInit error', e); }
      }
    })
    .catch(err => {
      console.error('reloadFragmentWithParams', err);
    });
}

function currentParams() {
  return new URLSearchParams(window.location.search || '');
}

function attachToolbarHandlers() {
  document.getElementById('globalSearchBtn')?.addEventListener('click', function(){
    const q = document.getElementById('globalSearch')?.value?.trim() || '';
    const params = new URLSearchParams();
    if (q) params.set('search', q);
    const sortBy = document.getElementById('toolbarSortBy')?.value;
    const order = document.getElementById('toolbarOrder')?.value;
    if (sortBy) params.set('sort_by', sortBy);
    if (order) params.set('order', order);
    document.querySelectorAll('.main-col-filter-checkbox:checked').forEach(cb => {
      const f = cb.dataset.field;
      const prev = params.get('filter_' + f);
      params.set('filter_' + f, prev ? (prev + ',' + cb.value) : cb.value);
    });
    reloadFragmentWithParams(params);
  });

  document.getElementById('toolbarApplyBtn')?.addEventListener('click', function(){
    const params = new URLSearchParams();
    const q = document.getElementById('globalSearch')?.value?.trim() || '';
    if (q) params.set('search', q);
    const sortBy = document.getElementById('toolbarSortBy')?.value;
    const order = document.getElementById('toolbarOrder')?.value;
    if (sortBy) params.set('sort_by', sortBy);
    if (order) params.set('order', order);
    document.querySelectorAll('.main-col-filter-checkbox:checked').forEach(cb => {
      const f = cb.dataset.field;
      const prev = params.get('filter_' + f);
      params.set('filter_' + f, prev ? (prev + ',' + cb.value) : cb.value);
    });
    params.set('page', 1);
    reloadFragmentWithParams(params);
  });
}

function attachDropdownFilters() {
  document.querySelectorAll('.main-dd-apply').forEach(btn => {
    btn.removeEventListener?.('click', btn._main_dd_apply_listener);
    const listener = function() {
      const field = this.dataset.field;
      const checked = Array.from(document.querySelectorAll(`.main-col-filter-checkbox[data-field="${field}"]:checked`)).map(x=>x.value);
      const params = currentParams();
      params.delete('filter_' + field);
      if (checked.length) params.set('filter_' + field, checked.join(','));
      const q = document.getElementById('globalSearch')?.value?.trim();
      if (q) params.set('search', q);
      const sortBy = document.getElementById('toolbarSortBy')?.value;
      const order = document.getElementById('toolbarOrder')?.value;
      if (sortBy) params.set('sort_by', sortBy);
      if (order) params.set('order', order);
      params.set('page', 1);
      reloadFragmentWithParams(params);
    };
    btn.addEventListener('click', listener);
    btn._main_dd_apply_listener = listener;
  });

  document.querySelectorAll('.main-dd-clear').forEach(btn => {
    btn.removeEventListener?.('click', btn._main_dd_clear_listener);
    const listener = function(){
      const field = this.dataset.field;
      document.querySelectorAll(`.main-col-filter-checkbox[data-field="${field}"]`).forEach(cb => cb.checked = false);
      const params = currentParams();
      params.delete('filter_' + field);
      const q = document.getElementById('globalSearch')?.value?.trim();
      if (q) params.set('search', q);
      const sortBy = document.getElementById('toolbarSortBy')?.value;
      const order = document.getElementById('toolbarOrder')?.value;
      if (sortBy) params.set('sort_by', sortBy);
      if (order) params.set('order', order);
      params.set('page', 1);
      reloadFragmentWithParams(params);
    };
    btn.addEventListener('click', listener);
    btn._main_dd_clear_listener = listener;
  });
}

function wireHeaderSorting() {
  document.querySelectorAll('#beneficiariesTable thead th[data-field]').forEach(th => {
    const field = th.dataset.field;
    if (!field) return;
    th.style.cursor = 'pointer';
    th.addEventListener('click', function(e){
      if (e.target.closest('.dropdown') || e.target.closest('.dropdown-menu') || e.target.classList.contains('main-col-filter-checkbox')) return;
      const params = currentParams();
      const currentSort = params.get('sort_by') || "{{ sort_by }}";
      const currentOrder = params.get('order') || "{{ order }}";
      let newOrder = 'asc';
      if (currentSort === field && currentOrder === 'asc') newOrder = 'desc';
      params.set('sort_by', field);
      params.set('order', newOrder);
      params.set('page', 1);
      document.querySelectorAll('.main-col-filter-checkbox:checked').forEach(cb => {
        const f = cb.dataset.field;
        const prev = params.get('filter_' + f);
        params.set('filter_' + f, prev ? prev + ',' + cb.value : cb.value);
      });
      const q = document.getElementById('globalSearch')?.value?.trim();
      if (q) params.set('search', q);
      reloadFragmentWithParams(params);
    });
  });
}

function initDropdownMoveToBody() {
  document.querySelectorAll('.dropdown-toggle[data-field]').forEach(btn => {
    if (btn._moved_listener) return;
    const listener = function(e){
      const toggle = this;
      const ddMenu = toggle.parentElement.querySelector('.dropdown-menu');
      if (!ddMenu) return;
      if (!ddMenu.__moved) {
        const rect = toggle.getBoundingClientRect();
        ddMenu.style.position = 'absolute';
        ddMenu.style.top = (rect.bottom + window.scrollY) + 'px';
        ddMenu.style.left = (rect.left + window.scrollX) + 'px';
        ddMenu.style.minWidth = Math.max(220, rect.width) + 'px';
        ddMenu.classList.add('moved-to-body');
        document.body.appendChild(ddMenu);
        ddMenu.__moved = true;
        const outside = (ev) => {
          if (!ddMenu.contains(ev.target) && ev.target !== toggle) {
            if (ddMenu.__original_parent) ddMenu.__original_parent.appendChild(ddMenu);
            ddMenu.style.position = '';
            ddMenu.style.top = '';
            ddMenu.style.left = '';
            ddMenu.classList.remove('moved-to-body');
            ddMenu.__moved = false;
            document.removeEventListener('click', outside);
          }
        };
        setTimeout(()=> document.addEventListener('click', outside), 0);
      }
    };
    btn.addEventListener('click', listener);
    btn._moved_listener = listener;
  });
}

function initRowSelectionHandlers() {
  const selectAll = document.getElementById('selectAllRows');
  if (selectAll) {
    selectAll.addEventListener('change', function(){
      const checked = !!this.checked;
      document.querySelectorAll('.row-select-checkbox').forEach(cb => cb.checked = checked);
    });
  }
  document.querySelectorAll('.row-select-checkbox').forEach(cb => {
    cb.addEventListener('change', function(){
      const all = Array.from(document.querySelectorAll('.row-select-checkbox'));
      const anyUnchecked = all.some(x => !x.checked);
      const sa = document.getElementById('selectAllRows');
      if (sa) sa.checked = !anyUnchecked && all.length > 0;
    });
  });
}
function getSelectedIds() {
  return Array.from(document.querySelectorAll('.row-select-checkbox:checked')).map(cb => cb.dataset.id);
}

function wireActionsForTable() {
  document.getElementById('action_import')?.addEventListener('click', function(e){
    e.preventDefault();
    document.getElementById('import-placeholder')?.classList.remove('d-none');
  });

  document.getElementById('action_add_inline')?.addEventListener('click', function(e){
    e.preventDefault();
    const container = document.getElementById('inlineAddContainer');
    container.innerHTML = '<h5 class="mt-3 mb-2"><center>Individual Beneficiary Registration</center></h5><div class="p-3" id="inlineAddInner">Loading form...</div>';
    container.style.display = 'block';
    fetch(LOAD_ADD_URL, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.text())
      .then(html => {
        const inner = document.getElementById('inlineAddInner');
        if (!inner) return;
        inner.innerHTML = html;
        const form = inner.querySelector('form');
        if (form) {
          form.addEventListener('submit', function(ev){
            ev.preventDefault();
            const fd = new FormData(form);
            fetch(ADD_POST_URL, {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': CSRF_TOKEN },
              body: fd
            }).then(r => {
              const params = currentParams();
              reloadFragmentWithParams(params);
              container.style.display = 'none';
              container.innerHTML = '';
            }).catch(err => {
              console.error('Add submit failed', err);
              alert('Add failed — see console.');
            });
          });
        }
      }).catch(err => {
        console.error('Load add form failed', err);
        container.innerHTML = '<div class="alert alert-danger">Failed to load add form.</div>';
      });
  });

  document.getElementById('action_delete_selected')?.addEventListener('click', function(e){
    e.preventDefault();
    const ids = getSelectedIds();
    if (!ids.length) { alert('No rows selected'); return; }
    if (!confirm(`Delete ${ids.length} selected beneficiary(ies)?`)) return;
    const fd = new FormData();
    ids.forEach(i => fd.append('delete_ids[]', i));
    fetch(DELETE_POST_URL, {
      method:'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': CSRF_TOKEN },
      body: fd
    }).then(async r => {
      if (!r.ok) {
        const txt = await r.text().catch(()=>null);
        throw new Error(txt || 'Delete failed');
      }
      return r.json();
    }).then(data => {
      alert((data.deleted || 0) + ' beneficiary(ies) deleted.');
      const params = currentParams();
      reloadFragmentWithParams(params);
    }).catch(err => {
      console.error('Delete failed', err);
      alert('Delete failed — check console.');
    });
  });
}

/* ---------- Beneficiary detail modal helpers (new) ---------- */

function renderDetailHtml(data) {
  // Build two-column responsive layout of key/value pairs
  let html = '<div class="container-fluid"><div class="row">';
  for (const [k, v] of Object.entries(data)) {
    const label = k.replace(/_/g, ' ');
    const value = (v === null || v === undefined) ? '' : String(v);
    html += `
      <div class="col-12 col-md-6 mb-2">
        <dl class="row mb-0">
          <dt class="col-5 text-muted" style="font-weight:600;">${label}</dt>
          <dd class="col-7 mb-0">${value}</dd>
        </dl>
      </div>
    `;
  }
  html += '</div></div>';
  return html;
}

function attachRowClickHandlers() {
  document.querySelectorAll('#beneficiariesTable tbody tr[data-pk]').forEach(tr => {
    if (tr._detailListener) return; // avoid double-bind
    tr.addEventListener('click', function (e) {
      // don't open modal when clicking on inputs/links/buttons inside row
      if (e.target.closest('input,button,a,select')) return;
      const pk = this.dataset.pk;
      if (!pk) return;

      // construct URL from template. Replace '/0/' segment with '/<pk>/'.
      let url = DETAIL_URL_TEMPLATE;
      if (url.indexOf('/0/') !== -1) {
        url = url.replace('/0/', `/${pk}/`);
      } else if (url.endsWith('0/')) {
        url = url.replace(/0\/$/, `${pk}/`);
      } else {
        // fallback: append pk
        url = url.replace(/0$/, pk);
      }

      const bodyEl = document.getElementById('beneficiaryDetailModalBody');
      if (bodyEl) bodyEl.innerHTML = '<div class="text-center text-muted">Loading...</div>';

      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(resp => {
          if (!resp.ok) throw new Error('Failed to fetch beneficiary details');
          return resp.json();
        })
        .then(json => {
          if (!json || !json.ok || !json.data) throw new Error('Invalid response');
          const body = document.getElementById('beneficiaryDetailModalBody');
          if (body) body.innerHTML = renderDetailHtml(json.data);
          const modalEl = new bootstrap.Modal(document.getElementById('beneficiaryDetailModal'));
          modalEl.show();
        })
        .catch(err => {
          console.error('Error loading beneficiary details', err);
          const body = document.getElementById('beneficiaryDetailModalBody');
          if (body) body.innerHTML = '<div class="alert alert-danger">Unable to load beneficiary details.</div>';
        });
    });
    tr._detailListener = true;
  });
}

/* ---------- fragmentInit: wire everything ---------- */
function fragmentInit() {
  try { initCharts(); } catch(e) { /* charts may not be visible; safe to ignore */ }
  try { attachToolbarHandlers(); } catch(e) { console.warn('toolbar handlers error', e); }
  try { attachDropdownFilters(); } catch(e) { console.warn('attachDropdownFilters', e); }
  try { initDropdownMoveToBody(); } catch(e) { console.warn('initDropdownMoveToBody', e); }
  try { wireHeaderSorting(); } catch(e) { console.warn('wireHeaderSorting', e); }
  try { initRowSelectionHandlers(); } catch(e) { console.warn('row selection init', e); }
  try { wireActionsForTable(); } catch(e) { console.warn('actions wiring', e); }
  try { attachRowClickHandlers(); } catch(e) { console.warn('attachRowClickHandlers', e); }

  // Compute Age column values client-side from data-dob (YYYY-MM-DD). Leaves DOB cell unchanged if blank.
  try {
    document.querySelectorAll('#beneficiariesTable tbody tr').forEach(row => {
      const dobTd = row.querySelector('td[data-dob]');
      if (!dobTd) return;
      const dobVal = dobTd.getAttribute('data-dob');
      if (!dobVal) {
        dobTd.textContent = '';
        return;
      }
      const d = new Date(dobVal);
      if (isNaN(d.getTime())) {
        const maybe = (dobVal || '').split(' ')[0];
        const d2 = new Date(maybe);
        if (isNaN(d2.getTime())) {
          dobTd.textContent = dobVal || '';
          return;
        } else {
          computeAndSetAge(d2, dobTd);
        }
      } else {
        computeAndSetAge(d, dobTd);
      }
    });
  } catch(e) { console.warn('Age compute error', e); }
}

function computeAndSetAge(dobDate, td) {
  const today = new Date();
  let age = today.getFullYear() - dobDate.getFullYear();
  const m = today.getMonth() - dobDate.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < dobDate.getDate())) age--;
  td.textContent = (Number.isFinite(age) && age >= 0) ? age : '';
}

document.addEventListener('DOMContentLoaded', function(){
  fragmentInit();
});

(function(){
  const dashboardGrid = document.getElementById('dashboardGrid');
  const analyticsPanel = document.getElementById('analyticsPanel');
  const toggleBtn = document.getElementById('toggleAnalyticsTop');
  const hideBtn = document.getElementById('hideAnalyticsBtn');
  const table = document.getElementById('beneficiariesTable');

  let analyticsOpen = false;

  function openAnalytics() {
    analyticsOpen = true;
    dashboardGrid.classList.add('analytics-open');
    analyticsPanel.classList.add('visible');
    analyticsPanel.setAttribute('aria-hidden', 'false');
    toggleBtn.setAttribute('aria-expanded', 'true');
    toggleBtn.textContent = 'Hide analytics';
    if (table) table.classList.add('table-compressed');
    try { initCharts(); } catch(e) { console.warn('initCharts error', e); }
  }
  function closeAnalytics() {
    analyticsOpen = false;
    dashboardGrid.classList.remove('analytics-open');
    analyticsPanel.classList.remove('visible');
    analyticsPanel.setAttribute('aria-hidden', 'true');
    toggleBtn.setAttribute('aria-expanded', 'false');
    toggleBtn.textContent = 'Show analytics';
    if (table) table.classList.remove('table-compressed');
  }

  toggleBtn.addEventListener('click', function(){ analyticsOpen ? closeAnalytics() : openAnalytics(); });
  hideBtn.addEventListener('click', function(){ closeAnalytics(); });

  // ensure initial hidden state
  closeAnalytics();

  // optional: open if ?analytics=1
  (function(){ const urlParams = new URLSearchParams(window.location.search); if (urlParams.get('analytics') === '1') openAnalytics(); })();

})();
</script>

</body>
</html>
