{% load static %}
{% load custom_tags %}

<style>
/* Sticky header for main table */
.table-responsive.custom-scroll { overflow-x: auto; max-height: 60vh; }
#beneficiariesTable thead th {
  position: sticky;
  top: 0;
  z-index: 7;
  background: #212529; /* table-dark bg */
  color: white;
  font-weight: 700;
  font-size: 14px;
  padding: .6rem .75rem;
}

/* small inputs in header (we keep only a tiny visible 'Filter' button area) */
.table thead .form-control, .table thead .form-select {
  height: calc(1.5em + .5rem);
  padding: .25rem .5rem;
  font-size: .85rem;
}

/* modal scrolling */
#addBeneficiaryModal .modal-body,
#deleteBeneficiariesModal .modal-body {
    max-height: 75vh;
    overflow-y: auto;
    padding: 1rem;
}

/* dropdown checkbox area */
.dropdown-checkboxes { max-height: 260px; overflow:auto; padding: .25rem; }
.dropdown-checkboxes label { display:block; padding: .15rem .25rem; font-size: .9rem; }

/* compact filter button */
.filter-btn { padding: .25rem .5rem; font-size: .85rem; }

/* increase visibility of headings */
.col-header { font-weight: 700; font-size: .95rem; color: #fff; display:block; margin-bottom:.25rem;}

/* ensure dropdown menus are on top when moved to body */
.dropdown-menu.moved-to-body {
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  max-height: 360px;
  overflow:auto;
  z-index: 3000 !important;
}
</style>

<div class="container-fluid">

  <h3 class="mb-3">Analytics Overview</h3>
  <div class="row mb-4">
    <div class="col-md-6" style="height:320px;">
      <canvas id="chart1"></canvas>
    </div>
    <div class="col-md-6" style="height:320px;">
      <canvas id="chart2"></canvas>
    </div>
  </div>

  <h4 class="mb-3">Beneficiary Management</h4>

  <!-- Toolbar: Search (global), Sort controls -->
  <div class="d-flex align-items-center fragment-toolbar gap-2 mb-2">
    <div style="flex:1 1 520px;">
      <div class="input-group">
        <input id="globalSearch" class="form-control form-control-lg" placeholder="Global search (member/shg/mobile/...)" value="{{ search_query }}">
        <button class="btn btn-outline-secondary" id="globalSearchBtn">Search</button>
      </div>
    </div>

    <div style="min-width:260px;">
      <div class="input-group">
        <select id="toolbarSortBy" class="form-select form-select-sm">
          <option value="">Sort by</option>
          {% for item in field_list %}
            {% with fname=item.0 vname=item.1 %}
              {% if fname != 'id' %}
                <option value="{{ fname }}" {% if sort_by == fname %}selected{% endif %}>{{ vname|title }}</option>
              {% endif %}
            {% endwith %}
          {% endfor %}
        </select>
        <select id="toolbarOrder" class="form-select form-select-sm" style="min-width:110px;">
          <option value="asc" {% if order == 'asc' %}selected{% endif %}>Ascending</option>
          <option value="desc" {% if order == 'desc' %}selected{% endif %}>Descending</option>
        </select>
        <button id="toolbarApplyBtn" class="btn btn-secondary btn-sm">Apply</button>
      </div>
    </div>

    <div class="ms-auto d-flex gap-2 align-items-center">
      <div id="import-placeholder" class="d-none d-flex align-items-center gap-2">
        <form id="importForm" method="post" enctype="multipart/form-data" action="{% url 'bmmu_dashboard' %}">
          {% csrf_token %}
          <input type="file" name="import_file" class="form-control form-control-sm" style="display:inline-block; width:220px;">
          <button type="submit" class="btn btn-warning btn-sm">Import Excel</button>
        </form>
      </div>

      <div class="btn-group">
        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Actions</button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#" id="action_import">Import</a></li>
          <li><a class="dropdown-item" href="{% url 'bmmu_dashboard' %}?export=1">Export Excel</a></li>
          <li><a class="dropdown-item" href="{% url 'bmmu_dashboard' %}?blueprint=1">Download Blueprint</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" id="action_add_inline">Add Beneficiary</a></li>
          <li><a class="dropdown-item text-danger" href="#" id="action_delete_selected">Delete selected beneficiaries?</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- embed groupable_values JSON for JS (safe) -->
  <script id="__groupable_values_json" type="application/json">{{ groupable_values_json|safe }}</script>

  <!-- Table with per-column filters in header (checkbox dropdowns for groupable fields) -->
  <div class="table-responsive custom-scroll mt-3">
    <table class="table table-bordered table-hover table-sm" id="beneficiariesTable" style="min-width:1400px;">
      <thead class="table-dark">
        <tr>
          <!-- NEW: select-all column -->
          <th style="width:60px; white-space:nowrap;">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAllRows" title="Select all visible">
            </div>
          </th>

          {% for item in field_list %}
            {% with field_name=item.0 verbose_name=item.1 %}
              {% if field_name != 'id' %}
                <th style="min-width:160px; white-space:nowrap;" data-field="{{ field_name }}">
                  <span class="col-header">{{ verbose_name|title }}</span>
                  <!-- existing filter dropdown markup remains as-is -->
                  <div class="d-flex">
                    {% if groupable_values and groupable_values|get_item:field_name %}
                      <!-- ... existing filter dropdown ... -->
                      <div class="dropdown w-100">
                        <button class="btn btn-sm btn-light dropdown-toggle filter-btn w-100" type="button" id="dd_main_{{ field_name }}" data-bs-toggle="dropdown" aria-expanded="false" data-field="{{ field_name }}">Filter</button>
                        <div class="dropdown-menu p-2" style="min-width:220px; max-height:300px; overflow-y:auto;">
                          <div class="dropdown-checkboxes">
                            {% with groupable_values|get_item:field_name as vals %}
                              {% for val in vals %}
                                {% if val %}
                                  <div class="form-check">
                                    <input class="form-check-input main-col-filter-checkbox" type="checkbox" data-field="{{ field_name }}" value="{{ val }}" id="chk_{{ field_name }}_{{ forloop.counter }}">
                                    <label class="form-check-label" for="chk_{{ field_name }}_{{ forloop.counter }}">{{ val }}</label>
                                  </div>
                                {% endif %}
                              {% endfor %}
                            {% endwith %}
                          </div>
                          <div class="d-flex justify-content-between mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary main-dd-clear" data-field="{{ field_name }}">Clear</button>
                            <button type="button" class="btn btn-sm btn-primary main-dd-apply" data-field="{{ field_name }}">Apply</button>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div class="text-muted small">—</div>
                    {% endif %}
                  </div>
                </th>
              {% endif %}
            {% endwith %}
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for obj in page_obj %}
          <tr>
            <td>
              <div class="form-check">
                <input class="form-check-input row-select-checkbox" type="checkbox" data-id="{{ obj.id }}" title="Select row">
              </div>
            </td>

            {% for item in field_list %}
              {% with field_name=item.0 verbose_name=item.1 %}
                {% if field_name != 'id' %}
                  <td style="white-space:normal;">{{ obj|attr:field_name }}</td>
                {% endif %}
              {% endwith %}
            {% endfor %}
          </tr>
        {% empty %}
          <tr><td colspan="{{ field_list|length|add:'0' }}" class="text-center">No beneficiaries found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination (unchanged) -->
  <nav aria-label="Page navigation example" class="mt-2">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if order %}&order={{ order }}{% endif %}">Previous</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for num in paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num > page_obj.number|add:'-5' and num < page_obj.number|add:'5' %}
          <li class="page-item"><a class="page-link" href="?page={{ num }}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if order %}&order={{ order }}{% endif %}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}{% if order %}&order={{ order }}{% endif %}">Next</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>

</div>
<!-- Inline Add form placeholder (hidden by default) -->
<div id="inlineAddContainer" class="mt-3" style="display:none;"></div>

<!-- Add & Delete modals -->
<div class="modal fade" id="addBeneficiaryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Add Beneficiary</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><div id="addBeneficiaryContainer">Loading...</div></div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteBeneficiariesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" style="max-width:95%;">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Delete Beneficiaries</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><div id="deleteBeneficiariesContainer">Loading...</div></div>
      <div class="modal-footer"><button id="confirmDeleteBtn" class="btn btn-danger">Delete Selected</button><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button></div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Chart.js (already present above) -->
<script>
/* ---------- Constants & util functions ---------- */

const FRAGMENT_URL = "{% url 'load_app_content' app_name='bmmu' %}";
const LOAD_ADD_URL = "{% url 'load_app_content' app_name='bmmu_add' %}";
const ADD_POST_URL = "{% url 'bmmu_add_beneficiary' %}";
const DELETE_POST_URL = "{% url 'bmmu_delete_beneficiaries' %}";

// CSRF helper
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i=0;i<cookies.length;i++){
      const c = cookies[i].trim();
      if (c.substring(0, name.length+1) === (name + '=')) {
        cookieValue = decodeURIComponent(c.substring(name.length+1));
        break;
      }
    }
  }
  return cookieValue;
}
const CSRF_TOKEN = getCookie('csrftoken');

// parse groupable values JSON (injected earlier as __groupable_values_json)
let GROUPABLE_VALUES = {};
try {
  const el = document.getElementById('__groupable_values_json');
  if (el) GROUPABLE_VALUES = JSON.parse(el.textContent || el.innerText || '{}');
} catch(e){ GROUPABLE_VALUES = {}; }

/* ---------- Chart handling ---------- */
let _chart1 = null, _chart2 = null;
function initCharts() {
  try {
    // Clear previous instances if any
    if (_chart1 && _chart1.destroy) { try{ _chart1.destroy(); }catch(e){} }
    if (_chart2 && _chart2.destroy) { try{ _chart2.destroy(); }catch(e){} }

    const labels = {{ chart_labels|safe }};
    const data1 = {{ chart1|safe }};
    const data2 = {{ chart2|safe }};

    const c1 = document.getElementById('chart1');
    if (c1) {
      const ctx1 = c1.getContext('2d');
      _chart1 = new Chart(ctx1, {
        type: 'bar',
        data: { labels: labels, datasets: [{ label: 'Metric 1', data: data1 }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    const c2 = document.getElementById('chart2');
    if (c2) {
      const ctx2 = c2.getContext('2d');
      _chart2 = new Chart(ctx2, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'Metric 2', data: data2, fill:false }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
  } catch(e) {
    console.warn('Chart init error', e);
  }
}

/* ---------- Fragment reload helper ---------- */
function reloadFragmentWithParams(params) {
  const qs = params && params.toString() ? ('?' + params.toString()) : '';
  const url = FRAGMENT_URL + qs;
  fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(r => {
      if (!r.ok) throw new Error('Failed to load fragment');
      return r.text();
    })
    .then(html => {
      // place fragment into content area
      document.getElementById('content-area').innerHTML = html;
      // execute any inline scripts inside the fragment (wrapper's helper may also run)
      // call fragmentInit from that fragment if present
      if (typeof window.fragmentInit === 'function') {
        try { window.fragmentInit(); } catch(e) { console.warn('fragmentInit error', e); }
      }
    })
    .catch(err => {
      console.error('reloadFragmentWithParams', err);
    });
}

// read current page params
function currentParams() {
  return new URLSearchParams(window.location.search || '');
}

/* ---------- Toolbar handlers (search / toolbar Apply) ---------- */
function attachToolbarHandlers() {
  document.getElementById('globalSearchBtn')?.addEventListener('click', function(){
    const q = document.getElementById('globalSearch')?.value?.trim() || '';
    const params = new URLSearchParams();
    if (q) params.set('search', q);
    // carry sort/order from selects
    const sortBy = document.getElementById('toolbarSortBy')?.value;
    const order = document.getElementById('toolbarOrder')?.value;
    if (sortBy) params.set('sort_by', sortBy);
    if (order) params.set('order', order);
    // include checked column filters
    document.querySelectorAll('.main-col-filter-checkbox:checked').forEach(cb => {
      const f = cb.dataset.field;
      const prev = params.get('filter_' + f);
      params.set('filter_' + f, prev ? (prev + ',' + cb.value) : cb.value);
    });
    reloadFragmentWithParams(params);
  });

  document.getElementById('toolbarApplyBtn')?.addEventListener('click', function(){
    const params = new URLSearchParams();
    const q = document.getElementById('globalSearch')?.value?.trim() || '';
    if (q) params.set('search', q);
    const sortBy = document.getElementById('toolbarSortBy')?.value;
    const order = document.getElementById('toolbarOrder')?.value;
    if (sortBy) params.set('sort_by', sortBy);
    if (order) params.set('order', order);
    // include checked column filters
    document.querySelectorAll('.main-col-filter-checkbox:checked').forEach(cb => {
      const f = cb.dataset.field;
      const prev = params.get('filter_' + f);
      params.set('filter_' + f, prev ? (prev + ',' + cb.value) : cb.value);
    });
    // reset to page 1 when applying new sort/filters
    params.set('page', 1);
    reloadFragmentWithParams(params);
  });
}

/* ---------- Per-column filter handlers (Apply / Clear) ---------- */
function attachDropdownFilters() {
  // Apply button in dropdowns
  document.querySelectorAll('.main-dd-apply').forEach(btn => {
    btn.removeEventListener?.('click', btn._main_dd_apply_listener);
    const listener = function() {
      const field = this.dataset.field;
      const checked = Array.from(document.querySelectorAll(`.main-col-filter-checkbox[data-field="${field}"]:checked`)).map(x=>x.value);
      const params = currentParams();
      // remove existing filter_field
      params.delete('filter_' + field);
      if (checked.length) params.set('filter_' + field, checked.join(','));
      // keep current search & sort selections on toolbar
      const q = document.getElementById('globalSearch')?.value?.trim();
      if (q) params.set('search', q);
      const sortBy = document.getElementById('toolbarSortBy')?.value;
      const order = document.getElementById('toolbarOrder')?.value;
      if (sortBy) params.set('sort_by', sortBy);
      if (order) params.set('order', order);
      params.set('page', 1);
      reloadFragmentWithParams(params);
    };
    btn.addEventListener('click', listener);
    btn._main_dd_apply_listener = listener;
  });

  // Clear buttons in dropdowns
  document.querySelectorAll('.main-dd-clear').forEach(btn => {
    btn.removeEventListener?.('click', btn._main_dd_clear_listener);
    const listener = function(){
      const field = this.dataset.field;
      document.querySelectorAll(`.main-col-filter-checkbox[data-field="${field}"]`).forEach(cb => cb.checked = false);
      const params = currentParams();
      params.delete('filter_' + field);
      // keep search/sort
      const q = document.getElementById('globalSearch')?.value?.trim();
      if (q) params.set('search', q);
      const sortBy = document.getElementById('toolbarSortBy')?.value;
      const order = document.getElementById('toolbarOrder')?.value;
      if (sortBy) params.set('sort_by', sortBy);
      if (order) params.set('order', order);
      params.set('page', 1);
      reloadFragmentWithParams(params);
    };
    btn.addEventListener('click', listener);
    btn._main_dd_clear_listener = listener;
  });
}

/* ---------- Header sorting (click on th toggles sort) ---------- */
function wireHeaderSorting() {
  document.querySelectorAll('#beneficiariesTable thead th[data-field]').forEach(th => {
    const field = th.dataset.field;
    if (!field) return;
    th.style.cursor = 'pointer';
    // Prevent accidental toggle when clicking on dropdown toggle inside header
    th.addEventListener('click', function(e){
      if (e.target.closest('.dropdown') || e.target.closest('.dropdown-menu') || e.target.classList.contains('main-col-filter-checkbox')) return;
      const params = currentParams();
      const currentSort = params.get('sort_by') || "{{ sort_by }}";
      const currentOrder = params.get('order') || "{{ order }}";
      let newOrder = 'asc';
      if (currentSort === field && currentOrder === 'asc') newOrder = 'desc';
      params.set('sort_by', field);
      params.set('order', newOrder);
      params.set('page', 1);
      // preserve any checked filters on page (they are already in DOM; rebuild)
      document.querySelectorAll('.main-col-filter-checkbox:checked').forEach(cb => {
        const f = cb.dataset.field;
        const prev = params.get('filter_' + f);
        params.set('filter_' + f, prev ? prev + ',' + cb.value : cb.value);
      });
      // preserve global search textbox
      const q = document.getElementById('globalSearch')?.value?.trim();
      if (q) params.set('search', q);
      reloadFragmentWithParams(params);
    });
  });
}

/* ---------- Dropdown move-to-body for large menus (avoid clipping) ---------- */
function initDropdownMoveToBody() {
  document.querySelectorAll('.dropdown-toggle[data-field]').forEach(btn => {
    // ensure we don't attach duplicates
    if (btn._moved_listener) return;
    const listener = function(e){
      const toggle = this;
      const ddMenu = toggle.parentElement.querySelector('.dropdown-menu');
      if (!ddMenu) return;
      if (!ddMenu.__moved) {
        // calculate position relative to viewport and append to body
        const rect = toggle.getBoundingClientRect();
        ddMenu.style.position = 'absolute';
        ddMenu.style.top = (rect.bottom + window.scrollY) + 'px';
        ddMenu.style.left = (rect.left + window.scrollX) + 'px';
        ddMenu.style.minWidth = Math.max(220, rect.width) + 'px';
        ddMenu.classList.add('moved-to-body');
        document.body.appendChild(ddMenu);
        ddMenu.__moved = true;

        // clicking outside moves it back
        const outside = (ev) => {
          if (!ddMenu.contains(ev.target) && ev.target !== toggle) {
            if (ddMenu.__original_parent) ddMenu.__original_parent.appendChild(ddMenu);
            ddMenu.style.position = '';
            ddMenu.style.top = '';
            ddMenu.style.left = '';
            ddMenu.classList.remove('moved-to-body');
            ddMenu.__moved = false;
            document.removeEventListener('click', outside);
          }
        };
        setTimeout(()=> document.addEventListener('click', outside), 0);
      }
    };
    btn.addEventListener('click', listener);
    btn._moved_listener = listener;
  });
}

/* ---------- Row selection helpers ---------- */
function initRowSelectionHandlers() {
  const selectAll = document.getElementById('selectAllRows');
  if (selectAll) {
    selectAll.addEventListener('change', function(){
      const checked = !!this.checked;
      document.querySelectorAll('.row-select-checkbox').forEach(cb => cb.checked = checked);
    });
  }
  document.querySelectorAll('.row-select-checkbox').forEach(cb => {
    cb.addEventListener('change', function(){
      const all = Array.from(document.querySelectorAll('.row-select-checkbox'));
      const anyUnchecked = all.some(x => !x.checked);
      const sa = document.getElementById('selectAllRows');
      if (sa) sa.checked = !anyUnchecked && all.length > 0;
    });
  });
}
function getSelectedIds() {
  return Array.from(document.querySelectorAll('.row-select-checkbox:checked')).map(cb => cb.dataset.id);
}

/* ---------- Actions: Inline Add & Delete Selected ---------- */
function wireActionsForTable() {
  // import toggle
  document.getElementById('action_import')?.addEventListener('click', function(e){
    e.preventDefault();
    document.getElementById('import-placeholder')?.classList.remove('d-none');
  });

  // Inline Add: show heading and load the bmmu_add fragment into inlineAddContainer
  document.getElementById('action_add_inline')?.addEventListener('click', function(e){
    e.preventDefault();
    const container = document.getElementById('inlineAddContainer');
    // add heading above form as requested
    container.innerHTML = '<h5 class="mt-3 mb-2"><center>Individual Beneficiary Registration</centre></h5><div class="p-3" id="inlineAddInner">Loading form...</div>';
    container.style.display = 'block';
    fetch(LOAD_ADD_URL, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.text())
      .then(html => {
        const inner = document.getElementById('inlineAddInner');
        if (!inner) return;
        inner.innerHTML = html;
        // wire the returned form to submit via AJAX
        const form = inner.querySelector('form');
        if (form) {
          form.addEventListener('submit', function(ev){
            ev.preventDefault();
            const fd = new FormData(form);
            fetch(ADD_POST_URL, {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': CSRF_TOKEN },
              body: fd
            }).then(r => {
              // server may return HTML fragment or redirect; to keep simple reload main fragment
              const params = currentParams();
              reloadFragmentWithParams(params);
              // hide inline add area
              container.style.display = 'none';
              container.innerHTML = '';
            }).catch(err => {
              console.error('Add submit failed', err);
              alert('Add failed — see console.');
            });
          });
        }
      }).catch(err => {
        console.error('Load add form failed', err);
        container.innerHTML = '<div class="alert alert-danger">Failed to load add form.</div>';
      });
  });

  // Delete selected via AJAX
  document.getElementById('action_delete_selected')?.addEventListener('click', function(e){
    e.preventDefault();
    const ids = getSelectedIds();
    if (!ids.length) { alert('No rows selected'); return; }
    if (!confirm(`Delete ${ids.length} selected beneficiary(ies)?`)) return;
    const fd = new FormData();
    ids.forEach(i => fd.append('delete_ids[]', i));
    fetch(DELETE_POST_URL, {
      method:'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': CSRF_TOKEN },
      body: fd
    }).then(async r => {
      if (!r.ok) {
        const txt = await r.text().catch(()=>null);
        throw new Error(txt || 'Delete failed');
      }
      return r.json();
    }).then(data => {
      alert((data.deleted || 0) + ' beneficiary(ies) deleted.');
      const params = currentParams();
      reloadFragmentWithParams(params);
    }).catch(err => {
      console.error('Delete failed', err);
      alert('Delete failed — check console.');
    });
  });
}

/* ---------- fragmentInit: wire everything ---------- */
function fragmentInit() {
  try {
    // charts
    initCharts();
  } catch(e) { console.warn('charts init failed', e); }

  // toolbar handlers
  try { attachToolbarHandlers(); } catch(e) { console.warn('toolbar handlers error', e); }

  // dropdown filters
  try { attachDropdownFilters(); } catch(e) { console.warn('attachDropdownFilters', e); }

  // move-to-body dropdowns
  try { initDropdownMoveToBody(); } catch(e) { console.warn('initDropdownMoveToBody', e); }

  // header sorting
  try { wireHeaderSorting(); } catch(e) { console.warn('wireHeaderSorting', e); }

  // row selection handlers
  try { initRowSelectionHandlers(); } catch(e) { console.warn('row selection init', e); }

  // action wiring
  try { wireActionsForTable(); } catch(e) { console.warn('actions wiring', e); }
}

// run when this fragment is first rendered by server
try { fragmentInit(); } catch(e) { console.warn('fragmentInit first', e); }

</script>
