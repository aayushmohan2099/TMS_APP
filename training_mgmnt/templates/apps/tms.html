{% load static %}
<script>
  const SERVER_THEMES = {{ themes_json|default:"[]"|safe }};
  const SERVER_MODULES_MAP = {{ modules_map_json|default:"{}"|safe }};
  const SERVER_PARTNERS = {{ partners_json|default:"[]"|safe }};
  const SERVER_BENEFICIARIES = {{ beneficiaries_json|default:"[]"|safe }};
  const SERVER_TRAINERS = {{ trainers_json|default:"[]"|safe }};
  const SERVER_TRAINERS_MAP = {{ trainers_map_json|default:"{}"|safe }};
  const SERVER_BATCHES = {{ batches_json|default:"[]"|safe }};
</script>

<div class="container-fluid">
  <h3 class="mb-3 text-center">Training Program Management</h3>

  <!-- Top row -->
  <div class="row mb-3 align-items-center">
    <div class="col-md-4">
      <label class="form-label fw-bold">Training Theme</label>
      <select id="themeSelector" class="form-select">
        <option value="">-- Select Theme --</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label fw-bold">Training Module</label>
      <select id="moduleSelector" class="form-select" disabled>
        <option value="">-- Select Module --</option>
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label fw-bold">Module Days</label>
      <div id="moduleDays" class="form-control">—</div>
    </div>

    <div class="col-md-2 text-end">
      <label class="form-label fw-bold d-block">&nbsp;</label>
      <button id="refreshBatches" class="btn btn-outline-secondary">Refresh</button>
    </div>
  </div>

  <!-- Running batches -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Batches running right now</h5>
      <p class="text-muted small">Showing batches related to selected theme (server-side data).</p>

      <div class="table-responsive" style="max-height:360px; overflow:auto;">
        <table class="table table-striped table-sm" id="batchesTable" style="min-width:900px;">
          <thead class="table-dark">
            <tr>
              <th>Batch ID</th>
              <th>Theme</th>
              <th>Module</th>
              <th>Start</th>
              <th>End</th>
              <th>Days</th>
              <th>Trainers</th>
              <th>Participants</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Reporting -->
  <div class="card mb-4">
    <div class="card-body" style="min-height:120px;">
      <h5>Reporting Section (coming)</h5>
      <p class="text-muted">Detailed reports and charts will be added here later.</p>
    </div>
  </div>
</div>

<!-- Batch Creator Modal (centered) -->
<div id="batchCreatorModal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Batch Creator</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2 mb-2">
          <div class="col-md-4">
            <label class="form-label">Theme</label>
            <select id="panelTheme" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Module</label>
            <select id="panelModule" class="form-select"></select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Days</label>
            <div id="panelModuleDays" class="form-control">—</div>
          </div>
        </div>

        <hr />

        <div id="masterTrainersSection" class="mb-3" style="display:none;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Select Master Trainer(s)</h6>
            <div class="d-flex gap-2">
              <input id="trainerSearch" class="form-control form-control-sm" placeholder="Search trainers..." style="width:220px;">
              <select id="trainerSort" class="form-select form-select-sm" style="width:150px;">
                <option value="">Sort</option>
                <option value="name">Name</option>
                <option value="proficiency">Proficiency</option>
              </select>
            </div>
          </div>
          <div class="table-responsive" style="max-height:220px; overflow:auto;">
            <table class="table table-sm table-bordered" id="trainersTable">
              <thead class="table-dark">
                <tr>
                  <th style="width:40px;"><input type="checkbox" id="trainerSelectAll"></th>
                  <th>Name</th>
                  <th>Certificate</th>
                  <th>Skills</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <hr />

        <div class="mb-3">
          <h6>Select Beneficiaries</h6>
          <div class="d-flex gap-2 mb-2">
            <input id="benSearch" class="form-control form-control-sm" placeholder="Search beneficiaries..." style="width:260px;">
            <select id="benSort" class="form-select form-select-sm" style="width:150px;">
              <option value="">Sort</option>
              <option value="member_name">Name</option>
              <option value="village">Village</option>
            </select>
          </div>
          <div class="table-responsive" style="max-height:280px; overflow:auto;">
            <table class="table table-sm table-bordered" id="beneficiariesTableTms">
              <thead class="table-dark">
                <tr>
                  <th style="width:40px;"><input type="checkbox" id="benSelectAll"></th>
                  <th>Member Name</th>
                  <th>SHG</th>
                  <th>Village</th>
                  <th>District</th>
                  <th>Mobile</th>
                  <th>Category</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <hr />

        <div class="mb-3">
          <label class="form-label">Select Training Partner</label>
          <div class="d-flex gap-2 align-items-center">
            <input id="partnerSearch" class="form-control form-control-sm" placeholder="Search partners..." style="width:260px;">
            <select id="partnerSelector" class="form-select form-select-sm" style="width:360px;">
              <option value="">-- Select partner --</option>
            </select>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button id="createBatchBtn" class="btn btn-primary">Nominate Batch</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div id="quickActionsCard" style="position:fixed; right:24px; bottom:22px; z-index:4500; width:240px;">
  <div class="card shadow-sm">
    <div class="card-body">
      <h6 class="card-title">Quick Actions</h6>
      <div class="d-grid gap-2">
        <button id="openParticipantSelector" class="btn btn-sm btn-primary">Participant Selector for Training Batches</button>
        <a href="{% url 'create_training_plan' %}" class="btn btn-sm btn-outline-secondary">Training Plan Creator</a>
      </div>
    </div>
  </div>
</div>

<!-- JS: populate & wire UI -->
<script>
(function(){
  // parse server-supplied objects
  const THEMES = Array.isArray(SERVER_THEMES) && SERVER_THEMES.length ? SERVER_THEMES : [
    { id: 'agr', name: 'Agriculture & Livelihood' },
    { id: 'health', name: 'Health & Nutrition' },
    { id: 'women', name: 'Women Empowerment' }
  ];
  const MODULES_MAP = (SERVER_MODULES_MAP && Object.keys(SERVER_MODULES_MAP).length) ? SERVER_MODULES_MAP : {};
  const PARTNERS = Array.isArray(SERVER_PARTNERS) && SERVER_PARTNERS.length ? SERVER_PARTNERS : [];
  const BENEFICIARIES = Array.isArray(SERVER_BENEFICIARIES) && SERVER_BENEFICIARIES.length ? SERVER_BENEFICIARIES : [];
  const TRAINERS = Array.isArray(SERVER_TRAINERS) && SERVER_TRAINERS.length ? SERVER_TRAINERS : [];
  const TRAINERS_MAP = (SERVER_TRAINERS_MAP && Object.keys(SERVER_TRAINERS_MAP).length) ? SERVER_TRAINERS_MAP : {};
  const BATCHES = Array.isArray(SERVER_BATCHES) && SERVER_BATCHES.length ? SERVER_BATCHES : [];

  // DOM refs
  const themeSel = document.getElementById('themeSelector');
  const moduleSel = document.getElementById('moduleSelector');
  const moduleDaysEl = document.getElementById('moduleDays');

  const panelTheme = document.getElementById('panelTheme');
  const panelModule = document.getElementById('panelModule');
  const panelModuleDays = document.getElementById('panelModuleDays');

  const openParticipantBtn = document.getElementById('openParticipantSelector');
  const batchModalEl = document.getElementById('batchCreatorModal');

  const trainersTableBody = document.querySelector('#trainersTable tbody');
  const trainerSearch = document.getElementById('trainerSearch');
  const trainerSelectAll = document.getElementById('trainerSelectAll');

  const benTableBody = document.querySelector('#beneficiariesTableTms tbody');
  const benSearch = document.getElementById('benSearch');
  const benSelectAll = document.getElementById('benSelectAll');

  const partnerSelector = document.getElementById('partnerSelector');
  const partnerSearch = document.getElementById('partnerSearch');

  const batchesTableBody = document.querySelector('#batchesTable tbody');

  // helpers
  function clearSelect(sel){ while(sel && sel.options && sel.options.length>0) sel.remove(0); }
  function addOption(sel, val, label){ const o = document.createElement('option'); o.value = val; o.textContent = label; sel.appendChild(o); }

  function populateThemes(){
    clearSelect(themeSel); addOption(themeSel, '', '-- Select Theme --');
    clearSelect(panelTheme); addOption(panelTheme, '', '-- Select Theme --');
    THEMES.forEach(t=>{
      const id = t.id !== undefined ? t.id : (t.name || t);
      const name = t.name || t;
      addOption(themeSel, id, name);
      addOption(panelTheme, id, name);
    });
  }

  function populateModulesForTheme(themeId, targetModuleSel, daysEl){
    clearSelect(targetModuleSel);
    addOption(targetModuleSel, '', '-- Select Module --');
    const modules = MODULES_MAP[themeId] || [];
    modules.forEach(m=>{
      addOption(targetModuleSel, m.id || m.name, m.name);
    });
    targetModuleSel.disabled = (modules.length === 0);
    if(daysEl) daysEl.textContent = '—';
  }

  function updateModuleDaysFromSelect(sel, daysEl){
    const v = sel.value;
    if(!v){ daysEl.textContent = '—'; return; }
    const themeId = (sel === moduleSel) ? themeSel.value : panelTheme.value;
    const list = MODULES_MAP[themeId] || [];
    const found = list.find(x => String(x.id) === String(v) || String(x.name) === String(v));
    daysEl.textContent = found && (found.days !== undefined && found.days !== null) ? String(found.days) : '—';
  }

  function populatePartners(){
    clearSelect(partnerSelector);
    addOption(partnerSelector, '', '-- Select partner --');
    PARTNERS.forEach(p => addOption(partnerSelector, p.id, p.name));
  }

  function renderBeneficiaries(filterText){
    const txt = (filterText || '').toLowerCase();
    benTableBody.innerHTML = '';
    BENEFICIARIES.forEach(b => {
      if(txt){
        const hay = (b.member_name + ' ' + (b.village||'') + ' ' + (b.shg_name||'') + ' ' + (b.district||'')).toLowerCase();
        if(hay.indexOf(txt) === -1) return;
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="ben-row" data-id="${b.id}"></td>
        <td>${b.member_name || ''}</td>
        <td>${b.shg_name || ''}</td>
        <td>${b.village || ''}</td>
        <td>${b.district || ''}</td>
        <td>${b.mobile || ''}</td>
        <td>${b.category || ''}</td>
      `;
      benTableBody.appendChild(tr);
    });
    // reattach select-all checkbox logic
    if(benSelectAll) benSelectAll.checked = false;
  }

  function renderTrainersForPlan(planId, filterText){
    const txt = (filterText || '').toLowerCase();
    trainersTableBody.innerHTML = '';

    // Determine trainer ids preselected by TRAINERS_MAP[planId] if present
    const preIds = new Set(Array.isArray(TRAINERS_MAP[planId]) ? TRAINERS_MAP[planId] : []);

    TRAINERS.forEach(t => {
      // If we want to show only trainers matching the plan, use preIds or fallback matching
      let show = true;
      // if preIds non-empty, show only those
      if(preIds.size > 0) show = preIds.has(t.id);
      // else fallback: show if t.skills contains the training name/theme tokens
      if(!preIds.size && planId){
        // find training plan info inside MODULES_MAP (we used TrainingPlan.id as module id)
        let planName = '';
        for(const themeKey of Object.keys(MODULES_MAP || {})){
          const arr = MODULES_MAP[themeKey];
          for(const m of arr){
            if(String(m.id) === String(planId)){ planName = (m.name || ''); break; }
          }
          if(planName) break;
        }
        if(planName){
          const toks = (t.skills || '').toLowerCase();
          if(toks && toks.indexOf(planName.toLowerCase()) !== -1){
            show = true;
          } else {
            // also show if trainer's skills contain themeKey tokens
            const themeKeys = Object.keys(MODULES_MAP || {});
            for(const tk of themeKeys){
              if(String(tk) === String(planName) || (t.skills || '').toLowerCase().indexOf(tk.toLowerCase()) !== -1){
                show = true; break;
              }
            }
          }
        }
      }

      if(!show) return;

      if(txt){
        const hay = (t.full_name + ' ' + (t.certificate_number||'') + ' ' + (t.skills||'')).toLowerCase();
        if(hay.indexOf(txt) === -1) return;
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="trainer-row" data-id="${t.id}"></td>
        <td>${t.full_name || ''}</td>
        <td>${t.certificate_number || ''}</td>
        <td>${t.skills || ''}</td>
      `;
      trainersTableBody.appendChild(tr);
    });

    if(trainerSelectAll) trainerSelectAll.checked = false;
  }

  function renderBatches(themeId){
    batchesTableBody.innerHTML = '';
    // If themeId provided, filter batches to that theme
    const rows = BATCHES.filter(b => {
      if(!themeId) return true;
      return String(b.theme || '') === String(themeId) || String(b.theme || '').toLowerCase().indexOf(String(themeId).toLowerCase()) !== -1;
    });

    rows.forEach(b => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${b.code || b.id}</td>
        <td>${b.theme || ''}</td>
        <td>${b.module || ''}</td>
        <td>${b.start || ''}</td>
        <td>${b.end || ''}</td>
        <td>${b.days || ''}</td>
        <td>${b.trainers_count || 0}</td>
        <td>${b.participants_count || 0}</td>
        <td>${b.status || ''}</td>
      `;
      batchesTableBody.appendChild(tr);
    });
  }

  // select-all logic for trainers and beneficiaries
  function initSelectAlls(){
    if(trainerSelectAll){
      trainerSelectAll.addEventListener('change', function(){
        const checked = !!this.checked;
        document.querySelectorAll('.trainer-row').forEach(cb => cb.checked = checked);
      });
    }
    if(benSelectAll){
      benSelectAll.addEventListener('change', function(){
        const checked = !!this.checked;
        document.querySelectorAll('.ben-row').forEach(cb => cb.checked = checked);
      });
    }
  }

  function openBatchModal(){
    // sync panel theme/module with top selects
    panelTheme.value = themeSel.value || '';
    populateModulesForTheme(panelTheme.value, panelModule, panelModuleDays);
    // show/hide trainer section based on module presence
    document.getElementById('masterTrainersSection').style.display = panelModule.value ? '' : 'none';

    // populate trainers (for selected plan if any)
    renderTrainersForPlan(panelModule.value, '');
    renderBeneficiaries();
    populatePartners();

    const modal = new bootstrap.Modal(batchModalEl);
    modal.show();
  }

  function gatherAndSubmitBatch(){
    const payload = {};
    payload.theme = panelTheme.value || '';
    payload.moduleId = panelModule.value || '';
    // collect trainers selected
    payload.trainers = Array.from(document.querySelectorAll('.trainer-row:checked')).map(cb => cb.dataset.id);
    payload.beneficiaries = Array.from(document.querySelectorAll('.ben-row:checked')).map(cb => cb.dataset.id);
    payload.partner = partnerSelector.value || '';

    // Optionally collect start/end if you add inputs
    payload.start = null;
    payload.end = null;

    const url = "{% url 'tms_create_batch' %}";
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest' },
      body: JSON.stringify(payload)
    }).then(r => r.json())
    .then(data => {
      if(data && data.ok){
        bootstrap.Modal.getInstance(batchModalEl)?.hide();
        // refresh batches by reloading page fragment or updating BATCHES variable
        alert('Batch created: ' + (data.batch_id || 'id unknown'));
        // best-effort: append created batch to UI (server is authoritative; consider reload)
      } else {
        alert('Failed to create batch: ' + (data && data.message ? data.message : 'server error'));
      }
    }).catch(err => {
      console.error('create batch failed', err);
      alert('Create request failed — see console.');
    });
  }

  // wire events
  function wire(){
    themeSel.addEventListener('change', function(){ populateModulesForTheme(this.value, moduleSel, moduleDaysEl); renderBatches(this.value); });
    moduleSel.addEventListener('change', function(){ updateModuleDaysFromSelect(this, moduleDaysEl); });

    panelTheme.addEventListener('change', function(){ populateModulesForTheme(this.value, panelModule, panelModuleDays); });
    panelModule.addEventListener('change', function(){ updateModuleDaysFromSelect(panelModule, panelModuleDays); renderTrainersForPlan(panelModule.value, ''); document.getElementById('masterTrainersSection').style.display = panelModule.value ? '' : 'none'; });

    openParticipantBtn?.addEventListener('click', openBatchModal);
    document.getElementById('createBatchBtn')?.addEventListener('click', gatherAndSubmitBatch);

    trainerSearch?.addEventListener('input', function(){ renderTrainersForPlan(panelModule.value, this.value); });
    benSearch?.addEventListener('input', function(){ renderBeneficiaries(this.value); });

    partnerSearch?.addEventListener('input', function(){
      const q = (this.value||'').toLowerCase();
      Array.from(partnerSelector.options).forEach(opt => {
        if(!opt.value){ opt.hidden = false; return; }
        opt.hidden = q && opt.text.toLowerCase().indexOf(q) === -1;
      });
    });

    document.getElementById('refreshBatches')?.addEventListener('click', function(){ renderBatches(themeSel.value); });

    initSelectAlls();
  }

  // initial populate + render existing batches
  try {
    populateThemes();
    populateModulesForTheme('', moduleSel, moduleDaysEl);
    populatePartners();
    renderBeneficiaries();
    renderBatches('');
    wire();
  } catch(e){
    console.error('tms init error', e);
  }
})();
</script>
