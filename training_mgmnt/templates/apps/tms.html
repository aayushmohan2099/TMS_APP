{% load static %}
<script>
  const SERVER_THEMES = {{ themes_json|default:"[]"|safe }} ;
  const SERVER_MODULES_MAP = {{ modules_map_json|default:"{}"|safe }} ;
  const SERVER_PARTNERS = {{ partners_json|default:"[]"|safe }} ;
  const SERVER_BENEFICIARIES = {{ beneficiaries_json|default:"[]"|safe }} ;
  const SERVER_TRAINERS = {{ trainers_json|default:"[]"|safe }} ;
  const SERVER_TRAINERS_MAP = {{ trainers_map_json|default:"{}"|safe }} ;
  const SERVER_BATCHES = {{ batches_json|default:"[]"|safe }} ;
  const SERVER_BLOCKS = {{ blocks_json|default:"[]"|safe }} ;             // NEW
  const SERVER_USER_ROLE = {{ user_role|default:"\"\""|safe }} ;         // NEW
  const SERVER_USER_BLOCK_ID = {{ user_block_id|default:"null"|safe }} ; // NEW
  const SERVER_USER_DISTRICT_ID = {{ user_district_id|default:"null"|safe }} ; // NEW
  // === NEW: server-side list of beneficiary IDs currently in ONGOING batches ===
  // Add this variable in the view context as `ongoing_beneficiaries_json` (list of ids). If not provided it defaults to [].
  const SERVER_ONGOING_BENEFICIARY_IDS = {{ ongoing_beneficiaries_json|default:"[]"|safe }} ;
</script>

<div class="tms-panel p-3">
  <h5>Training Management â€” Quick Request (Table view)</h5>

  <div class="row g-2">
    <div class="col-md-3">
      <label class="form-label small">Theme</label>
      <select id="tms_theme" class="form-select form-select-sm"></select>
    </div>
    <div class="col-md-3">
      <label class="form-label small">Module</label>
      <select id="tms_module" class="form-select form-select-sm"></select>
    </div>
    <div class="col-md-3">
      <label class="form-label small">Participant Type</label>
      {% if user.is_authenticated %}
        {% with role_lower=user.role|default:""|lower %}
          {% if role_lower == "smmu" %}
            <select id="tms_type" class="form-select form-select-sm">
              <option value="">Select type</option>
              <option value="TRAINER|BRP">BRPs | Block Resource Persons</option>
              <option value="TRAINER|DRP">DRPs | District Resource Persons</option>
              <option value="TRAINER|SRP">SRPs | State Resource Persons</option>
            </select>
          {% elif role_lower == "bmmu" %}
            <select id="tms_type" class="form-select form-select-sm">
              <option value="">Select type</option>
              <option value="BENEFICIARY">Beneficiaries | SHG Members</option>
              <option value="TRAINER|BRP">BRPs | Block Resource Persons</option>
            </select>
          {% else %}
            <select id="tms_type" class="form-select form-select-sm">
              <option value="">Select type</option>
              <option value="BENEFICIARY">Beneficiaries | SHG Members</option>
              <option value="TRAINER|BRP">BRPs | Block Resource Persons</option>
              <option value="TRAINER|DRP">DRPs | District Resource Persons</option>
            </select>
          {% endif %}
        {% endwith %}
      {% else %}
            <select id="tms_type" class="form-select form-select-sm">
              <option value="">Select type</option>
              <option value="BENEFICIARY">Beneficiaries | SHG Members</option>
              <option value="TRAINER|BRP">BRPs | Block Resource Persons</option>
              <option value="TRAINER|DRP">DRPs | District Resource Persons</option>
              <option value="TRAINER|SRP">SRPs | State Resource Persons</option>
            </select>
      {% endif %}
    </div>

    <!-- NEW surgical control area for DMMU/BMMU filters (blocks / aspirational / designation) -->
    <div class="col-md-3" id="tms_extra_filters_wrapper" style="display:none;">
      <label class="form-label small">Filters</label>
      <div class="d-flex gap-1">
        <select id="tms_block_filter" class="form-select form-select-sm" style="min-width:140px;">
          <option value="">All blocks</option>
        </select>
        <select id="tms_asp_filter" class="form-select form-select-sm" style="width:120px;">
          <option value="">All</option>
          <option value="1">Aspirational</option>
          <option value="0">Non-aspirational</option>
        </select>
        <select id="tms_designation_filter" class="form-select form-select-sm" style="width:120px; display:none;">
          <option value="">Any designation</option>
          <option value="BRP">BRP</option>
          <option value="DRP">DRP</option>
          <option value="SRP">SRP</option>
        </select>
      </div>
    </div>

  </div>

  <div class="mt-3" id="tms_participants_wrapper" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <strong id="tms_participants_label">Participants</strong>
      <small class="text-muted" id="tms_partner_info"></small>
    </div>

    <!-- Search & Controls -->
    <div id="tms_part_controls" class="mb-2" style="display:none;">
      <div class="d-flex gap-2 align-items-center">
        <input id="tms_search" class="form-control form-control-sm" placeholder="Search participants..." style="width:280px;">
        <select id="tms_sort" class="form-select form-select-sm" style="width:150px;">
          <option value="">Sort</option>
          <option value="name">Name</option>
          <option value="village">Village</option>
        </select>
      </div>
    </div>

    <!-- Table container -->
    <div class="table-responsive" style="max-height:360px; overflow:auto; border:1px solid #eee; padding:6px; border-radius:6px;">
      <table class="table table-sm table-striped table-bordered mb-0" id="tms_participants_table" style="min-width:900px;">
        <thead class="table-dark" id="tms_table_head">
          <!-- dynamically populated -->
        </thead>
        <tbody id="tms_table_body">
          <!-- rows injected here -->
        </tbody>
      </table>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button id="tms_nominate" class="btn btn-primary">Nominate Batch</button>
    <div id="tms_feedback" class="ms-2 align-self-center"></div>
  </div>
</div>

<script>
(function(){
  // server blobs
  const THEMES = Array.isArray(SERVER_THEMES) ? SERVER_THEMES : [];
  const MODULES_MAP = (SERVER_MODULES_MAP && Object.keys(SERVER_MODULES_MAP||{}).length) ? SERVER_MODULES_MAP : {};
  let BENEFICIARIES = Array.isArray(SERVER_BENEFICIARIES) ? SERVER_BENEFICIARIES : [];
  let TRAINERS = Array.isArray(SERVER_TRAINERS) ? SERVER_TRAINERS : [];
  const BLOCKS = Array.isArray(SERVER_BLOCKS) ? SERVER_BLOCKS : [];
  const USER_ROLE = (SERVER_USER_ROLE||'').toLowerCase();
  const USER_BLOCK_ID = SERVER_USER_BLOCK_ID || null;
  const USER_DISTRICT_ID = SERVER_USER_DISTRICT_ID || null;
  const ONGOING_BEN_IDS = Array.isArray(SERVER_ONGOING_BENEFICIARY_IDS) ? SERVER_ONGOING_BENEFICIARY_IDS.map(x => String(x)) : [];

  // dom refs
  const themeSel = document.getElementById('tms_theme');
  const moduleSel = document.getElementById('tms_module');
  const typeSel = document.getElementById('tms_type');
  const wrapper = document.getElementById('tms_participants_wrapper');
  const tableHead = document.getElementById('tms_table_head');
  const tableBody = document.getElementById('tms_table_body');
  const controls = document.getElementById('tms_part_controls');
  const searchInput = document.getElementById('tms_search');
  const sortSel = document.getElementById('tms_sort');
  const nominateBtn = document.getElementById('tms_nominate');
  const feedback = document.getElementById('tms_feedback');
  const participantsLabel = document.getElementById('tms_participants_label');

  const extraFilters = document.getElementById('tms_extra_filters_wrapper');
  const blockFilter = document.getElementById('tms_block_filter');
  const aspFilter = document.getElementById('tms_asp_filter');
  const designationFilter = document.getElementById('tms_designation_filter');

  function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }

  function populateThemes(){
    clear(themeSel);
    const op = document.createElement('option'); op.value=''; op.text='Select theme'; themeSel.appendChild(op);
    THEMES.forEach(t => {
      const o = document.createElement('option');
      if(typeof t === 'string'){ o.value = t; o.text = t; }
      else { o.value = t.id || t.name; o.text = t.name || t.id; }
      themeSel.appendChild(o);
    });
  }

  function populateModulesForTheme(themeId){
    clear(moduleSel);
    const op = document.createElement('option'); op.value=''; op.text='Select module'; moduleSel.appendChild(op);
    const mods = MODULES_MAP[themeId] || [];
    mods.forEach(m => {
      const o = document.createElement('option'); o.value = m.id || m.name; o.text = m.name || m;
      moduleSel.appendChild(o);
    });
  }

  // populate blocks filter
  function populateBlockFilter(){
    clear(blockFilter);
    const op = document.createElement('option'); op.value=''; op.text='All blocks'; blockFilter.appendChild(op);
    BLOCKS.forEach(b => {
      // if user is BMMU show only that block
      if(USER_ROLE === 'bmmu' && USER_BLOCK_ID){
        if(String(b.id) !== String(USER_BLOCK_ID)) return;
      }
      const o = document.createElement('option'); o.value = b.id; o.text = b.name + (b.is_aspirational ? ' (Aspirational)' : '');
      blockFilter.appendChild(o);
    });
    // if user is BMMU, lock it to their block
    if(USER_ROLE === 'bmmu' && USER_BLOCK_ID){
      blockFilter.value = USER_BLOCK_ID;
      blockFilter.disabled = true;
    }
  }

  // Helper: update header checkbox state based on visible rows
  function updateHeadCheckbox() {
    const headAll = document.getElementById('head_select_all');
    if(!headAll) return;
    const visibleCheckboxes = Array.from(document.querySelectorAll('#tms_table_body .tms-row'))
      .filter(cb => cb.closest('tr').style.display !== 'none');
    if(visibleCheckboxes.length === 0) {
      headAll.checked = false;
      headAll.indeterminate = false;
      return;
    }
    const allChecked = visibleCheckboxes.every(cb => cb.checked);
    const someChecked = visibleCheckboxes.some(cb => cb.checked);
    headAll.checked = allChecked;
    headAll.indeterminate = (!allChecked && someChecked);
  }

  function showParticipantsTable(type, subtype){
    clear(tableHead); clear(tableBody);
    controls.style.display = '';
    wrapper.style.display = 'block';
    // SEARCH reset is fine for a fresh view
    searchInput.value = '';

    // show extra filters area for dmmu/smmu role or when trainers are selected
    if(USER_ROLE === 'dmmu' || USER_ROLE === 'smmu' || USER_ROLE === 'bmmu'){
      extraFilters.style.display = '';
    } else {
      extraFilters.style.display = 'none';
    }

    // show designation filter when trainers expected
    if(type === 'TRAINER'){
      designationFilter.style.display = '';
    } else {
      designationFilter.style.display = 'none';
    }

    // Build filtered arrays from server lists (we also do exclusion on server side; this is an extra safety)
    let benList = Array.isArray(BENEFICIARIES) ? BENEFICIARIES.slice() : [];
    let trainerList = Array.isArray(TRAINERS) ? TRAINERS.slice() : [];

    // === NEW: remove any beneficiaries that the server told us are currently in ONGOING batches ===
    if(Array.isArray(ONGOING_BEN_IDS) && ONGOING_BEN_IDS.length){
      benList = benList.filter(b => !ONGOING_BEN_IDS.includes(String(b.id)));
    }
    // === end new ===

    // Apply block / aspirational filter if set
    function applyBlockFilters() {
      const bf = blockFilter.value || '';
      const asp = aspFilter.value;
      if(bf){
        // beneficiaries have block_id field
        benList = benList.filter(b => String(b.block_id) === String(bf));
        trainerList = trainerList.filter(t => {
          // trainers don't carry block on server; keep trainers as-is (they are district/empanelled)
          return true;
        });
      }
      if(asp !== ''){
        const isasp = asp === '1';
        // find block ids which are aspirational
        const aspBlockIds = BLOCKS.filter(b => !!b.is_aspirational).map(b => String(b.id));
        if(isasp){
          benList = benList.filter(b => aspBlockIds.indexOf(String(b.block_id)) !== -1);
        } else {
          benList = benList.filter(b => aspBlockIds.indexOf(String(b.block_id)) === -1);
        }
      }
    }

    // initial apply block filters
    applyBlockFilters();

    if(type === 'BENEFICIARY'){
      participantsLabel.textContent = 'Select Beneficiaries';
      // head
      const headRow = document.createElement('tr');
      headRow.innerHTML = `
        <th style="width:40px;"><input type="checkbox" id="head_select_all"></th>
        <th>Member Name</th>
        <th>SHG</th>
        <th>Village</th>
        <th>Block</th>
        <th>District</th>
        <th>Mobile</th>
      `;
      tableHead.appendChild(headRow);

      // body rows
      benList.forEach(b => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="tms-row" data-id="${b.id}"></td>
          <td>${escapeHtml(b.member_name)}</td>
          <td>${escapeHtml(b.shg_name)}</td>
          <td>${escapeHtml(b.village)}</td>
          <td>${escapeHtml(b.block_name || '')}</td>
          <td>${escapeHtml(b.district || '')}</td>
          <td>${escapeHtml(b.mobile)}</td>
        `;
        tableBody.appendChild(tr);
      });
    } else if(type === 'TRAINER'){
      participantsLabel.textContent = 'Select Master Trainers';
      const headRow = document.createElement('tr');
      headRow.innerHTML = `
        <th style="width:40px;"><input type="checkbox" id="head_select_all"></th>
        <th>Name</th>
        <th>Designation</th>
        <th>Certificate</th>
        <th>Skills / Notes</th>
        <th>Phone</th>
      `;
      tableHead.appendChild(headRow);

      // apply designation filter client-side
      const des = (designationFilter.value||'').toUpperCase();
      let filteredTrainers = trainerList.slice();
      if(des){
        filteredTrainers = filteredTrainers.filter(t => ((t.designation||'') === des));
      }

      // also if user is dmmu and USER_DISTRICT_ID set, ensure trainers empanel district matches (server already did, but double-check)
      if(USER_ROLE === 'dmmu' && USER_DISTRICT_ID){
        filteredTrainers = filteredTrainers.filter(t => String(t.empanel_district || t.empanel_district || '') === String(USER_DISTRICT_ID) || String(t.empanel_district || '') === String(USER_DISTRICT_ID));
      }

      filteredTrainers.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="tms-row" data-id="${t.id}"></td>
          <td>${escapeHtml(t.full_name)}</td>
          <td>${escapeHtml((t.designation||'') )}</td>
          <td>${escapeHtml(t.certificate_number)}</td>
          <td>${escapeHtml(t.skills)}</td>
          <td>${escapeHtml(t.mobile || '')}</td>
        `;
        tableBody.appendChild(tr);
      });
    } else {
      // nothing
      wrapper.style.display = 'none';
      controls.style.display = 'none';
      return;
    }

    // ---- WIRE header select all to only toggle VISIBLE rows ----
    const headAll = document.getElementById('head_select_all');
    if(headAll){
      headAll.checked = false;
      headAll.indeterminate = false;

      headAll.addEventListener('change', function(){
        const ch = !!this.checked;
        document.querySelectorAll('#tms_table_body .tms-row').forEach(cb => {
          const tr = cb.closest('tr');
          if(!tr) return;
          if(tr.style.display === 'none') return; // do not toggle hidden rows
          cb.checked = ch;
        });
        updateHeadCheckbox();
      });
    }

    // Attach per-row change listeners to update header checkbox and preserve user selections
    Array.from(document.querySelectorAll('#tms_table_body .tms-row')).forEach(cb => {
      cb.addEventListener('change', function(){
        updateHeadCheckbox();
      });
    });

    // initial update of head checkbox (nothing selected)
    updateHeadCheckbox();
  }

  function escapeHtml(s){
    if(s === null || s === undefined) return '';
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  function filterTable(text){
    text = (text||'').toLowerCase().trim();
    Array.from(tableBody.rows).forEach(r => {
      const hay = r.textContent.toLowerCase();
      r.style.display = (!text || hay.indexOf(text) !== -1) ? '' : 'none';
    });
    updateHeadCheckbox();
  }

  function collectCheckedIds(){
    return Array.from(document.querySelectorAll('#tms_table_body .tms-row:checked')).map(cb => parseInt(cb.dataset.id));
  }

  // wire events
  themeSel.addEventListener('change', function(){ populateModulesForTheme(this.value); });
  moduleSel.addEventListener('change', function(){ /* can show partner info if available */ });

  // block filter interactions
  blockFilter.addEventListener('change', function(){
    // re-show participants table according to currently selected type
    const currentType = (typeSel.value || '').split('|')[0];
    const subtype = (typeSel.value || '').split('|')[1] || '';
    // rebuild filtered server arrays on the fly: to keep surgical changes, we'll just call showParticipantsTable
    showParticipantsTable(currentType, subtype);
  });
  aspFilter.addEventListener('change', function(){
    const currentType = (typeSel.value || '').split('|')[0];
    showParticipantsTable(currentType);
  });
  designationFilter.addEventListener('change', function(){
    const currentType = (typeSel.value || '').split('|')[0];
    showParticipantsTable(currentType);
  });

  typeSel.addEventListener('change', function(){
    const v = (this.value||'');
    if(!v){ wrapper.style.display='none'; controls.style.display='none'; return; }
    const parts = v.split('|');
    const t = parts[0] ? parts[0].toUpperCase() : '';
    const subtype = parts[1] || '';
    // ensure block filter populated when needed
    populateBlockFilter();
    showParticipantsTable(t, subtype);
    // show controls area
    controls.style.display = '';
  });

  // search input - do not reset selections, only hide/show rows
  searchInput.addEventListener('input', function(){ filterTable(this.value); });

  nominateBtn.addEventListener('click', function(){
    feedback.textContent = '';
    const moduleId = moduleSel.value;
    const trainingType = (typeSel.value || '').split('|')[0] || '';
    if(!moduleId){ feedback.innerHTML = '<span class="text-danger small">Please select module.</span>'; return; }
    if(!trainingType){ feedback.innerHTML = '<span class="text-danger small">Please select training type.</span>'; return; }
    const checked = collectCheckedIds();
    if(checked.length === 0){ feedback.innerHTML = '<span class="text-danger small">Please select at least one participant.</span>'; return; }

    nominateBtn.disabled = true; nominateBtn.innerText = 'Nominate...';

    fetch("{% url 'create_training_request' %}", {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || ''},
      body: JSON.stringify({
        training_plan_id: parseInt(moduleId),
        training_type: trainingType,
        participant_ids: checked,
        level: 'BLOCK'
      })
    }).then(r => r.json()).then(data => {
      if(data && data.ok){
        feedback.innerHTML = '<span class="text-success small">Request created (ID: '+data.request_id+'). Partner assigned: '+(data.partner_assigned||'N/A')+'</span>';
        // reset UI
        moduleSel.value=''; typeSel.value=''; wrapper.style.display='none'; clear(tableBody); clear(tableHead); controls.style.display='none';
      } else {
        feedback.innerHTML = '<span class="text-danger small">'+(data.message || 'Server error')+'</span>';
      }
    }).catch(err => {
      console.error(err);
      feedback.innerHTML = '<span class="text-danger small">Network or server error.</span>';
    }).finally(()=>{ nominateBtn.disabled=false; nominateBtn.innerText='Nominate Batch'; });
  });

  // init
  try{
    populateThemes();
    populateModulesForTheme('');
    populateBlockFilter();
  }catch(e){ console.error('tms table init error', e); }
})();
</script>
