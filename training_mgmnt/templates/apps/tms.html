{% load static %}
<script>
  const SERVER_THEMES = {{ themes_json|default:"[]"|safe }} ;
  const SERVER_MODULES_MAP = {{ modules_map_json|default:"{}"|safe }} ;
  const SERVER_PARTNERS = {{ partners_json|default:"[]"|safe }} ;
  const SERVER_BENEFICIARIES = {{ beneficiaries_json|default:"[]"|safe }} ;
  const SERVER_TRAINERS = {{ trainers_json|default:"[]"|safe }} ;
  const SERVER_TRAINERS_MAP = {{ trainers_map_json|default:"{}"|safe }} ;
  const SERVER_BATCHES = {{ batches_json|default:"[]"|safe }} ;
</script>

<div class="tms-panel p-3">
  <h5>Training Management â€” Quick Request (Table view)</h5>

  <div class="row g-2">
    <div class="col-md-4">
      <label class="form-label small">Theme</label>
      <select id="tms_theme" class="form-select form-select-sm"></select>
    </div>
    <div class="col-md-4">
      <label class="form-label small">Module</label>
      <select id="tms_module" class="form-select form-select-sm"></select>
    </div>
    <div class="col-md-4">
      <label class="form-label small">Participant Type</label>
      <select id="tms_type" class="form-select form-select-sm">
        <option value="">Select type</option>
        <option value="BENEFICIARY">SHG Members</option>
        <option value="TRAINER">BRPs</option>
      </select>
    </div>
  </div>

  <div class="mt-3" id="tms_participants_wrapper" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <strong id="tms_participants_label">Participants</strong>
      <small class="text-muted" id="tms_partner_info"></small>
    </div>

    <!-- Search & Controls -->
    <div id="tms_part_controls" class="mb-2" style="display:none;">
      <div class="d-flex gap-2 align-items-center">
        <input id="tms_search" class="form-control form-control-sm" placeholder="Search participants..." style="width:280px;">
        <select id="tms_sort" class="form-select form-select-sm" style="width:150px;">
          <option value="">Sort</option>
          <option value="name">Name</option>
          <option value="village">Village</option>
        </select>

        <!-- SURGICAL CHANGE: removed duplicate "Select All" control here.
             The header checkbox in the table will be the single select-all control. -->
      </div>
    </div>

    <!-- Table container -->
    <div class="table-responsive" style="max-height:360px; overflow:auto; border:1px solid #eee; padding:6px; border-radius:6px;">
      <table class="table table-sm table-striped table-bordered mb-0" id="tms_participants_table" style="min-width:900px;">
        <thead class="table-dark" id="tms_table_head">
          <!-- dynamically populated -->
        </thead>
        <tbody id="tms_table_body">
          <!-- rows injected here -->
        </tbody>
      </table>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button id="tms_nominate" class="btn btn-primary">Nominate Batch</button>
    <div id="tms_feedback" class="ms-2 align-self-center"></div>
  </div>
</div>

<script>
(function(){
  // server blobs
  const THEMES = Array.isArray(SERVER_THEMES) ? SERVER_THEMES : [];
  const MODULES_MAP = (SERVER_MODULES_MAP && Object.keys(SERVER_MODULES_MAP||{}).length) ? SERVER_MODULES_MAP : {};
  const BENEFICIARIES = Array.isArray(SERVER_BENEFICIARIES) ? SERVER_BENEFICIARIES : [];
  const TRAINERS = Array.isArray(SERVER_TRAINERS) ? SERVER_TRAINERS : [];

  // dom refs
  const themeSel = document.getElementById('tms_theme');
  const moduleSel = document.getElementById('tms_module');
  const typeSel = document.getElementById('tms_type');
  const wrapper = document.getElementById('tms_participants_wrapper');
  const tableHead = document.getElementById('tms_table_head');
  const tableBody = document.getElementById('tms_table_body');
  const controls = document.getElementById('tms_part_controls');
  const searchInput = document.getElementById('tms_search');
  const sortSel = document.getElementById('tms_sort');
  // NOTE: selectAllCb removed (duplicate control) - header checkbox will be used instead
  const nominateBtn = document.getElementById('tms_nominate');
  const feedback = document.getElementById('tms_feedback');
  const participantsLabel = document.getElementById('tms_participants_label');

  function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }

  function populateThemes(){
    clear(themeSel);
    const op = document.createElement('option'); op.value=''; op.text='Select theme'; themeSel.appendChild(op);
    THEMES.forEach(t => {
      const o = document.createElement('option');
      if(typeof t === 'string'){ o.value = t; o.text = t; }
      else { o.value = t.id || t.name; o.text = t.name || t.id; }
      themeSel.appendChild(o);
    });
  }

  function populateModulesForTheme(themeId){
    clear(moduleSel);
    const op = document.createElement('option'); op.value=''; op.text='Select module'; moduleSel.appendChild(op);
    const mods = MODULES_MAP[themeId] || [];
    mods.forEach(m => {
      const o = document.createElement('option'); o.value = m.id || m.name; o.text = m.name || m;
      moduleSel.appendChild(o);
    });
  }

  // Helper: update header checkbox state based on visible rows
  function updateHeadCheckbox() {
    const headAll = document.getElementById('head_select_all');
    if(!headAll) return;
    const visibleCheckboxes = Array.from(document.querySelectorAll('#tms_table_body .tms-row'))
      .filter(cb => cb.closest('tr').style.display !== 'none');
    if(visibleCheckboxes.length === 0) {
      headAll.checked = false;
      headAll.indeterminate = false;
      return;
    }
    const allChecked = visibleCheckboxes.every(cb => cb.checked);
    const someChecked = visibleCheckboxes.some(cb => cb.checked);
    headAll.checked = allChecked;
    headAll.indeterminate = (!allChecked && someChecked);
  }

  function showParticipantsTable(type){
    clear(tableHead); clear(tableBody);
    controls.style.display = '';
    wrapper.style.display = 'block';
    // SEARCH reset is fine for a fresh view
    searchInput.value = '';

    if(type === 'BENEFICIARY'){
      participantsLabel.textContent = 'Select Beneficiaries';
      // head
      const headRow = document.createElement('tr');
      headRow.innerHTML = `
        <!-- header checkbox is the single 'select all' control -->
        <th style="width:40px;"><input type="checkbox" id="head_select_all"></th>
        <th>Member Name</th>
        <th>SHG</th>
        <th>Village</th>
        <th>District</th>
        <th>Mobile</th>
        <th>Category</th>
      `;
      tableHead.appendChild(headRow);

      // body rows
      BENEFICIARIES.forEach(b => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="tms-row" data-id="${b.id}"></td>
          <td>${escapeHtml(b.member_name)}</td>
          <td>${escapeHtml(b.shg_name)}</td>
          <td>${escapeHtml(b.village)}</td>
          <td>${escapeHtml(b.district)}</td>
          <td>${escapeHtml(b.mobile)}</td>
          <td>${escapeHtml(b.category)}</td>
        `;
        tableBody.appendChild(tr);
      });
    } else if(type === 'TRAINER'){
      participantsLabel.textContent = 'Select Master Trainers';
      const headRow = document.createElement('tr');
      headRow.innerHTML = `
        <th style="width:40px;"><input type="checkbox" id="head_select_all"></th>
        <th>Name</th>
        <th>Certificate</th>
        <th>Skills / Notes</th>
        <th>Phone</th>
      `;
      tableHead.appendChild(headRow);

      TRAINERS.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="tms-row" data-id="${t.id}"></td>
          <td>${escapeHtml(t.full_name)}</td>
          <td>${escapeHtml(t.certificate_number)}</td>
          <td>${escapeHtml(t.skills)}</td>
          <td>${escapeHtml(t.mobile)}</td>
        `;
        tableBody.appendChild(tr);
      });
    } else {
      // nothing
      wrapper.style.display = 'none';
      controls.style.display = 'none';
      return;
    }

    // ---- WIRE header select all to only toggle VISIBLE rows (surgical change) ----
    const headAll = document.getElementById('head_select_all');
    if(headAll){
      // reset state
      headAll.checked = false;
      headAll.indeterminate = false;

      headAll.addEventListener('change', function(){
        const ch = !!this.checked;
        // Only change checkboxes for visible rows
        document.querySelectorAll('#tms_table_body .tms-row').forEach(cb => {
          const tr = cb.closest('tr');
          if(!tr) return;
          if(tr.style.display === 'none') return; // do not toggle hidden rows
          cb.checked = ch;
        });
        // after toggling, ensure head checkbox is correct (no indeterminate)
        updateHeadCheckbox();
      });
    }

    // Attach per-row change listeners to update header checkbox and preserve user selections
    Array.from(document.querySelectorAll('#tms_table_body .tms-row')).forEach(cb => {
      cb.addEventListener('change', function(){
        // when a row toggles, just update head checkbox state (reflect visible rows)
        updateHeadCheckbox();
      });
    });

    // initial update of head checkbox (nothing selected)
    updateHeadCheckbox();
  }

  function escapeHtml(s){
    if(s === null || s === undefined) return '';
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  function filterTable(text){
    text = (text||'').toLowerCase().trim();
    Array.from(tableBody.rows).forEach(r => {
      const hay = r.textContent.toLowerCase();
      r.style.display = (!text || hay.indexOf(text) !== -1) ? '' : 'none';
    });
    // After filtering, update header checkbox to reflect visible rows only.
    updateHeadCheckbox();
  }

  function collectCheckedIds(){
    // collect ALL checked rows (visible or hidden). This keeps behavior intuitive:
    // if user explicitly checked some hidden rows via some other UI, they'd be included.
    // In the typical flow users only check visible rows, so this will return exactly those they selected.
    return Array.from(document.querySelectorAll('#tms_table_body .tms-row:checked')).map(cb => parseInt(cb.dataset.id));
  }

  // wire events
  themeSel.addEventListener('change', function(){ populateModulesForTheme(this.value); });
  moduleSel.addEventListener('change', function(){ /* can show partner info if available */ });

  typeSel.addEventListener('change', function(){
    const t = (this.value||'').toUpperCase();
    if(!t){ wrapper.style.display='none'; controls.style.display='none'; return; }
    showParticipantsTable(t);
  });

  // search input - do not reset selections, only hide/show rows
  searchInput.addEventListener('input', function(){ filterTable(this.value); });

  nominateBtn.addEventListener('click', function(){
    feedback.textContent = '';
    const moduleId = moduleSel.value;
    const trainingType = (typeSel.value || '').toUpperCase();
    if(!moduleId){ feedback.innerHTML = '<span class="text-danger small">Please select module.</span>'; return; }
    if(!trainingType){ feedback.innerHTML = '<span class="text-danger small">Please select training type.</span>'; return; }
    const checked = collectCheckedIds();
    if(checked.length === 0){ feedback.innerHTML = '<span class="text-danger small">Please select at least one participant.</span>'; return; }

    nominateBtn.disabled = true; nominateBtn.innerText = 'Nominate...';

    fetch("{% url 'create_training_request' %}", {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || ''},
      body: JSON.stringify({
        training_plan_id: parseInt(moduleId),
        training_type: trainingType,
        participant_ids: checked,
        level: 'BLOCK'
      })
    }).then(r => r.json()).then(data => {
      if(data && data.ok){
        feedback.innerHTML = '<span class="text-success small">Request created (ID: '+data.request_id+'). Partner assigned: '+(data.partner_assigned||'N/A')+'</span>';
        // reset UI
        moduleSel.value=''; typeSel.value=''; wrapper.style.display='none'; clear(tableBody); clear(tableHead); controls.style.display='none';
      } else {
        feedback.innerHTML = '<span class="text-danger small">'+(data.message || 'Server error')+'</span>';
      }
    }).catch(err => {
      console.error(err);
      feedback.innerHTML = '<span class="text-danger small">Network or server error.</span>';
    }).finally(()=>{ nominateBtn.disabled=false; nominateBtn.innerText='Nominate Batch'; });
  });

  // init
  try{
    populateThemes();
    populateModulesForTheme('');
  }catch(e){ console.error('tms table init error', e); }
})();
</script>
