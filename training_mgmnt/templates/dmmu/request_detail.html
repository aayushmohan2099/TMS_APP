{# fragment: dmmu/request_detail.html #}
{% load custom_tags %}
<h4>Training Request for {{ training_request.training_plan.training_name }} Module</h4>

<div class="card mb-3">
  <div class="card-body">
    <div class="container-fluid p-0 mb-3">
      <div class="row gx-3 gy-2 align-items-start">
        <div class="col-md-6">
          <div><strong>Theme:</strong> {{ training_request.training_plan.theme|default:"—" }}</div>
        </div>
        <div class="col-md-6 text-md-end">
          <div><strong>Requested by:</strong>
            {% if training_request.created_by %}
              {{ training_request.created_by.get_full_name|default:training_request.created_by.username }}
            {% else %}
              &mdash;
            {% endif %}
          </div>
        </div>

        <div class="col-md-6">
          <div><strong>Training Cadre:</strong> {{ training_request.level|default:"—" }}</div>
        </div>
        <div class="col-md-6 text-md-end">
          <div><strong>Requested beneficiaries:</strong> {{ training_request.beneficiaries.count|default:"0" }}</div>
        </div>
      </div>
    </div>

    <hr>
    <h6>All Batches created by {{training_request.partner.name|default:"(not set)"}} Partner,</h6>

    {% if batches %}
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          <div class="list-group">
            {% for item in batches %}
              {% with b=item.batch %}
                <div class="list-group-item">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <div class="fw-bold">Batch: {{ b.code|default:b.id }} — Centre: {{ item.centre.venue_name|default:"(not set)" }}</div>
                      <div class="small text-muted">Start: {{ b.start_date|date:"Y-m-d"|default:"—" }} &nbsp; End: {{ b.end_date|date:"Y-m-d"|default:"—" }}</div>
                      <div class="small mt-1">Participants: {{ item.beneficiaries|length }}</div>
                    </div>

                    <div class="text-end" style="min-width:200px;">
                      <div class="mb-2 small text-muted">Click to view batch details (centre, participants, then trainer assignment)</div>

                      {# PRIMARY CHANGE: button label changed to "View batch details" and it toggles the unified collapse block #}
                      <a class="btn btn-sm btn-outline-secondary" href="#" data-bs-toggle="collapse" data-bs-target="#batchDetail{{ b.id }}" aria-expanded="false" aria-controls="batchDetail{{ b.id }}">View batch details</a>
                    </div>
                  </div>

                  {# Unified collapse block: batch summary -> centre details -> participants -> master trainer assignment #}
                  <div class="collapse mt-2" id="batchDetail{{ b.id }}">
                    <div class="card card-body p-2">
                      {# --- Batch summary (first) --- #}
                      <h6 class="mb-2">Batch summary</h6>
                      <div class="row g-2 small mb-2">
                        <div class="col-md-3"><strong>Batch code</strong><div>{{ b.code|default:"—" }}</div></div>
                        <div class="col-md-3"><strong>Start</strong><div>{{ b.start_date|date:"Y-m-d"|default:"—" }}</div></div>
                        <div class="col-md-3"><strong>End</strong><div>{{ b.end_date|date:"Y-m-d"|default:"—" }}</div></div>
                        <div class="col-md-3"><strong>Participants</strong><div>{{ item.beneficiaries|length }}</div></div>
                      </div>

                      <hr class="my-2">

                      {# --- Centre details (second) --- #}
                      <h6 class="mb-2">Centre: {{ item.centre_info.venue_name|default:item.centre.venue_name|default:"(not set)" }}</h6>
                      <p class="small text-muted mb-1">{{ item.centre_info.venue_address|default:item.centre.venue_address|default:"-" }}</p>

                      <div class="row g-2 small">
                        <div class="col-md-4"><strong>Serial#</strong><div>{{ item.centre_info.serial_number|default:"—" }}</div></div>
                        <div class="col-md-4"><strong>District</strong>
                          <div>
                            {% if item.centre_info.district %}
                              {% if item.centre_info.district.district_name_en %}{{ item.centre_info.district.district_name_en }}{% else %}{{ item.centre_info.district }}{% endif %}
                            {% else %}
                              &mdash;
                            {% endif %}
                          </div>
                        </div>
                        <div class="col-md-4"><strong>Coordinator</strong><div>{{ item.centre_info.coord_name|default:"—" }} / {{ item.centre_info.coord_mobile|default:"—" }}</div></div>

                        <div class="col-md-4"><strong>Halls</strong><div>{{ item.centre_info.training_hall_count|default:"—" }}</div></div>
                        <div class="col-md-4"><strong>Hall Capacity</strong><div>{{ item.centre_info.training_hall_capacity|default:"—" }}</div></div>
                        <div class="col-md-4"><strong>Total Toilets</strong><div>{{ item.centre_info.toilets_bathrooms|default:"—" }}</div></div>

                        <div class="col-md-4"><strong>Power/Water</strong><div>{{ item.centre_info.power_water_facility|default:"—" }}</div></div>
                        <div class="col-md-4"><strong>Security</strong><div>{{ item.centre_info.security_arrangements|default:"—" }}</div></div>
                        <div class="col-md-4"><strong>Medical kit</strong><div>{% if item.centre_info.medical_kit %}Yes{% else %}No{% endif %}</div></div>

                        <div class="col-md-4"><strong>Centre Type</strong><div>{{ item.centre_info.centre_type|default:"—" }}</div></div>
                        <div class="col-md-4"><strong>Open space</strong><div>{% if item.centre_info.open_space %}Yes{% else %}No{% endif %}</div></div>
                        <div class="col-md-4"><strong>Field Visit</strong><div>{% if item.centre_info.field_visit_facility %}Yes{% else %}No{% endif %}</div></div>

                        <div class="col-md-4"><strong>Transport</strong><div>{% if item.centre_info.transport_facility %}Yes{% else %}No{% endif %}</div></div>
                        <div class="col-md-4"><strong>Dining</strong><div>{% if item.centre_info.dining_facility %}Yes{% else %}No{% endif %}</div></div>
                        <div class="col-md-4"><strong>Created</strong><div>{{ item.centre_info.created_at|date:"Y-m-d H:i"|default:"—" }}</div></div>
                      </div>

                      <div class="mt-2">
                        <strong>Other details</strong>
                        <div class="small text-muted">{{ item.centre_info.other_details|default:"—" }}</div>
                      </div>

                      <hr class="my-2">

                      <div class="mb-2">
                        <strong>Rooms</strong>
                        {% if item.rooms %}
                          <ul class="list-unstyled small mb-0">
                            {% for r in item.rooms %}
                              <li>{{ r.room_name|default:"Room" }} — capacity: {{ r.room_capacity|default:"—" }}</li>
                            {% endfor %}
                          </ul>
                        {% else %}
                          <div class="text-muted small">No rooms recorded.</div>
                        {% endif %}
                      </div>

                      <div class="mb-2">
                        <strong>Photographs of Centre Rooms</strong>
                        {% if item.submissions %}
                          <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0">
                              <thead class="table-light"><tr><th>Category</th><th>File</th></tr></thead>
                              <tbody>
                                {% for s in item.submissions %}
                                  <tr>
                                    <td>{{ s.get_category_display|default:s.category }}</td>
                                    <td>
                                      {% if s.file %}
                                        <a href="{{ s.file.url }}" target="_blank" class="btn btn-sm btn-outline-secondary">Open</a>
                                      {% else %}
                                        &mdash;
                                      {% endif %}
                                    </td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        {% else %}
                          <div class="text-muted small">No submissions.</div>
                        {% endif %}
                      </div>

                      <hr class="my-2">

                      {# --- Participants for this batch (third) --- #}
                      <h6 class="mb-2">Participants in this batch</h6>
                      {% if item.beneficiaries %}
                        <div class="table-responsive mb-2">
                          <table class="table table-sm table-bordered">
                            <thead class="table-light">
                              <tr><th>SHG</th><th>Name</th><th>Age</th><th>Mobile</th><th>Location</th></tr>
                            </thead>
                            <tbody>
                              {% for p in item.beneficiaries %}
                                {# compute display fields are set in view for request-level participants; if your beneficiary objects differ adjust as required #}
                                <tr>
                                  <td>{{ p.shg_name|default:"—" }}</td>
                                  <td>{{ p.member_name|default:"—" }}</td>
                                  <td>{% if p.date_of_birth %}{% with d=p.date_of_birth %}{{ d.year|default:"" }}{% endwith %}{% else %}&mdash;{% endif %}</td>
                                  <td>{{ p.mobile_no|default:"—" }}</td>
                                  <td class="small text-muted">{% if p.village %}{{ p.block }}{{" , "}}{{ p.gram_panchayat }}{{" , "}}{{ p.village }}{% else %}{{ p.display_location|default:"-" }}{% endif %}</td>
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      {% else %}
                        <div class="text-muted small mb-2">No participants assigned to this batch yet.</div>
                      {% endif %}

                      <hr class="my-2">

                      {# --- Master Trainer assignment (fourth) --- #}
                      <div class="mb-2">
                        <label class="form-label small">Select Master Trainer(s) for this batch</label>

                        <div class="table-responsive" style="max-height:240px; overflow:auto;">
                          <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                              <tr>
                                <th style="width:28px;"></th>
                                <th>Name</th>
                                <th style="width:120px;">Certificate</th>
                                <th style="width:80px;">Success%</th>
                                <th style="width:140px;">Contact</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for mt in master_trainers %}
                                <tr>
                                  <td class="align-middle text-center">
                                    <input type="checkbox"
                                           name="trainer_for_batch_{{ b.id }}"
                                           value="{{ mt.id }}"
                                           id="tb_{{ b.id }}_{{ mt.id }}"
                                           {% if item.assigned_trainer_ids and mt.id in item.assigned_trainer_ids %}checked{% endif %}>
                                  </td>
                                  <td class="align-middle">
                                    {{ mt.full_name }}
                                  </td>
                                  <td class="align-middle small">
                                    {% if trainer_cert_map|get_item:mt.id %}
                                      {{ trainer_cert_map|get_item:mt.id }}
                                    {% else %}
                                      &mdash;
                                    {% endif %}
                                  </td>
                                  <td class="align-middle">
                                    {% if mt.success_rate is not None %}{{ mt.success_rate }}%{% else %}&mdash;{% endif %}
                                  </td>
                                  <td class="align-middle small">
                                    {% if mt.mobile_no %}{{ mt.mobile_no }}
                                    {% elif mt.phone %}{{ mt.phone }}
                                    {% elif mt.email %}{{ mt.email }}
                                    {% else %}&mdash;{% endif %}
                                  </td>
                                </tr>
                              {% empty %}
                                <tr><td colspan="5" class="text-muted small">No master trainers found for this level.</td></tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>

                        <div class="small text-muted mt-1">Select one or more trainers; click "Save Trainer assignments" or "Approve & Start Training (All)".</div>
                      </div>

                    </div> {# end card-body of collapse #}
                  </div> {# end collapse #}

                </div>
              {% endwith %}
            {% endfor %}
          </div>
        </div>

        {# --- REMOVED: global TrainingRequest Participants table as requested --- #}
        {# (previous global participants listing intentionally removed so participants appear per-batch) #}

        <div class="mt-3 d-flex gap-2">
          <button type="submit" name="action" value="assign_trainers" class="btn btn-primary">Save Trainer assignments</button>
          <button type="submit" name="action" value="approve_all" class="btn btn-success">Approve & Start Training (All)</button>
          <button type="submit" name="action" value="revert" class="btn btn-danger">Revert to {{training_request.partner.name|default:"(not set)"}}</button>
          <a href="{% url 'dmmu_training_requests' %}" class="btn btn-outline-secondary">Back</a>
        </div>
      </form>

    {% else %}
      <div class="text-muted">No batches created for this request yet.</div>
    {% endif %}

  </div>
</div>
